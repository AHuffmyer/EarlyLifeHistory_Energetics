---
title: "WGCNA - GoSeq Functional Annotation"
author: "Ariana S Huffmyer"
date: "5/2/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Functional enrichment of WGCNA modules produced in `WGCNA_Mcap.Rmd` script for the *Montipora capitata* 2020 developmental time series.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# The following setting is important, do not omit.
options(stringsAsFactors = FALSE) #Set Strings to character
```

Load required libraries.  

```{r}
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("genefilter" %in% rownames(installed.packages()) == 'FALSE') install.packages('genefilter') 
if ("DESeq2" %in% rownames(installed.packages()) == 'FALSE') install.packages('DESeq2') 
if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer') 
if ("WGCNA" %in% rownames(installed.packages()) == 'FALSE') install.packages('WGCNA') 
if ("flashClust" %in% rownames(installed.packages()) == 'FALSE') install.packages('flashClust') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("ComplexHeatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('ComplexHeatmap') 
if ("goseq" %in% rownames(installed.packages()) == 'FALSE') install.packages('goseq') 
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr') 
if ("clusterProfiler" %in% rownames(installed.packages()) == 'FALSE') install.packages('clusterProfiler') 
if ("pheatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('pheatmap') 
if ("magrittr" %in% rownames(installed.packages()) == 'FALSE') install.packages('magrittr') 

library("tidyverse")
library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("WGCNA")
library("flashClust")
library("gridExtra")
library("ComplexHeatmap")
library("goseq")
library("dplyr")
library("clusterProfiler")
library("pheatmap")
library("magrittr")
```

# **Read in data**  

Load in Gene Info data frame generated in WGCNA_Mcap.Rmd script and subset list of genes and module assignment for each gene.   

```{r}
geneInfo<-read.csv("Mcap2020/Output/TagSeq/geneInfo.csv")

geneInfo<-geneInfo%>%
  select(gene_id, moduleColor)%>%
  rename(Module=moduleColor)%>%
  mutate(Module=as.factor(Module))
```

Add in length and GO term information from annotation file from Erin Chille's genome annotation.    

```{r}
annot<-read_tsv("Mcap2020/Data/TagSeq/200824_Mcap_Blast_GO_KO.tsv", col_names=TRUE)

geneInfo$Length<-annot$length[match(geneInfo$gene_id, annot$gene_id)]
geneInfo$GO_IDs<-annot$GO_IDs[match(geneInfo$gene_id, annot$gene_id)]
```

Generate a file with all genes 

```{r}
all<-geneInfo%>%
  select(gene_id, Length, GO_IDs)
```

Generate a file for genes in modules list  

```{r}
module_list<-geneInfo%>%
  select(gene_id, Length, GO_IDs, Module)

levels(module_list$Module)

module1<-module_list%>%filter(Module=="1")
module2<-module_list%>%filter(Module=="2")
module4<-module_list%>%filter(Module=="4")
module6<-module_list%>%filter(Module=="6")
module8<-module_list%>%filter(Module=="8")
module11<-module_list%>%filter(Module=="11")
module12<-module_list%>%filter(Module=="12")
module14<-module_list%>%filter(Module=="14")
module15<-module_list%>%filter(Module=="15")
module16<-module_list%>%filter(Module=="16")
module17<-module_list%>%filter(Module=="17")
module18<-module_list%>%filter(Module=="18")
```

Read in GO Slim file.  

```{r}
goslim<-read.csv("Mcap2020/Data/TagSeq/GO-GOslim.csv") 

goslim <- goslim %>% select(-term)
```


# **Run GoSeq by Module**  

## Module 1  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module1$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module1%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module1$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module1.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module1.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module1.csv")
```


Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module1.GO_plot <- module1.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module1.GO_plot$GOSlim_bin <- as.factor(module1.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module1.plot <-  ggplot(module1.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module1.png", plot=GO_module1.plot, dpi=300, width=12, height=12, units="in")
```

## Module 2 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module2$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module2%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module2$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module2.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module2.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module2.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module2.GO_plot <- module2.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module2.GO_plot$GOSlim_bin <- as.factor(module2.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module2.plot <-  ggplot(module2.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module2.png", plot=GO_module2.plot, dpi=300, width=12, height=12, units="in")
```

## Module 4 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module4$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module4%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module4$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module4.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module4.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module4.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module4.GO_plot <- module4.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module4.GO_plot$GOSlim_bin <- as.factor(module4.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module4.plot <-  ggplot(module4.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module4.png", plot=GO_module4.plot, dpi=300, width=12, height=12, units="in")
```















NEXT STEP: 
Generate a file for each lifestage 






Bring in goseq files 

Add length for each gene 

Edit function to do by - function and - lifestage  


## Module 6 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module6$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module6%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module6$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module6.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module6.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module6.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module6.GO_plot <- module6.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module6.GO_plot$GOSlim_bin <- as.factor(module6.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module6.plot <-  ggplot(module6.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module6.png", plot=GO_module6.plot, dpi=300, width=12, height=12, units="in")
```
## Module 8 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module8$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module8%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module8$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module8.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module8.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module8.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module8.GO_plot <- module8.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module8.GO_plot$GOSlim_bin <- as.factor(module8.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module8.plot <-  ggplot(module8.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module8.png", plot=GO_module8.plot, dpi=300, width=12, height=12, units="in")
```
## Module 11 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module11$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module11%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module11$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module11.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module11.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module11.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module11.GO_plot <- module11.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module11.GO_plot$GOSlim_bin <- as.factor(module11.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module11.plot <-  ggplot(module11.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module11.png", plot=GO_module11.plot, dpi=300, width=12, height=12, units="in")
```

## Module 12 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module12$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module12%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module12$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module12.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module12.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module12.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module12.GO_plot <- module12.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module12.GO_plot$GOSlim_bin <- as.factor(module12.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module12.plot <-  ggplot(module12.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module12.png", plot=GO_module12.plot, dpi=300, width=12, height=12, units="in")
```
## Module 14 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module14$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module14%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module14$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module14.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module14.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module14.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module14.GO_plot <- module14.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module14.GO_plot$GOSlim_bin <- as.factor(module14.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module14.plot <-  ggplot(module14.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module14.png", plot=GO_module14.plot, dpi=300, width=12, height=12, units="in")
```
## Module 15 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module15$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module15%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module15$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module15.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module15.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module15.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module15.GO_plot <- module15.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module15.GO_plot$GOSlim_bin <- as.factor(module15.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module15.plot <-  ggplot(module15.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module15.png", plot=GO_module15.plot, dpi=300, width=12, height=12, units="in")
```
## Module 16 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module16$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module16%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module16$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module16.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module16.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module16.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module16.GO_plot <- module16.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module16.GO_plot$GOSlim_bin <- as.factor(module16.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module16.plot <-  ggplot(module16.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module16.png", plot=GO_module16.plot, dpi=300, width=12, height=12, units="in")
```
## Module 17 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module17$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module17%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module17$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module17.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module17.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module17.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module17.GO_plot <- module17.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module17.GO_plot$GOSlim_bin <- as.factor(module17.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module17.plot <-  ggplot(module17.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module17.png", plot=GO_module17.plot, dpi=300, width=12, height=12, units="in")
```
## Module 18 

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(module18$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- module18%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(module18$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
module18.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(module18.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_module18.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
module18.GO_plot <- module18.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

module18.GO_plot$GOSlim_bin <- as.factor(module18.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_module18.plot <-  ggplot(module18.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_Module18.png", plot=GO_module18.plot, dpi=300, width=12, height=12, units="in")
```

# **Run GoSeq by Lifestage**  

Assemble a list of genes in the modules that are correlated with each respective lifestage and run GOSeq with those lifestage groupings.  

```{r}
egg_list<-c("1")
embryo_list<-c("1")
larvae1_list<-c("6", "11", "17", "14")
larvae2_list<-c("16", "18")
larvae3_list<-c("16", "4", "2")
larvae4_list<-c("4", "2")
larvae6_list<-c("12")
polyp_list<-c("12")
recruit1_list<-c("15", "8", "14")
recruit2_list<-c("15", "8", "14")

eggs<-module_list%>%filter(Module %in% egg_list)
embryos<-module_list%>%filter(Module %in% embryo_list)
larvae1<-module_list%>%filter(Module %in% larvae1_list)
larvae2<-module_list%>%filter(Module %in% larvae2_list)
larvae3<-module_list%>%filter(Module %in% larvae3_list)
larvae4<-module_list%>%filter(Module %in% larvae4_list)
larvae6<-module_list%>%filter(Module %in% larvae6_list)
polyps<-module_list%>%filter(Module %in% polyp_list)
recruit1<-module_list%>%filter(Module %in% recruit1_list)
recruit2<-module_list%>%filter(Module %in% recruit2_list)
```


## Eggs  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(eggs$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- eggs%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(eggs$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
eggs.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(eggs.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_eggs.csv")
```


Plot results by Biological Process level.    

```{r}
# Plotting by BP function
eggs.GO_plot <- eggs.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

eggs.GO_plot$GOSlim_bin <- as.factor(eggs.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_eggs.plot <-  ggplot(eggs.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_eggs.png", plot=GO_eggs.plot, dpi=300, width=12, height=12, units="in")
```



## Embryos  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(embryos$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- embryos%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(embryos$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
embryos.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(embryos.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_embryos.csv")
```


Plot results by Biological Process level.    

```{r}
# Plotting by BP function
embryos.GO_plot <- embryos.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

embryos.GO_plot$GOSlim_bin <- as.factor(embryos.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_embryos.plot <-  ggplot(embryos.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_embryos.png", plot=GO_embryos.plot, dpi=300, width=12, height=12, units="in")
```



## Larvae 1  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(larvae1$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- larvae1%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(larvae1$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
larvae1.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(larvae1.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_larvae1.csv")
```


Plot results by Biological Process level.    

```{r}
# Plotting by BP function
larvae1.GO_plot <- larvae1.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

larvae1.GO_plot$GOSlim_bin <- as.factor(larvae1.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_larvae1.plot <-  ggplot(larvae1.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_larvae1.png", plot=GO_larvae1.plot, dpi=300, width=12, height=12, units="in")
```



## Larvae 2  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(larvae2$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- larvae2%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(larvae2$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
larvae2.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(larvae2.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_larvae2.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
larvae2.GO_plot <- larvae2.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

larvae2.GO_plot$GOSlim_bin <- as.factor(larvae2.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_larvae2.plot <-  ggplot(larvae2.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_larvae2.png", plot=GO_larvae2.plot, dpi=300, width=12, height=12, units="in")
```



## Larvae 3  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(larvae3$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- larvae3%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(larvae3$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
larvae3.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(larvae3.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_larvae3.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
larvae3.GO_plot <- larvae3.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

larvae3.GO_plot$GOSlim_bin <- as.factor(larvae3.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_larvae3.plot <-  ggplot(larvae3.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_larvae3.png", plot=GO_larvae3.plot, dpi=300, width=12, height=12, units="in")
```



## Larvae 4  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(larvae4$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- larvae4%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(larvae4$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
larvae4.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(larvae4.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_larvae4.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
larvae4.GO_plot <- larvae4.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

larvae4.GO_plot$GOSlim_bin <- as.factor(larvae4.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_larvae4.plot <-  ggplot(larvae4.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_larvae4.png", plot=GO_larvae4.plot, dpi=300, width=12, height=12, units="in")
```



## Larvae 6  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(larvae6$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- larvae6%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(larvae6$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
larvae6.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(larvae6.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_larvae6.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
larvae6.GO_plot <- larvae6.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

larvae6.GO_plot$GOSlim_bin <- as.factor(larvae6.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_larvae6.plot <-  ggplot(larvae6.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_larvae6.png", plot=GO_larvae6.plot, dpi=300, width=12, height=12, units="in")
```



## Polyps  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(polyps$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- polyps%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(polyps$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
polyps.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(polyps.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_polyps.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
polyps.GO_plot <- polyps.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

polyps.GO_plot$GOSlim_bin <- as.factor(polyps.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_polyps.plot <-  ggplot(polyps.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_polyps.png", plot=GO_polyps.plot, dpi=300, width=12, height=12, units="in")
```



## Recruit 1  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(recruit1$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- recruit1%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(recruit1$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
recruit1.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(recruit1.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_recruit1.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
recruit1.GO_plot <- recruit1.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

recruit1.GO_plot$GOSlim_bin <- as.factor(recruit1.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_recruit1.plot <-  ggplot(recruit1.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_recruit1.png", plot=GO_recruit1.plot, dpi=300, width=12, height=12, units="in")
```



## Recruit 2  

Assign vectors  

```{r}
# Vector with all genes after filtering
ALL.vector <- c(all$gene_id)
ID.vector <- c(recruit2$gene_id)

#Length vector for all genes
LENGTH.vector <- c(all$Length)

GO.terms <- recruit2%>%
  select(gene_id, GO_IDs)

str(GO.terms) 

#Formatting sig gene file with a goterm per row
split <- strsplit(as.character(GO.terms$GO_IDs), "; ") 
split2 <- data.frame(v1 = rep.int(GO.terms$gene, sapply(split, length)), v2 = unlist(split)) 
colnames(split2) <- c("gene", "GO_IDs")

GO.terms<-split2

str(GO.terms)
```

Run GoSeq  

```{r}
DEG <- as.character(recruit2$gene_id) #set the enrichment test list
DEG.vector <-c(DEG) #change to vectors
  
gene.vector=as.integer(ALL.vector%in%DEG.vector) #Construct new vector with 1 for DEG and 0 for others
names(gene.vector)=ALL.vector #set names

DEG.pwf<-nullp(gene.vector, ID.vector, bias.data=LENGTH.vector) #weight vector by length of gene

#Find enriched GO terms
GO.wall<-goseq(DEG.pwf, ID.vector, gene2cat=GO.terms, test.cats=c("GO:CC", "GO:BP", "GO:MF"), method="Wallenius", use_genes_without_cat=TRUE)
GO <- GO.wall[order(GO.wall$over_represented_pvalue),]
colnames(GO)[1] <- "GO_ID"
  
#GOslim 
GO.slim <- left_join(GO, goslim, by = "GO_ID")
GO.slim <- GO.slim[!duplicated(GO.slim$GO_ID), ]
  
#Filtering for p > 0.05
recruit2.GO <- GO.slim %>%
  dplyr::filter(over_represented_pvalue<0.05) %>%
  arrange(., ontology, term, over_represented_pvalue)

write.csv(recruit2.GO , file = "Mcap2020/Output/TagSeq/GOSeq/goseq_recruit2.csv")
```

Plot results by Biological Process level.    

```{r}
# Plotting by BP function
recruit2.GO_plot <- recruit2.GO %>%
  filter(over_represented_pvalue != "NA") %>%
  filter(numInCat >5) %>%
  filter(ontology == "BP") %>%
  arrange(., ontology, GOSlim_bin, over_represented_pvalue)

recruit2.GO_plot$GOSlim_bin <- as.factor(recruit2.GO_plot$GOSlim_bin)

#plot significantly enriched GO terms by Slim Category
GO_recruit2.plot <-  ggplot(recruit2.GO_plot, aes(x = ontology, y = term)) + 
  geom_tile(aes(fill =over_represented_pvalue)) + 
  facet_grid(GOSlim_bin ~ ., scales = "free_y", labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
  strip.text.y = element_text(angle=0, size = 10),
  strip.text.x = element_text(size = 20),
  axis.text = element_text(size = 8),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())

ggsave(filename="Mcap2020/Figures/TagSeq/GOSeq/GOenrich_recruit2.png", plot=GO_recruit2.plot, dpi=300, width=12, height=12, units="in")
```


