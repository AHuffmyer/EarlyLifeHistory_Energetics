---
title: "Analysis of 16S data output from Mothur"
author: "Ariana S Huffmyer"
date: 'January 2022'
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("janitor" %in% rownames(installed.packages()) == 'FALSE') install.packages('janitor') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("phyloseq" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('phyloseq') 
if ("stringr" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('stringr')
if ("ape" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('ape') 
if ("DESeq2" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('DESeq2') 
if ("microViz" %in% rownames(installed.packages()) == 'FALSE') devtools::install_github("david-barnett/microViz@0.9.0") 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 

#load packages
library("ggplot2")
library('cowplot')
library("tidyverse")
library("janitor")
library("car")
library("phyloseq")
library("stringr")
library("ape")
library("DESeq2")
library("microViz")
library("vegan")
```

# **Load data**  

Load data for use in analysis with PhyloSeq. Here we will import an OTU table and a taxonomy table.  

We will load "rare" files as those that were subsampled/rarefied.  

```{r}
otu.rare<-read.table("Mcap2020/Output/16S/mothur/TextFormat/mcap.opti_mcc.0.03.subsample.shared.txt", sep='\t', header=TRUE)
otu.full<-read.table("Mcap2020/Output/16S/mothur/TextFormat/mcap.opti_mcc.shared.txt", sep='\t', header=TRUE)

taxonomy<-read.table("Mcap2020/Output/16S/mothur/TextFormat/mcap.taxonomy.txt", sep='\t', header=TRUE)

rarefaction<-read.table("Mcap2020/Output/16S/mothur/TextFormat/mcap.opti_mcc.groups.rarefaction.txt", sep='\t', header=TRUE)
```

Load sample information.  
```{r}
metadata<-read.table("Mcap2020/Data/16S/mcap_metadata.txt", sep='\t', header=TRUE)

rownames(metadata)<-metadata$sample

metadata<-metadata%>%
  select(!sample)
  
```

Set default plot theme.  

```{r}
theme_set(theme_bw())
```

Format columns of our taxonomy file. We need to separate by ; and remove the quotes. We also need to remove the confidence values.  
```{r}
head(taxonomy)

taxonomy<-taxonomy%>%
  mutate(Taxonomy=str_replace_all(string=Taxonomy, pattern="\\(\\d*\\)", replacement="")) %>% #remove parentheses with numbers
	mutate(Taxonomy=str_replace_all(string=Taxonomy, pattern=";$", replacement="")) %>% #remove semicolons
 # mutate(Taxonomy=str_replace_all(string=Taxonomy, pattern="*", replacement="")) %>% #remove quotes
  #mutate(Taxonomy=str_replace_all(string=Taxonomy, pattern="""$", replacement="")) %>% #remove quotes
	separate(Taxonomy, into=c("Domain", "Phylum", "Class", "Order", "Family", "Genus"), sep=";") #separate columns

head(taxonomy)

rownames(taxonomy)<-taxonomy$OTU
taxonomy<-as.matrix(taxonomy)

```


# **Tree and heatmap for "full" dataset**  

Prepare the matrix to be all numeric with taxa in rows.  
```{r}
otu.full<-otu.full%>%
  select(!label)%>%
  select(!numOtus)

rownames(otu.full)<-otu.full$Group

otu.full<-otu.full%>%
  select(!Group)

otu.full<-t(otu.full)
```

Prepare the taxonomy table.  
```{r}
rownames(taxonomy)<-taxonomy$OTU

taxonomy<-taxonomy%>%
  select(!Size)%>%
  select(!OTU)

taxonomy<-as.matrix(taxonomy)
```

Combine the OTU and taxonomic information.  
```{r}
OTU_full = otu_table(otu.full, taxa_are_rows = TRUE)
TAX = tax_table(taxonomy)
OTU_full
```

Load into phyloseq.  
```{r}
physeq = phyloseq(OTU_full, TAX)
physeq
```

Plot an abundance table at the different taxonomic levels.    
```{r}
plot_bar(physeq, fill = "Domain")+theme(legend.position="bottom")
plot_bar(physeq, fill = "Phylum")+theme(legend.position="bottom")
#plot_bar(physeq, fill = "Class")+theme(legend.position="bottom")
#plot_bar(physeq, fill = "Order")+theme(legend.position="bottom")
#plot_bar(physeq, fill = "Family")+theme(legend.position="bottom")
```

Plot a tree of OTU's.  
```{r}
random_tree = rtree(ntaxa(physeq), rooted=TRUE, tip.label=taxa_names(physeq))
plot(random_tree)
```

Generate sample information.  
```{r}
sampledata = sample_data(data.frame(
  lifestage = metadata$lifestage,
  group = metadata$group, 
  hpf = metadata$hpf,
  row.names=sample_names(physeq),
  stringsAsFactors=FALSE
))
sampledata
```

Merge the tree, sample information, and OTU table.  
```{r}
physeq1 = merge_phyloseq(physeq, sampledata, random_tree)
physeq1
```

Now rebuild phyloseq.  
```{r}
physeq2 = phyloseq(OTU_full, TAX, sampledata, random_tree)
physeq2
```

Check that they are identical. Should return TRUE.  
```{r}
identical(physeq1, physeq2)
```

Filter out samples with low numbers in groups from phyloseq object.  
```{r}
physeq1<-ps_filter(physeq1, lifestage != "Metamorphosed Recruit (183 hpf)")
physeq1<-ps_arrange(physeq1, hpf)
```

Now build a tree with the combined data.  
```{r}
plot_tree(physeq1, color="group", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
```

Plot a heatmap.  

```{r}
plot_heatmap(physeq1, "NMDS", "bray", "lifestage", "Family", low="#66CCFF", high="#000033", na.value="white")
```

# **Tree and heatmap for "rarefied" dataset**   

Prepare the matrix to be all numeric with taxa in rows.  
```{r}
otu.rare<-otu.rare%>%
  select(!label)%>%
  select(!numOtus)

rownames(otu.rare)<-otu.rare$Group

otu.rare<-otu.rare%>%
  select(!Group)

otu.rare<-t(otu.rare)
```

Combine the OTU and taxonomic information.  
```{r}
OTU_rare = otu_table(otu.rare, taxa_are_rows = TRUE)
TAX = tax_table(taxonomy)
OTU_rare
```

Load into phyloseq.  
```{r}
physeq_rare = phyloseq(OTU_rare, TAX)
physeq_rare
```

Filter out least abundant taxa.  

```{r}
physeq_rare_f  = transform_sample_counts(physeq_rare, function(x) x / sum(x) )
physeq_rare = filter_taxa(physeq_rare_f, function(x) mean(x) > 1e-3, TRUE)
```

Plot an abundance table at the different taxonomic levels.    
```{r}
plot_bar(physeq_rare, fill = "Domain")+theme(legend.position="bottom")
plot_bar(physeq_rare, fill = "Phylum")+theme(legend.position="bottom")
plot_bar(physeq_rare, fill = "Class")+theme(legend.position="bottom")
plot_bar(physeq_rare, fill = "Order")+theme(legend.position="bottom")
plot_bar(physeq_rare, fill = "Family")+theme(legend.position="bottom")
plot_bar(physeq_rare, fill = "Genus")+theme(legend.position="bottom")
```

Plot a tree of OTU's.  
```{r}
random_tree_rare = rtree(ntaxa(physeq_rare), rooted=TRUE, tip.label=taxa_names(physeq_rare))
plot(random_tree_rare)
```

Merge the tree, sample information, and OTU table.  
```{r}
physeq1_rare = merge_phyloseq(physeq_rare, sampledata, random_tree_rare)
physeq1_rare
```

Now rebuild phyloseq.  
```{r}
physeq2_rare = phyloseq(OTU_rare, TAX, sampledata, random_tree_rare)
physeq2_rare
```

Check that they are identical. Should return TRUE.  
```{r}
identical(physeq1_rare, physeq2_rare)
```

Filter out samples with low numbers in groups from phyloseq object.   
```{r}
physeq1_rare<-ps_filter(physeq1_rare, lifestage != "Metamorphosed Recruit (183 hpf)")
physeq1_rare<-ps_filter(physeq1_rare, lifestage != "Egg (1 hpf)")
physeq1_rare<-ps_filter(physeq1_rare, lifestage != "Embryo (5 hpf)")
#physeq1_rare<-ps_filter(physeq1_rare, lifestage != "Embryo (38 hpf)")
```

Now build a tree with the combined data.  
```{r}
plot_tree(physeq1_rare, color="group", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
```

Plot a heatmap.  

```{r}
plot_heatmap(physeq1_rare, "NMDS", "bray", "lifestage", "Family", low="#66CCFF", high="#000033", na.value="white")
```  

Plot relative abundance now with group information.  

```{r}
bar1<-plot_bar(physeq1_rare, fill = "Class")+theme(legend.position="bottom")+facet_grid(~lifestage, scales="free_x")
ggsave(plot=bar1, file="Mcap2020/Figures/16S/relabund_class_rare.png", h=6, w=18)

bar2<-plot_bar(physeq1_rare, fill = "Phylum")+theme(legend.position="bottom")+facet_grid(~lifestage, scales="free_x")
ggsave(plot=bar2, file="Mcap2020/Figures/16S/relabund_phylum_rare.png", h=6, w=18)

bar3<-plot_bar(physeq1_rare, fill = "Order")+theme(legend.position="bottom")+facet_grid(~lifestage, scales="free_x")
ggsave(plot=bar3, file="Mcap2020/Figures/16S/relabund_order_rare.png", h=9, w=18)

bar4<-plot_bar(physeq1_rare, fill = "Family")+theme(legend.position="bottom")+facet_grid(~lifestage, scales="free_x")
ggsave(plot=bar4, file="Mcap2020/Figures/16S/relabund_family_rare.png", h=12, w=18)

bar5<-plot_bar(physeq1_rare, fill = "Genus")+theme(legend.position="bottom")+facet_grid(~lifestage, scales="free_x")
ggsave(plot=bar5, file="Mcap2020/Figures/16S/relabund_genus_rare.png", h=25, w=18)
```


# **NMDS of rarefied dataset**  

```{r}
GP1 = physeq1_rare
GP1
```

Transform to even sampling depth.  
```{r}
#GP1 = transform_sample_counts(GP1, function(x) 1E6 * x/sum(x))
```

View ordinations: PCoA + unifrac.    
```{r}
GP.ord <- ordinate(GP1, "PCoA", "unifrac")
p1 = plot_ordination(GP1, GP.ord, type="taxa", color="Class", title="taxa")
```

View faceted by Phylum.  
```{r}
p1 + facet_wrap(~Class, 3) + theme(legend.position="none")
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1, GP.ord, type="samples", color="lifestage") 
p2<-p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=5) + ggtitle("subsampled dataset PCoA Unifrac")
#p2<-p2 + geom_point(size=5) + ggtitle("subsampled dataset")
p2

ggsave(plot=p2, filename="Mcap2020/Figures/16S/pcoa_unifrac_rare.png")
```


View ordinations: PCoA + bray curtis    
```{r}
GP.ord <- ordinate(GP1, "PCoA", "bray")
p1 = plot_ordination(GP1, GP.ord, type="taxa", color="Class", title="taxa")
```

View faceted by Phylum.  
```{r}
p1 + facet_wrap(~Class, 3) + theme(legend.position="none")
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1, GP.ord, type="samples", color="lifestage") 
p2<-p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=5) + ggtitle("subsampled dataset PCoA Bray Curtis")
#p2<-p2 + geom_point(size=5) + ggtitle("subsampled dataset")
p2

ggsave(plot=p2, filename="Mcap2020/Figures/16S/pcoa_bray_rare.png")
```


View ordinations: NMDS + bray curtis    
```{r}
GP.ord <- ordinate(GP1, "NMDS", "bray")
p1 = plot_ordination(GP1, GP.ord, type="taxa", color="Class", title="taxa")
```

View faceted by Phylum.  
```{r}
p1 + facet_wrap(~Class, 3) + theme(legend.position="none")
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1, GP.ord, type="samples", color="lifestage") 
p2<-p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=5) + ggtitle("subsampled dataset NMDS Bray Curtis")
#p2<-p2 + geom_point(size=5) + ggtitle("subsampled dataset")
p2

ggsave(plot=p2, filename="Mcap2020/Figures/16S/NMDS_bray_rare.png")
```


View ordinations: NMDS + unifrac    
```{r}
GP.ord <- ordinate(GP1, "NMDS", "unifrac")
p1 = plot_ordination(GP1, GP.ord, type="taxa", color="Class", title="taxa")
```

View faceted by Phylum.  
```{r}
p1 + facet_wrap(~Class, 3) + theme(legend.position="none")
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1, GP.ord, type="samples", color="lifestage") 
p2<-p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=5) + ggtitle("subsampled dataset NMDS unifrac")
#p2<-p2 + geom_point(size=5) + ggtitle("subsampled dataset")
p2

ggsave(plot=p2, filename="Mcap2020/Figures/16S/NMDS_unifrac_rare.png")
```


We do see separation between lifestages.    

Conduct a permanova in the vegan package.  

```{r}

metadata <- as(sample_data(GP1), "data.frame")

adonis(phyloseq::distance(GP1, method="bray") ~ lifestage,
       data = metadata)

adonis(phyloseq::distance(GP1, method="unifrac") ~ lifestage,
       data = metadata)
```

There is significant difference in the centroids between life stages in the rarefied dataset for both unifrac and bray-curtis distance measures.  

# **NMDS of full dataset**  

```{r}
GP1f = physeq1
GP1f
```

Transform to even sampling depth.  
```{r}
GP1f = transform_sample_counts(GP1f, function(x) 1E6 * x/sum(x))
```

View ordination by OTU.  
```{r}
GP.ord <- ordinate(GP1f, "NMDS", "bray")
p1 = plot_ordination(GP1f, GP.ord, type="taxa", color="Class", title="taxa")
```

View faceted by Phylum.  
```{r}
p1 + facet_wrap(~Class, 3) + theme(legend.position="none")
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1f, GP.ord, type="samples", color="lifestage") 
p2<- p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=5) + ggtitle("full dataset")
p2
```

Conduct a permanova in the vegan package.  

```{r}
metadata <- as(sample_data(GP1f), "data.frame")

adonis(phyloseq::distance(GP1f, method="bray") ~ lifestage,
       data = metadata)
```

There are also significant differences between centroids in life stages in the full dataset.  

# **Alpha Diversity - Full dataset**  

Remove any OTU that has a count of 0 in all samples. (There are none in this dataset).    
```{r}
GP2f <- prune_taxa(taxa_sums(physeq1) > 0, physeq1)
```

Plot all richness metrics.  
```{r}
plot_richness(GP2f)
```

Plot the two most commonly used - Shannon and Inverse Simpson.  
```{r}
plot_richness(GP2f, measures=c("InvSimpson", "Shannon"), x="lifestage", color="group")
```

We see increase in alpha diversity across development with higher values in attached recruits.    

Test for differences in alpha diversity.  
```{r}
metadata <- as(sample_data(GP2f), "data.frame")
metadata$sample<-rownames(metadata)

alpha_full<-estimate_richness(GP2f, measures=c("InvSimpson", "Shannon"))
alpha_full$sample<-rownames(alpha_full)

alpha_full<-full_join(metadata, alpha_full, by="sample")

summary(aov(Shannon~lifestage, data=alpha_full))
summary(aov(InvSimpson~lifestage, data=alpha_full))
```

There are significant differences in alpha diversity between lifestages.  

# **Alpha Diversity - Rare dataset**  

```{r}
GP2 <- prune_taxa(taxa_sums(physeq1_rare) > 0, physeq1_rare)
```

Plot all richness metrics.  
```{r}
plot_richness(GP2)
```

Plot the two most commonly used - Shannon and Inverse Simpson.  
```{r}
alpha1<-plot_richness(GP2, measures=c("InvSimpson", "Shannon", "Chao1"), x="lifestage", color="group")
alpha1

ggsave(plot=alpha1, file="Mcap2020/Figures/16S/alpha_rare.png")
```

Similar to the full dataset, we see increases in alpha diversity across development with higher values in attached recruits.  

Test for differences in alpha diversity.  
```{r}
metadata <- as(sample_data(GP2), "data.frame")
metadata$sample<-rownames(metadata)

alpha_rare<-estimate_richness(GP2, measures=c("InvSimpson", "Shannon", "Chao1"))
alpha_rare$sample<-rownames(alpha_rare)

alpha_rare<-full_join(metadata, alpha_rare, by="sample")

summary(aov(Shannon~lifestage, data=alpha_rare))
summary(aov(InvSimpson~lifestage, data=alpha_rare))
summary(aov(Chao1~lifestage, data=alpha_rare))
```

There are significant differences in alpha diversity between lifestages for all metrics.    

# **Networks - Full dataset**  

Remove NA's. 
```{r}
GP3f = physeq1
```

Plot network.  
```{r}
plot_net(GP3f, maxdist = 1, point_label = "lifestage", color = "group")
```

Plot network.  
```{r}
igF <- make_network(GP3f, max.dist=1)
plot_network(igF, GP3f, color="group", label=NULL)
```

The networks are not particularly informative for this dataset.  

# **Networks - Rare dataset**  

Remove NA's. 
```{r}
GP3 = physeq1_rare
```

Plot network.  
```{r}
plot_net(GP3, maxdist = 1, point_label = "lifestage", color = "group")
```

Plot network.  
```{r}
ig <- make_network(GP3, max.dist=1)
plot_network(ig, GP3, color="group", label=NULL)
```

The networks are not particularly informative for this dataset.  \

# **Plot unknowns - Full dataset** 

Plot data at the level of phylum. Bacteria_unclassified are our unknowns.      
```{r}
plot_bar(physeq1, fill="Phylum", facet_grid=~Phylum)

p5<-plot_bar(physeq1, fill="Order", facet_grid=~Order)

pdf(file="Mcap2020/Figures/16S/order_abund.pdf", height = 8, width = 100)
p5 + theme(legend.position="none")
dev.off()
```

We have some unclassified bacteria, but a higher proportion of proteobacteria and bacteriodes.  

# **Plot unknowns - rare dataset** 

Plot data at the level of phylum in the rarefied dataset. Bacteria_unclassified are our unknowns.      
```{r}
plot_bar(physeq1_rare, fill="Phylum", facet_grid=~Phylum)
```

We have some unclassified bacteria, but a higher proportion of proteobacteria and bacteriodes.  


# **DESeq2 - Full dataset**  

THERE IS SOMETHING GOING ON WITH THE PVALUE ADJUSTMENT HERE - all the values are close to 1 - high number of comparisons? But there must be significant drivers? 

Convert phyloseq object to DESeq2 object.  

Construct DESeq2 object looking at differences by lifestage.  
```{r}
diagdds_full = phyloseq_to_deseq2(physeq1, ~ lifestage)

gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(diagdds_full), 1, gm_mean)
diagdds_full = estimateSizeFactors(diagdds_full, geoMeans = geoMeans)
#diagdds_full = DESeq(diagdds_full, fitType="local")

diagdds_full = DESeq(diagdds_full, test="Wald", fitType="parametric")
```

Look at results table.  
```{r}
res_full = results(diagdds_full, cooksCutoff = FALSE)
alpha = 0.05
sigtab = res_full[which(res_full$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq1)[rownames(sigtab), ], "matrix"))
head(sigtab)
length(sigtab)
```


# **DESeq2 - Rare dataset**  

Convert phyloseq object to DESeq2 object.  

Construct DESeq2 object looking at differences by lifestage.  
```{r}
diagdds_rare = phyloseq_to_deseq2(physeq1_rare, ~ group)

gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(diagdds_rare), 1, gm_mean)
diagdds_rare = estimateSizeFactors(diagdds_rare, geoMeans = geoMeans)
#diagdds_rare = DESeq(diagdds_rare, fitType="local")

diagdds_rare = DESeq(diagdds_rare, test="Wald", fitType="parametric")
```

Look at results table.  
```{r}
res_rare = results(diagdds_rare, cooksCutoff = FALSE)
alpha = 0.05
sigtab = res_rare[which(res_rare$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq1_rare)[rownames(sigtab), ], "matrix"))
head(sigtab)
```

We do not get any members that are differential - why is this when we have group separation?   