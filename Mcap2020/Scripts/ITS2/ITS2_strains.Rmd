---
title: Montipora capitata 2020 ITS2 analysis
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

ITS2 strain variation data analysis based on scripts written by Shayle Matsuda, Shedd Aquarium.   

```{r}
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("readxl")) install.packages("readxl")
if (!require("phyloseq")) BiocManager::install("phyloseq")
if (!require("janitor")) install.packages("janitor")
if (!require("writexl")) install.packages("writexl")
#if (!require("microViz")) BiocManager::install("microViz")

library("tidyverse")
library("readxl")
library("phyloseq")
library("janitor")
library("writexl")

library("ggplot2")
library('cowplot')
library("tidyverse")
library("janitor")
library("car")
library("phyloseq")
library("stringr")
library("ape")
library("DESeq2")
library("microViz")
library("vegan")
library("ComplexHeatmap")

```

# **Prepare data**  

Load metadata.  
```{r}
#create metadata and load
Metadata<-read.csv("Mcap2020/Data/ITS2/ITS2_Metadata.csv")
rownames(Metadata) <- Metadata$sample_name
Metadata <- Metadata %>%
  select(code, hpf, group, lifestage)
Metadata <- as.matrix(Metadata)
Metadata <- sample_data(data.frame(Metadata))
```

Load profile level data.  
```{r}
#load data for taxonomy
tax0 <- read_tsv(
  file  = "Mcap2020/Data/ITS2/mcap.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

#load data for count matrix 
otu0 <- read_tsv(
  file  = "Mcap2020/Data/ITS2/mcap.profiles.absolute.abund_and_meta.txt", col_names = TRUE) 

list<-c("UID", "sample_name", "8", "9")
colnames(otu0)<-list

otu0<-otu0%>%
  select(-1) %>%
  dplyr::slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)

otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

#combine to phyloseq object
coral <- phyloseq(otu, tax, Metadata)
coral
```

Note that taxa 8 is Clade C and taxa 9 is Clade D.  

Next load the data for coral strain level information.  

```{r}
#gather the taxonomy names  
taxnames <- read_tsv(
  file  = "Mcap2020/Data/ITS2/mcap.seqs.absolute.abund_only.txt",
  n_max = 0) %>%
  select(-1) %>%
  names(.)

#extract clade letter  
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)

tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file  = "Mcap2020/Data/ITS2/mcap.seqs.absolute.abund_and_meta.txt") %>%
  select(-1, )

otu1 <- as.matrix(otu0[, 37:113])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coralDIV <- phyloseq(otu, tax, Metadata)
coralDIV
```

Now save the object.  
```{r} 
save(coral, coralDIV, file = "Mcap2020/Data/ITS2/ITS2_phyloseq.RData")
```

# **Build DIV Data**  

Load the data.  
```{r}
load("Mcap2020/Data/ITS2/ITS2_phyloseq.RData")
```

```{r}
coralDIV
```

View the number of sequence counts in our dataset.   
```{r}
Samps<-read_tsv(file  = "Mcap2020/Data/ITS2/mcap.seqs.absolute.abund_and_meta.txt")

hist(Samps$post_taxa_id_absolute_symbiodiniaceae_seqs, breaks=30)

```
We have >10,000 sequences for all of our samples. This is a high number and we can keep all samples. We will subsample to even sampling depth below.    

Plot tree.  
```{r}
random_tree = rtree(ntaxa(coralDIV), rooted=TRUE, tip.label=taxa_names(coralDIV))
plot(random_tree)
```

Merge phyloseq data. 
```{r}
phylo_coral_DIV = merge_phyloseq(coralDIV, Metadata, random_tree)
phylo_coral_DIV
```

Filter out samples with low numbers in groups from phyloseq object.  
```{r}
phylo_coral_DIV<-ps_filter(phylo_coral_DIV, lifestage != "Metamorphosed Polyp (183 hpf)")
phylo_coral_DIV<-ps_arrange(phylo_coral_DIV, lifestage)
```

Reorder lifestage.  
```{r}
levels(as.factor(sample_data(phylo_coral_DIV)$lifestage))

sample_data(phylo_coral_DIV)$lifestage = factor(sample_data(phylo_coral_DIV)$lifestage, levels = c("Egg (1 hpf)","Embryo (5 hpf)","Embryo (38 hpf)","Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)", "Attached Recruit (231 hpf)"))

levels(as.factor(sample_data(phylo_coral_DIV)$lifestage))
```

Now build a tree with the combined data.  
```{r}
plot_tree(phylo_coral_DIV, color="lifestage", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
```

Plot a heatmap.  

```{r}
plot_heatmap(phylo_coral_DIV, "NMDS", "bray", "lifestage", low="#66CCFF", high="#000033", na.value="white")
```

Plot ordinations.  

```{r}
GP1 = phylo_coral_DIV
GP1
```

Transform to relative abundance and subsample to even sampling depth to minimum count in dataset (~10,000).  
```{r}
GP1 = transform_sample_counts(GP1, function(x) 100 * x/sum(x))

GP1_rare<-rarefy_even_depth(GP1, sample.size = min(sample_sums(GP1)),
  rngseed = FALSE, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
```

In rarefication 14 OTUs were removed because they were no longer present in any sample after random subsampling. 

View tree and heatmap after subsampling.   
```{r}
plot_tree(GP1_rare, color="lifestage", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
plot_heatmap(GP1_rare, "NMDS", "bray", "lifestage", low="#66CCFF", high="#000033", na.value="white")
```

# **DIV Ordinations: PCoA and NMDS** 

View ordination by OTU using the rarefied dataset.    
```{r}
GP.ord <- ordinate(GP1_rare, "NMDS", "bray")
p1 = plot_ordination(GP1_rare, GP.ord, type="taxa", title="taxa")
p1
```

Plot with samples now.  
```{r}
p2 = plot_ordination(GP1_rare, GP.ord, type="samples", color="lifestage") 
p2<- p2 + geom_polygon(aes(fill=lifestage)) + geom_point(size=4) + ggtitle("samples")
p2
```

View pcoa by OTU.  
```{r}
GP.ordb <- ordinate(GP1_rare, "PCoA", "bray")
p1b = plot_ordination(GP1_rare, GP.ordb, type="taxa", title="taxa")
p1b
```

Plot with samples now.  
```{r}
p2b = plot_ordination(GP1_rare, GP.ordb, type="samples", color="lifestage"); p2b 
```
pch.input = c(1, 2, 3, 4, 5, 6, 7 ,8, 9, 10, 11, 12, 13)

Output PCoA plot for visualization.  
```{r}
p2b_viz<-p2b  + 
  geom_point(aes(colour=lifestage, shape=lifestage), size=4) + 
  ggtitle("PCoA")+
  scale_colour_manual(name="Lifestage", values=c("#8C510A", "#DFC27D","#DFC27D", "#DFC27D", "#80CDC1", "#80CDC1", "#80CDC1","#003C30", "#BA55D3", "#BA55D3")) + 
  scale_shape_manual(name="Lifestage", values = c("Egg (1 hpf)"=1, "Attached Recruit (231 hpf)"=13, "Embryo (5 hpf)"=2, "Embryo (38 hpf)"=3, "Embryo (65 hpf)"=4, "Larvae (93 hpf)"=5, "Larvae (163 hpf)"=6, "Larvae (231 hpf)"=8, "Metamorphosed Polyp (231 hpf)"=11, "Attached Recruit (183 hpf)"=12)) +
  theme_classic() + 
  theme(
    panel.background=element_blank()
  ); p2b_viz

ggsave(plot=p2b_viz, "Mcap2020/Figures/ITS2/pcoa_its2_div.jpeg", h=6, w=8)
```

Conduct a permanova in the vegan package.  

```{r}
metadata <- as(sample_data(GP1_rare), "data.frame")

perm1<-adonis2(phyloseq::distance(GP1_rare, method="bray") ~ lifestage,
       data = metadata)

perm1
```

Permanova suggests there is no significant separation by lifestage in ITS2 profiles (p=0.175).  

# **Plot heat map of ITS2 DIVs**  

Draw with Phyloseq using the top DIV's (16 in this case).  

```{r}
GP1_prune = filter_taxa(GP1_rare, function(x) sum(x) > 30, TRUE)

sample_order<-c("WSH053", "WSH054", "WSH055", "WSH056", "WSH061", "WSH062", "WSH063", "WSH064",  "WSH065", "WSH066", "WSH067", "WSH068",  "WSH069", "WSH070", "WSH071", "WSH072", "WSH073", "WSH074", "WSH075", "WSH076", "WSH077", "WSH078", "WSH079", "WSH080", "WSH081", "WSH082", "WSH083", "WSH084", "WSH057", "WSH058", "WSH059", "WSH060", "WSH046", "WSH047", "WSH048", "WSH049", "WSH050", "WSH051", "WSH052")
#sample_name by lifestage order 

p<-plot_heatmap(GP1_prune, sample.label="lifestage", low="#66CCFF", high="#000033", na.value="white", sample.order=sample_order)
p$scales$scales[[1]]$name <- "Lifestage"

print(p)

ggplot2::ggsave("Mcap2020/Figures/ITS2/div_heatmap.jpg", p, width = 6, height = 6)
```

Draw with Complex Heatmap
```{r}
ComplexHeatmap::Heatmap(t(otu_table(GP1_prune)))
```

# **Alpha diversity**  

Look at alpha diversity.  

Remove any OTU that has a count of 0 in all samples. (There are none in this dataset).    
```{r}
GP2f <- prune_taxa(taxa_sums(GP1_rare) > 0, GP1_rare)
```

Plot the two most commonly used richness metrics - Shannon and Inverse Simpson.  
```{r}
plot_richness(GP2f, measures=c("InvSimpson", "Shannon"), x="lifestage", color="lifestage")
```

Pretty similar across life stages.      

Test for differences in alpha diversity.  
```{r}
metadata <- as(sample_data(GP2f), "data.frame")
metadata$sample<-rownames(metadata)

alpha_full<-estimate_richness(GP2f, measures=c("InvSimpson", "Shannon"))
alpha_full$sample<-rownames(alpha_full)

alpha_full<-full_join(metadata, alpha_full, by="sample")

summary(aov(Shannon~lifestage, data=alpha_full))
summary(aov(InvSimpson~lifestage, data=alpha_full))
```

No difference in ITS2 alpha diversity by lifestage.  

# **DESeq2**  

Try DESeq2 to look at any differential taxa.   

Convert phyloseq object to DESeq2 object.  

Construct DESeq2 object looking at differences by lifestage.  
```{r}
diagdds_full = phyloseq_to_deseq2(GP1_rare, ~ lifestage)

gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(diagdds_full), 1, gm_mean)
diagdds_full = estimateSizeFactors(diagdds_full, geoMeans = geoMeans)
#diagdds_full = DESeq(diagdds_full, fitType="local")

diagdds_full = DESeq(diagdds_full, test="Wald", fitType="parametric")
```

Look at results table.  
```{r}
res_full = results(diagdds_full, cooksCutoff = FALSE)
alpha = 0.05
sigtab = res_full[which(res_full$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(GP1_rare)[rownames(sigtab), ], "matrix"))

sigtab
```

As expected, there are no members of the community that are differentially accumulated/present across development. 

# **Generate VST normalization for DIABLO**  

```{r}
gvst <- varianceStabilizingTransformation(diagdds_full, blind=FALSE)
head(assay(gvst), 3)

#generate as matrix 
matrix<-assay(gvst)
dim(matrix)

matrix<-as.data.frame(matrix)

#save for DIABLO 
write.csv(matrix, "Mcap2020/Data/Integration/its2_div.csv")
```

# **Plot profile level information** 

View the profile level phyloseq object.   
```{r}
coral
```

Note that taxa 8 is Clade C and taxa 9 is Clade D. 

Create tree.  
```{r}
random_tree_profile = rtree(ntaxa(coral), rooted=TRUE, tip.label=taxa_names(coral))
```

Merge phyloseq data. 
```{r}
phylo_coral = merge_phyloseq(coral, Metadata, random_tree_profile)
phylo_coral
```

Filter out samples with low numbers in groups from phyloseq object.  
```{r}
phylo_coral<-ps_filter(phylo_coral, lifestage != "Metamorphosed Polyp (183 hpf)")
phylo_coral<-ps_arrange(phylo_coral, lifestage)
```

Reorder lifestage.  
```{r}
levels(as.factor(sample_data(phylo_coral)$lifestage))

sample_data(phylo_coral)$lifestage = factor(sample_data(phylo_coral)$lifestage, levels = c("Egg (1 hpf)","Embryo (5 hpf)","Embryo (38 hpf)","Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)", "Attached Recruit (231 hpf)"))

levels(as.factor(sample_data(phylo_coral)$lifestage))
```

Now build a tree with the combined data.  
```{r}
plot_tree(phylo_coral, color="lifestage", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
```

Plot a heatmap.  

```{r}
plot_heatmap(phylo_coral, "NMDS", "bray", "lifestage", low="#66CCFF", high="#000033", na.value="white")
```

Plot ordinations.  

```{r}
GP1_profile = phylo_coral
GP1_profile
```

Transform to relative abundance.  
```{r}
GP1_profile = transform_sample_counts(GP1_profile, function(x) 100 * x/sum(x))

GP1_rare_profile<-rarefy_even_depth(GP1_profile, sample.size = min(sample_sums(GP1_profile)),
  rngseed = FALSE, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
```

View tree and heatmap after rarefication.  
```{r}
plot_tree(GP1_rare_profile, color="lifestage", label.tips="taxa_names", ladderize="left", plot.margin=0.3)
plot_heatmap(GP1_rare_profile, "NMDS", "bray", "lifestage", low="#66CCFF", high="#000033", na.value="white")
```

Plot abundance of each profile across lifestages.  
```{r}
t<-plot_bar(GP1_rare_profile, fill="its2_type_profile")
t$data$Sample <- factor(t$data$Sample, levels = sample_order)
t_plot<-t + scale_fill_manual(name="ITS2 Type Profile", values=c("darkorange", "brown4")) + geom_hline(yintercept=50, linetype="dashed", color = "black", size=1) + facet_grid(~lifestage, scales = "free", space = "free", labeller = label_wrap_gen(width=10)) + theme(strip.text.x = element_text(size = 5, face="bold"))

t_plot

rel_abund_data<-t$data

ggsave("Mcap2020/Figures/ITS2/profile_plot.png", width=11, height=6)
```

Calculate the average percent abundance for each taxa in each lifestage.  
```{r}
means <- rel_abund_data %>%
  group_by(its2_type_profile, lifestage) %>%
  # Add abundances within each profile and lifestage
  summarize_at("Abundance", mean)%>%
  spread(its2_type_profile, Abundance);means
```

Use T-test to test for differences in relative abundance of C and D across lifestages.  
```{r}
test<-rel_abund_data %>% 
  select(its2_type_profile, Abundance, lifestage, Sample)%>%
  spread(its2_type_profile, Abundance)%>%
  kruskal.test(`C31-C17d-C21-C21ac-C31a`~lifestage, data=.);test
```

There is no significant change in proportion C over development. 
