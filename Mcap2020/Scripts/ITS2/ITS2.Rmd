---
title: Montipora capitata 2020 ITS2 analysis
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("janitor" %in% rownames(installed.packages()) == 'FALSE') install.packages('janitor') 
if ("kableExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('kableExtra') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 

#load packages
library("ggplot2")
library('cowplot')
library("tidyverse")
library("janitor")
library("car")
library("kableExtra")
```

# Load data  

Load data obtained from SymPortal analysis on URI HPC cluster. Load relative abundance of ITS2 types for each sample.  

```{r}
its2<-read.csv(file="Mcap2020/Data/ITS2/relative_abundance_results.csv")

its2<-its2%>%
  rename(Sample=X, C=C31.C17d.C21.C21ac.C31a, D=D1.D4.D6.D1ab.D17d)%>%
  filter(!ITS2.type.profile=="Sequence accession / SymPortal UID")%>%
  filter(!ITS2.type.profile=="Average defining sequence proportions and [stdev]")

its2$C<-as.numeric(its2$C)
its2$D<-as.numeric(its2$D)

#calculate relative abundance such that proportions add up to 1 
its2<-its2%>%
  mutate(sum = rowSums(across(where(is.numeric))))%>%
  mutate(relC = C/sum)%>%
  mutate(relD = D/sum)%>%
  dplyr::select(Sample, relC, relD)%>%
  rename(C=relC, D=relD)

its2<-its2%>%
  gather(key=Clade, value=relabund, 2:3)

its2$Clade<-as.factor(its2$Clade)
its2$relabund<-as.numeric(its2$relabund)

its2<-its2%>%
  drop_na()

```

Load metadata.  

```{r}
metadata<-read.csv(file="Mcap2020/Data/ITS2/metadata.csv")
metadata<-metadata%>%
  dplyr::select(sample_name, tube.id, timepoint, lifestage, hpf, group)%>%
  rename(Sample=sample_name)
```

Merge metadata with data.  

```{r}
data<-left_join(its2, metadata, by="Sample")
```

# Plotting  

Plot the relative abundance of each sample displaying the lifestage.  

```{r}
plot<-data%>%
  ggplot(., aes(fill=Clade, y=relabund, x=Sample)) +
  facet_grid(~lifestage, scales="free_x")+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values=c("darkorange", "brown"))+
  theme_classic()+
  theme(panel.spacing.y = unit(-2, "lines")); plot

ggsave(plot, file="Mcap2020/Figures/ITS2/individual_relabund.png", width=16, height=6, dpi=300)
```

Plot with an average proportion D for each lifestage.  

```{r}
plot2<-data%>%
  group_by(lifestage)%>%
  filter(!lifestage=="Recruit1")%>%
  spread(Clade, relabund)%>%
  summarise(mean=mean(D), sd=sd(D), N=length(D), se=sd/sqrt(N))%>%
  ggplot(., aes(x = as.factor(lifestage), y = mean, group=lifestage)) +
    geom_point(aes(group=lifestage), pch = 21, size=6, alpha=0.8, position = position_dodge(0.3)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=lifestage), width=0, linetype="solid", position=position_dodge(0.3), size=1, color="black")+
    xlab("Lifestage") + 
    ylab("Relative Proportion D")+
    ylim(0,0.7)+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); plot2
```

Plot with an average proportion C for each lifestage.  

```{r}
plot3<-data%>%
  group_by(lifestage)%>%
  filter(!lifestage=="Recruit1")%>%
  spread(Clade, relabund)%>%
  summarise(mean=mean(C), sd=sd(C), N=length(C), se=sd/sqrt(N))%>%
  ggplot(., aes(x = as.factor(lifestage), y = mean, group=lifestage)) +
    geom_point(aes(group=lifestage), pch = 21, size=6, alpha=0.8, position = position_dodge(0.3)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=lifestage), width=0, linetype="solid", position=position_dodge(0.3), size=1, color="black")+
    xlab("Lifestage") + 
    ylab("Relative Proportion C")+
    ylim(0,0.7)+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); plot3
```

Create side by side plot.  

```{r}
data$group <- factor(data$group, levels = c("Egg", "Embryo", "Larvae", "Metamorphosed Recruit", "Attached Recruit"))

plot4<-data%>%
  filter(!lifestage=="Recruit1")%>%
  group_by(group, hpf, Clade)%>%
  summarise(mean=mean(relabund), sd=sd(relabund), N=length(relabund), se=sd/sqrt(N))%>%
  ggplot(., aes(x = as.factor(hpf), y = mean, fill=group, shape=Clade)) +
    geom_point(aes(group=interaction(hpf, group, Clade), colour=group, shape=Clade), size=6, alpha=0.8, position = position_dodge(0.7)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(hpf, group, Clade)), width=0, linetype="solid", position=position_dodge(0.7), size=1, color="black")+
    scale_fill_manual(name="Lifestage", values=c("#8C510A", "#DFC27D","#80CDC1", "#003C30", "#BA55D3"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#8C510A", "#DFC27D","#80CDC1", "#003C30", "#BA55D3"))+
    scale_shape_manual(values=c(16,5))+
    xlab("Hours Post Fertilization") + 
    ylab("Mean Relative Abundance")+
    ylim(0,0.7)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x = element_text(angle = 45, vjust=0.5)
      ); plot4

ggsave(plot4, file="Mcap2020/Figures/ITS2/relabund.png", width=10, height=6, dpi=300)
```


# Analysis  

Anova analysis for proportion D over lifestages (lifestage = combination of hpf and stage).  
```{r}
anova<-data%>%
      spread(Clade, relabund)%>%
     aov(D~lifestage, data=.)

summary(anova)

qqPlot(residuals(anova))
```

Anova analysis for proportion C over lifestages.  
```{r}
anova<-data%>%
      spread(Clade, relabund)%>%
     aov(C~lifestage, data=.)

summary(anova)

qqPlot(residuals(anova))
```


C and D proportions change across life stages.  

Display summary of C and D proportions.  

```{r}
data%>%
  group_by(lifestage, Clade)%>%
  summarise(mean=mean(relabund), n=length(relabund), stdev=sd(relabund), sterr=stdev/sqrt(n))%>%
  kbl(caption="Descriptive statistics of relative abundance")%>%
  kable_classic(full_width=FALSE, html_font="Arial")%>%
  row_spec(0, bold = TRUE) 

data%>%
  group_by(Clade)%>%
  summarise(mean=mean(relabund), n=length(relabund), stdev=sd(relabund), sterr=stdev/sqrt(n))%>%
  kbl(caption="Descriptive statistics of overall relative abundance")%>%
  kable_classic(full_width=FALSE, html_font="Arial")%>%
  row_spec(0, bold = TRUE) 
```

