---
title: Montipora capitata 2020 metabolomics analysis
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")
library("viridis")
library("ALASCA")

```


This script processes and prepares metabolomics data for analysis and conducts multivariate visualizations. The next step is conducting a WCNA in the `metabolomics_WGCNA.Rmd` script.  

# Data processing and exploration  

Data is provided for positive and negative polarities in separate files. In this script I process each polarity and then use polarity selection to generate a final dataframe of all metabolites.  

## Positive Polarity  

### Load data  
```{r}
#load datasets from two different run dates 
dataset1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

dataset2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data<-full_join(dataset1, dataset2)

#rename columns  
data<- data %>% 
  dplyr::rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30, 
    Recruit3plug_rep2 = Recruit.3_Plug_33, 
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38
    )

``` 
  
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data<- data %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE), 
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),          
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),            
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE), 
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE)
         )
```


Mutate the data to be in long rather than wide format.  

```{r}
data <- data %>% 
  gather(Sample, IonCounts, 71:123)

data <- data[c(9, 71,72)]
```

Add lifestage column for categorizing samples by lifestage.   

Here we are also removing samples extracted from 20201020. These samples were used for optimization of extractions and are not analyzed here due to differences in methods and batch effects. 
```{r}
data<-data%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data$Lifestage<-as.factor(data$Lifestage)

#remove samples that were from the earlier processing date - this is to remove any batch effects and only use samples that come from the largest run date
data<-data%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))


#add development column with larger categories 
data<-data%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                               if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage == "Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                               if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit", "NA"))))))))))))))

#add lifestage with hpf factor 
data<-data%>%
  mutate(HPF = if_else(Lifestage == "Egg", "Egg (1 hpf)", 
                               if_else(Lifestage =="Embryo", "Embryo (5 hpf)", 
                                       if_else(Lifestage == "Larvae1", "Embryo (38 hpf)", 
                                               if_else(Lifestage=="Larvae2", "Embryo (65 hpf)", 
                                               if_else(Lifestage=="Larvae3", "Larvae (93 hpf)", 
                                                       if_else(Lifestage == "Larvae4", "Larvae (163 hpf)",
                                                       if_else(Lifestage == "Larvae5", "Larvae (183 hpf)", 
                                                               if_else(Lifestage == "Larvae6", "Larvae (231 hpf)",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp (183 hpf)", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp (231 hpf)", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit (183 hpf)", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit (231 hpf)", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit (255 hpf)", "NA"))))))))))))))

data$HPF<-fct_relevel(data$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Metamorphosed Polyp (183 hpf)", "Attached Recruit (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting<-plyr::ddply(data, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_summary<-data_plotting[c(1,2,4)]

metab_compounds<-ggplot(data_summary, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds


```

This plot is not very useful due to high ion counts for some metabolites. We will instead use multivariate visualizations.  

### Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca<-data%>%
  spread(compound, IonCounts)

#remove columns with na's 
data_pca<-data_pca%>%
    select_if(~ !any(is.na(.)))

```

Plot PCA with lifestage in colors.  

```{r}
scaled.pca<-prcomp(data_pca[c(6:133)],scale=TRUE, center=TRUE) 

pcaPlot1<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="HPF", loadings=FALSE, colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

```

There are some interesting groupings by lifestage for positive polarity metabolites.  

## Negative Polarity  

Now repeat the process with negative polarity metabolites. 

### Load data
```{r}

#load data from both dates of runs 
data_neg1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

data_neg2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data_neg<-full_join(data_neg1, data_neg2)

#rename columns to be useful
data_neg<- data_neg %>% 
  dplyr::rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30,
    Recruit3plug_rep2 = Recruit.3_Plug_33,
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38)

```
 
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data_neg<- data_neg %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE),
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE),
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE))
```

Mutate the data to be in long rather than wide format.  

```{r}
data_neg <- data_neg %>% 
  gather(Sample, IonCounts, 71:123)

data_neg <- data_neg[c(9, 71, 72)]
```

Add lifestage column for categorizing lifestages.  

Here we are also removing samples extracted from 20201020. These samples were used for optimization of extractions and are not analyzed here due to differences in methods and batch effects. 
```{r}
data_neg<-data_neg%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data_neg$Lifestage<-as.factor(data_neg$Lifestage)

#remove samples from previous run date to remove any batch effects.  
data_neg<-data_neg%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))

data_neg<-data_neg%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                                if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage=="Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                                if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit", "NA"))))))))))))))

data_neg<-data_neg%>%
  mutate(HPF = if_else(Lifestage == "Egg", "Egg (1 hpf)", 
                               if_else(Lifestage =="Embryo", "Embryo (5 hpf)", 
                                       if_else(Lifestage == "Larvae1", "Embryo (38 hpf)", 
                                               if_else(Lifestage=="Larvae2", "Embryo (65 hpf)", 
                                               if_else(Lifestage=="Larvae3", "Larvae (93 hpf)", 
                                                       if_else(Lifestage == "Larvae4", "Larvae (163 hpf)",
                                                       if_else(Lifestage == "Larvae5", "Larvae (183 hpf)", 
                                                               if_else(Lifestage == "Larvae6", "Larvae (231 hpf)",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp (183 hpf)", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp (231 hpf)", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit (183 hpf)", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit (231 hpf)", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit (255 hpf)", "NA"))))))))))))))

data_neg$HPF<-fct_relevel(data_neg$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Metamorphosed Polyp (183 hpf)", "Attached Recruit (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")

data_neg$Development<-as.factor(data_neg$Development)

```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting_neg<-plyr::ddply(data_neg, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_summary_neg<-data_plotting_neg[c(1,2,4)]

metab_compounds_neg<-ggplot(data_summary_neg, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_neg

```

We will now visualize with multivariate methods.  

### Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca_neg<-data_neg%>%
  spread(compound, IonCounts)

#remove columns with na's 
data_pca_neg<-data_pca_neg%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA with lifestage in colors.  

```{r}
scaled.pca.neg<-prcomp(data_pca_neg[c(6:141)],scale=TRUE, center=TRUE) 

pcaPlot1_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1_neg

```

Generate a dataframe with normalized counts for positive and negative polarity datasets.  

```{r}
#merge two datasets such that mean in negative = "negative", and mean from positive = "positive". If not present, NA. 
data_summary_neg<-data_summary_neg%>%
    rename(Negative = mean)

data_summary<-data_summary%>%
    rename(Positive = mean)

#view normalized negative dataset
head(data_summary_neg)

head(data_summary)

#join datasets together
normalized_counts_pos_neg<-full_join(data_summary, data_summary_neg)

write_csv(normalized_counts_pos_neg, file="Mcap2020/Output/Metabolomics/normalized_counts_pos_neg.csv")
```

# Selecting metabolite polarity and generating final dataframe   

## Select polarity for each metabolite  

Use metabolite selection file to select polarity by averaging peaks across life stages for pos and neg peaks and choosing the strongest peaks. For example, if there is a higher ion count in the positive polarity than negative for that lifestage, only include the positive polarity data.  
 
```{r}
#data is positive and data_neg are negative dataframes  
data<-data%>%
  mutate(Polarity="Positive")

data_neg<-data_neg%>%
  mutate(Polarity="Negative")

data_full<-full_join(data, data_neg) #combine full positive and negative datasets

#change to wide format
data_full<-data_full%>%
  spread(Polarity, IonCounts)
```

Check for correlations between metabolites that have both positive and negative representation. We would expect that metabolites with higher ion counts will show higher counts across polarities.  

```{r}
correlation<-data_full

#only use complete observations
correlation<-correlation[complete.cases(correlation), ]
```

Display correlations for the metabolites with shared representation.  

```{r}
corrplots<-ggplot(data=correlation, aes(x=log(1+Positive), y=log(1+Negative)))+
  geom_point()+
  facet_wrap(~compound, scales="free")+
  geom_smooth(method='lm', color='red')+
  theme_classic()+
  theme(text=element_text(size=14, face="bold"));corrplots

ggsave("Mcap2020/Figures/Metabolomics/Correlation_plot.pdf", corrplots, width=20, height=16)
```

Relationship between positive and negative polarities are generally positive. Some of the relationships are stronger for certain metabolites and more variable for others.  

```{r}
#summarize across life stages and reps
polarity<-data_full%>%
  gather("Polarity", "IonCounts", 7:8)%>%
  group_by(Polarity, compound)%>%
  summarise(mean=mean(IonCounts, na.rm=TRUE))%>% #summarize across samples (lifestages)
  arrange(compound)%>% #list by compound
  replace_na(list(mean=0)) #replace NA with 0 to allow us to calculate higher values between polarities 

#add column of selected polarity based on stronger signal average
polarity<-polarity%>%
  spread(Polarity, mean)%>%
  mutate(Selection = ifelse(Negative > Positive, "Negative",
                     ifelse(Positive > Negative, "Positive", NA)))
  
```

Use the selected polarity key to select data for analysis.    

```{r}
#match selection column back onto original dataframe 
data_full$Selection<-polarity$Selection[match(data_full$compound, polarity$compound)] 

#pull out pos data
pos_peaks<-data_full%>%
  filter(Selection=="Positive")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Positive, Selection)%>%
  rename(value=Positive)
  
#pull out neg data
neg_peaks<-data_full%>%
  filter(Selection=="Negative")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Negative, Selection)%>%
  rename(value=Negative)

#rbind them together to generate a dataframe of positive and negative selected compounds
peaks_selected<-rbind(pos_peaks, neg_peaks)

peaks_selected<-peaks_selected %>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value) 
```

Add 1 to all values to account for 0 values and log transform.  
```{r}
hist(peaks_selected$value)

peaks_selected$log_norm_counts<-log10(1+peaks_selected$value)
hist(log(peaks_selected$log_norm_counts))
```

## Clean metabolite names and remove standards  

Remove PosIS and NegIS metabolites - these are internal standards that are not relevant for our samples. Clean any names that have (+HAc) and (+), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
grep("PosIS", levels(peaks_selected$compound)) #5 metabolites with PosIS, need to remove
grep("NegIS", levels(peaks_selected$compound)) #9 metabolites with NegIS, need to remove
grep("(HAc+)", levels(peaks_selected$compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(peaks_selected$compound)) #0 metabolites with SIM, need to rename

#HAC compounds are ones we want to keep, so we need to remove the compounds that dont use the HAc standards.  
#Glycerophosphocholine
#Phosphocholine
#CDP-Choline

peaks_selected<-peaks_selected%>%
  filter(!compound=="Glycerophosphocholine")
peaks_selected<-peaks_selected%>%
  filter(!compound=="Phosphocholine")
peaks_selected<-peaks_selected%>%
  filter(!compound=="CDP-Choline")

levels(peaks_selected$compound)

peaks_selected<-droplevels(peaks_selected)

length(levels(peaks_selected$compound)) #195 metabolites in data set before cleaning (removed the three from above)

peaks_selected_clean<-peaks_selected[!grepl("PosIS", peaks_selected$compound),] #remove POS
peaks_selected_clean<-peaks_selected_clean[!grepl("NegIS", peaks_selected_clean$compound),] #remove NEG
peaks_selected_clean<-droplevels(peaks_selected_clean)

length(levels(peaks_selected_clean$compound)) #181 metabolites in data set after cleaning (199-5-9=185), correct value

peaks_selected_clean<-peaks_selected_clean%>%
  mutate(compound = str_remove(compound, pattern=fixed('(+HAc)')))%>% #rename any with +HAc (would do the same here if you have SIM compounds)
  mutate(compound = as.factor(compound))

length(levels(peaks_selected_clean$compound))
levels(peaks_selected_clean$compound)
```

Output file to .csv.   

```{r}
peaks_selected_clean%>%
  rename(norm_counts=value)%>%
  write_csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")
```

# PCA of combined polarities  

Run PCA to view differences in life stages with combined data frame after normalization and polarity selection.   

Convert data to wide format. 

```{r}
data_pca_full<-peaks_selected_clean%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value)%>%
  spread(compound, value)

#remove columns with na's
data_pca_full<-data_pca_full%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA and view scree plot with lifestage in colors.   

```{r}
scaled.pca<-prcomp(data_pca_full[c(5:185)],scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)

pcaPlot_full<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, ,loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) +
  #scale_fill_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         #legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full

```

Show a panel of PCA by positive, negative, and combined datasets.   
```{r}
pca_pos<-pcaPlot1+theme(legend.position="none")
pca_neg<-pcaPlot1_neg+theme(legend.position="none")

pcaplots<-plot_grid(pca_pos, pca_neg, pcaPlot_full, labels = c("Positive", "Negative", "Combined"), ncol=3, nrow=1, rel_widths = c(0.8, 0.8, 1), label_size = 20, label_x = 0.1);pcaplots

ggsave(filename="Mcap2020/Figures/Metabolomics/All_PCAs.pdf", plot=pcaplots, dpi=300, width=20, height=5, units="in")
```  

There are groupings by lifestage that we will explore with PLS-DA analyses.  

## Conduct PERMANOVA by developmental time point  

Build PERMANOVA model.  
```{r}
fviz_eig(scaled.pca)

# scale data
vegan <- scale(data_pca_full[c(5:185)])

# PerMANOVA 
permanova<-adonis2(vegan ~ HPF, data = data_pca_full, method='eu')
permanova
```

Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = vegan ~ HPF, data = data_pca_full, method = "eu")
         Df SumOfSqs      R2      F Pr(>F)    
HPF      12   5361.8 0.64399 5.1252  0.001 ***
Residual 34   2964.2 0.35601                  
Total    46   8326.0 1.00000                 

# Pool size plots of individual metabolites across development 

peaks_selected_clean

```{r}
compound_list<-peaks_selected_clean%>%
  dplyr::select(compound)%>%
  unique()

compound_list<-c(levels(as.factor(compound_list$compound)))  

pool_size_plotting<-plyr::ddply(peaks_selected_clean, c("HPF", "compound"), summarise,
                N    = length(log_norm_counts[!is.na(log_norm_counts)]),
                mean = mean(log_norm_counts, na.rm=TRUE),
                sd   = sd(log_norm_counts, na.rm=TRUE),
                se   = sd / sqrt(N)
)

pool_size_plotting$HPF<-factor(pool_size_plotting$HPF, levels=c("Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)","Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)"))
  
# loop through each compound in the list and create a plot
for (metabolite in compound_list) {
  
  # subset the fractions dataset for the current compound
  compound_data <- subset(pool_size_plotting, compound == metabolite)
  
  abundance.plot <-  ggplot(compound_data, aes(x = HPF, y = mean)) + 
    geom_point(aes(), fill="black", color="black", pch=21, size=4) + 
    geom_line(group=1, color="black")+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.0)+
    theme_classic()+
    ggtitle(metabolite)+
    ylab("Pool Size (log intensity)")+
    xlab("Lifestage")+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.text.x=element_text(color="black", size=12, hjust=1, angle=45),
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"), 
      legend.position="none"
    )
  
ggsave(filename=paste0("Mcap2020/Figures/Metabolomics/abundance_plots/", metabolite, ".jpeg"), plot=abundance.plot, width=6, height=6, units="in")

}
```

# PLS-DA analysis  

Load data if starting from this point in the script.    

```{r}
metabolites <- read.csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")
```

log_norm_count indicates normalized ion counts that are log transformed for analysis.   

## Generate PLS-DA for lifestage timepoint    

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- metabolites%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

levels(as.factor(X$HPF))

X$HPF<-fct_relevel(X$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)","Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")

levels(as.factor(X$HPF))

Y <- as.factor(X$HPF) #select treatment names
Y

X<-X[5:185] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y) # 1 Run the method
plotIndiv(MyResult.plsda)    # 2 Plot the samples
plotVar(MyResult.plsda, cutoff = 0.7)    

levels(Y)

lifestage_cols<-c("#8C510A", #eggs
                  "#DFC27D", "#DAB869", "#E4CC91", #embryos
                  "#80CDC1", "#5BBFAF", "#6EC6B8", "#92D4CA", #larvae
                  "#003C30", "#00231C", #polyp
                  "#BA55D3","#B241CE", "#A632C3") #recruits
            

#Egg: "#8C510A", 
#Embryo: "#DFC27D", "#DAB869", "#E4CC91", "#D5AF54"
#Larvae: "#80CDC1", "#5BBFAF", "#6EC6B8", "#92D4CA"
#Polyp Metamorphosed: "#003C30", "#00231C", "005644", "006F59"
#Recruit Attached: "#BA55D3", "B241CE", "A632C3"

pch.input = c(1, 2, 3, 4, 5, 6, 7 ,8, 9, 10, 11, 12, 13)

pdf("Mcap2020/Figures/Metabolomics/PLSDA_Lifestage.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=lifestage_cols, ind.names = FALSE, legend=TRUE, legend.title = "Lifestage", ellipse = FALSE, title="", pch=pch.input, style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=lifestage_cols, ind.names = FALSE, legend=TRUE, legend.title = "Lifestage", ellipse = TRUE, title="", pch=pch.input, style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)

pdf("Mcap2020/Figures/Metabolomics/CIM_Lifestage.pdf", width=35, height=7)
cim(MyResult.plsda, mapping="Y", row.names = metabolites$HPF, xlab = "Metabolites", ylab="Lifestage", margins=c(10,10), row.cex=0.5)
dev.off()
```

```{r, message=FALSE}
MyResult.plsda_timepoint <- plsda(X,Y, ncomp=9) #number of components is classes-1
```


# Extract VIP scores from PLS-DA's

View the metabolites that are most highly differentiating metabolites.     

```{r}
#extract
Timepoint_VIP <- PLSDA.VIP(MyResult.plsda_timepoint)
Timepoint_VIP_DF <- as.data.frame(Timepoint_VIP[["tab"]])
Timepoint_VIP_DF

# Converting row names to column
Timepoint_VIP_table <- rownames_to_column(Timepoint_VIP_DF, var = "Metabolite")

#filter for VIP > 1
Timepoint_VIP_1 <- Timepoint_VIP_table %>% 
  filter(VIP >= 1)

write_csv(Timepoint_VIP_1, "Mcap2020/Output/Metabolomics/Overall_Timepoint_VIPs.csv")

#plot
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Lifestage VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("Mcap2020/Figures/Metabolomics/Lifestage_VIP.pdf", width=6, height=11)
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Lifestage VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation in lifestage. 

# Plot VIPs concentration across lifestages 

```{r}
vip_list<-c(levels(as.factor(Timepoint_VIP_1$Metabolite)))

metabolites$HPF<-fct_relevel(metabolites$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)",  "Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)",  "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")

timepoint_plot1<- metabolites %>%
 filter(compound %in% vip_list)%>%
  filter(compound %in% c("Lumichrome", "Hypoxanthine", "Hypotaurine", "GTP"))%>%
  
  group_by(HPF, compound)%>%
  summarise(mean_count = mean(log_norm_counts))%>%
  arrange(HPF, compound)%>%
  group_by(compound)%>%
  mutate(rel_change=((mean_count-dplyr::first(mean_count))/dplyr::first(mean_count)))%>%
  arrange(compound)%>%
  #filter(rel_change<0)%>%
  
  ggplot(aes(x = HPF, y = reorder(compound,rel_change))) +
  geom_point(aes(colour=rel_change), size=3) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  ylab("Metabolite") +
  xlab("Lifestage") +
  geom_vline(xintercept=1.5, linetype="dashed")+
  geom_vline(xintercept=4.5, linetype="dashed")+
  geom_vline(xintercept=10.5, linetype="dashed")+
  theme_bw() + 
  theme(panel.border = element_rect(linetype = "solid", color = "black"), 
        panel.grid.major = element_blank(), #Makes background theme white
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text.x = element_text(angle = 45, hjust=1)); timepoint_plot1

timepoint_plot2<- metabolites %>%
  filter(compound %in% c("N-octanoylglycine", "Nicotinamide riboside", "Methionine", "Pterin", "Phenylalanine", "ATP", "Tryptophan", "Thiamine", "5-Methylcytosine"))%>%
  
  group_by(HPF, compound)%>%
  summarise(mean_count = mean(log_norm_counts))%>%
  arrange(HPF, compound)%>%
  group_by(compound)%>%
  mutate(rel_change=((mean_count-dplyr::first(mean_count))/dplyr::first(mean_count)))%>%
  arrange(compound)%>%
  
  
  ggplot(aes(x = HPF, y = reorder(compound,rel_change))) +
  geom_point(aes(colour=rel_change), size=3) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  ylab("Metabolite") +
  xlab("Lifestage") +
  geom_vline(xintercept=1.5, linetype="dashed")+
  geom_vline(xintercept=4.5, linetype="dashed")+
  geom_vline(xintercept=10.5, linetype="dashed")+
  theme_bw() + 
  theme(panel.border = element_rect(linetype = "solid", color = "black"), 
        panel.grid.major = element_blank(), #Makes background theme white
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text.x = element_text(angle = 45, hjust=1)); timepoint_plot2

timepoint_plot3<- metabolites %>%
  filter(compound %in% vip_list)%>%
  filter(compound %in% c("Norvaline", "Guanine", "GMP", "Carbamoyl phosphate", "Glutaryl-carnitine", "Hippuric acid", "Glucuronic acid", "L-Octanoylcarnitine", "Glutamine", "Coenzyme A", "1-Methylimidazole acetic acid", "5-Methylthioadenosine", "Porphobilinogen", "4-Aminobutyrate"))%>%
  
  group_by(HPF, compound)%>%
  summarise(mean_count = mean(log_norm_counts))%>%
  arrange(HPF, compound)%>%
  group_by(compound)%>%
  mutate(rel_change=((mean_count-dplyr::first(mean_count))/dplyr::first(mean_count)))%>%
  arrange(compound)%>%
  
  
  ggplot(aes(x = HPF, y = reorder(compound,rel_change))) +
  geom_point(aes(colour=rel_change), size=3) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  ylab("Metabolite") +
  xlab("Lifestage") +
  geom_vline(xintercept=1.5, linetype="dashed")+
  geom_vline(xintercept=4.5, linetype="dashed")+
  geom_vline(xintercept=10.5, linetype="dashed")+
  theme_bw() + 
  theme(panel.border = element_rect(linetype = "solid", color = "black"), 
        panel.grid.major = element_blank(), #Makes background theme white
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text.x = element_text(angle = 45, hjust=1)); timepoint_plot3


timepoint_plot4<- metabolites %>%
  filter(compound %in% vip_list)%>%
  filter(!compound %in% c("Norvaline", "Guanine", "GMP", "Carbamoyl phosphate", "Glutaryl-carnitine", "Hippuric acid", "Glucuronic acid", "L-Octanoylcarnitine", "Glutamine", "Coenzyme A", "1-Methylimidazole acetic acid", "Porphobilinogen", "4-Aminobutyrate", "5-Methylthioadenosine", "N-octanoylglycine", "Nicotinamide riboside", "Methionine", "Pterin", "Phenylalanine", "ATP", "Tryptophan", "Thiamine", "5-Methylcytosine","Lumichrome", "Hypoxanthine", "Hypotaurine", "GTP"))%>%
  
  group_by(HPF, compound)%>%
  summarise(mean_count = mean(log_norm_counts))%>%
  arrange(HPF, compound)%>%
  group_by(compound)%>%
  mutate(rel_change=((mean_count-dplyr::first(mean_count))/dplyr::first(mean_count)))%>%
  arrange(compound)%>%
  
  
  ggplot(aes(x = HPF, y = reorder(compound,rel_change))) +
  geom_point(aes(colour=rel_change), size=3) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  ylab("Metabolite") +
  xlab("Lifestage") +
  geom_vline(xintercept=1.5, linetype="dashed")+
  geom_vline(xintercept=4.5, linetype="dashed")+
  geom_vline(xintercept=10.5, linetype="dashed")+
  theme_bw() + 
  theme(panel.border = element_rect(linetype = "solid", color = "black"), 
        panel.grid.major = element_blank(), #Makes background theme white
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text.x = element_text(angle = 45, hjust=1)); timepoint_plot4

#save plots
ggsave("Mcap2020/Figures/Metabolomics/VIPs/vip_change_1.png", timepoint_plot1, width=6, height=3)
ggsave("Mcap2020/Figures/Metabolomics/VIPs/vip_change_2.png", timepoint_plot2, width=6, height=4)
ggsave("Mcap2020/Figures/Metabolomics/VIPs/vip_change_3.png", timepoint_plot3, width=6, height=4)
ggsave("Mcap2020/Figures/Metabolomics/VIPs/vip_change_4.png", timepoint_plot4, width=6, height=8)
```

## Plot VIP concentration across life stages in heatmap 

Plot heatmap of z score of metabolites across life stages.  

```{r}
library(ComplexHeatmap)
library(circlize)
library(tibble)

# Filter data for VIP metabolites
vip_data <- metabolites %>% filter(compound %in% vip_list)

# Convert counts to Z-scores
vip_data <- vip_data %>% 
  group_by(compound) %>% 
  mutate(z_score = scale(log_norm_counts)) %>% 
  group_by(HPF, compound)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- vip_data %>% 
  dplyr::select(compound, HPF, z_score) %>%
  spread(key = HPF, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "compound"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_split=10,
  row_title = "Metabolite", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("Mcap2020/Figures/Metabolomics/VIPs/VIP_heatmap_development.pdf", width=9, height=15)
draw(heatmap)
dev.off()
```










# List VIPs related to pathways that are enriched from Metaboanalyst 

From Analysis_Report_metaboanalyst_enrichment_KEGG_20240520.pdf in Output/Metabolomics/development_VIPs at FDR < 0.05 

Metabolites are those identified as being included in our dataset 

## All VIPS input to Metaboanalyst for enrichment 

Input listed first, with Metaboanalyst hit in parentheses 

O-Butanoylcarnitine (Butyrylcarnitine)
Glutaryl-carnitine (Glutarylcarnitine)
Arginine-Glutamine (Arginylglutamine)
Deoxycarnitine (4-Trimethylamminiobutanoic acid)
N-carbomoyl-L-aspartate (Ureidosuccinic acid)
Deoxyadenosine
5-Methylcytosine
Raffinose
Glucose (D-Glucose)
L-Octanoylcarnitine (Octanoylcarnitine)
Creatinine
Lysine-Glutamine (Lysylglutamine)
Malate (Malic acid)
Guanidinoacetate (Guanidoacetic acid)
AMP (Adenosine monophosphate)
Uric acid
Serine
Arginine-Valine (Arginylvaline)
Hypotaurine
Asparagine (L-Asparagine)
Guanine
Phenethylamine
Cyclic AMP
Thiamine
Histidine
Hypoxanthine
2-Hydroxyglutarate
Glutamine
Nicotinamide riboside
N-acetyl-L-ornithine (N2-Acetylornithine)
NADH
Cellobiose
Norvaline
Indole
Orotate
Phosphocholine 
Nicotinate (Nicotinic acid)
Fructose (D-Fructose)
5-Methylthioadenosine (5'-Methylthioadenosine)
UMP (Uridine 5'-monophosphate)
Uridine
Ornithine
Glucuronic acid (D-Glucuronic acid)
Cytosine
L-Palmitoylcarnitine
ADP-D-Glucose (ADP-glucose)
Carnitine (L-Carnitine)
Montiporic Acid C (no match)
Montiporic Acid D (no match)
Nicotinamide ribotide
Montiporic Acid A (no match)
Montiporic Acid B (no match)
Tryptophan (L-Tryptophan)
a-ketoglutarate (Oxoglutaric acid)
Dihydroxyacetone phosphate
N-octanoylglycine (Capryloylglycine)
Porphobilinogen
GMP (Guanosine monophosphate)
Citrate
ADP
Thymidine
1-Methylimidazole acetic acid (Methylimidazoleacetic acid)
ADP-ribose (Adenosine diphosphate ribose)
Carbamoyl phosphate
Cresol (p-Cresol)
Itaconic acid
Phenylalanine
Isoleucine
4-Aminobutyrate (gamma-Aminobutyric acid)
Pterin
Hippuric acid
GTP (Guanosine triphosphate)
ATP (Adenosine triphosphate)
Glutamate (Glutamic acid) 
Glucose-6-phosphate
Methionine
Coenzyme A
Succinate
Lumichrome (no match)

## Arginine biosynthesis

Metabolites: 

Glutamate (Glutamic acid)
N-acetyl-L-ornithine (N2-Acetylornithine)
Carbamoyl phosphate
Ornithine
Glutamine
a-ketoglutarate (Oxoglutaric acid)






LEFT OFF HERE RENAMING 

## Alanine, aspartate, and glutamate metabolism 

Metabolites: 

Asparagine (L-Asparagine)
Glutamic acid
gamma-Aminobutric acid
Glutamine
Citric acid
Ureidosuccinic acid
Succinic acid
Oxoglutaric acid
Carbamoyl phosphate 

## Butanoate metabolism

Metabolites:  

gamma-Aminobutryic acid
Glutamic acid
Oxoglutaric acid
Succinic acid
2-Hydroxyglutarate

## Purine metabolism

Metabolites:  

Glutamine
ADP
Adenosine triphosphate
Adenosine monophosphate
Deoxyadenosine
Deoxyadenosine
Guanosine monophosphate
Hypoxanthine
Guanine
Guanosine triphosphate
Adenosine diphosphate ribose
Uric acid


## Pyrimidine metabolism

Metabolites:  

Glutamine
Carbamoyl phosphate
Uridine 5'-monophosphate
Uridine
Thymidine
Ureidosuccinic acid
Orotic acid 


## Nitrogen metabolism

Metabolties:  

Glutamic acid
Carbamoyl phosphate
Glutamine

## Neomycin, kanamycin, and gentamycin biosynthesis

D-Glucose
Glucose-6-phosphate

This one doesn't make much sense.... 

## Glyoxylate and dicarboxylate metabolism

Metabolites: 

Citric acid
Malic acid
Serine
Glutamic acid
Glutamine

## Starch and sucrose metabolism 

Cellobiose
D-Fructose
Glucose-6-phosphate
D-Glucose

## Citrate cycle (TCA cycle)

Oxoglutaric acid
Succinic acid
Malic acid
Citric acid 

# Plotting KEGG pathway enrichment results from Metaboanalyst 

Read in results obtained from Metaboanalyst 

```{r}
kegg<-read_csv("Mcap2020/Output/Metabolomics/Metaboanalyst/development_VIPs/metaboanalyst_KEGG_enrichment_statistics_20240618.csv")
```

Plot with enrichment ratio on the X axis and p-value as the color. Only for pathways at FDR < 0.05.   

```{r}
kegg_plot1 <- kegg %>% 
  dplyr::arrange(Enrichment_Ratio) %>%
  filter(FDR<0.05)%>%
  
  ggplot(aes(x=Enrichment_Ratio, y=reorder(pathway, Enrichment_Ratio), fill=FDR, colour=FDR, size=Enrichment_Ratio)) +
  geom_point(aes(group=pathway))+
  geom_segment(aes(x=0, xend=Enrichment_Ratio, y=pathway, yend=pathway),size=1) +
  scale_colour_gradientn(name = "FDR", colours = colorspace::heat_hcl(7))+
  scale_fill_gradientn(name = "FDR", colours = colorspace::heat_hcl(7))+
  scale_size(name="Enrichment Ratio", range = c(1, 5))+
  theme_classic() +
  ylab("KEGG")+
  xlab("Enrichment Ratio (Hits/Expected)")+
  theme(legend.position = "right",
        axis.text.y = element_text(size=12),
        axis.title.y = element_text(size=16, face="bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 16, face = "bold"), 
        strip.text.y.right=element_text(angle=0, size=12), 
        legend.title=element_text(size=14),
        axis.text.x = element_text(size=12),
        legend.text=element_text(size=10)); kegg_plot1

ggsave("Mcap2020/Figures/Metabolomics/VIPs/KEGG_enrichment_plot.png", kegg_plot1, width=10, height=6)
```

Neomycin is just glucose and G6P?? A bit confusing on why its so enriched.... 


# Pathways that I am interested in 

## GS GOGAT

Glutamine
Glutamate
a-ketoglutarate 

## Glycolysis/gluconeo

Glucose 
Glucose-6-phosphate
Fructose-6-phosphate
Pyruvate

ADD MORE HERE 

## TCA cycle 

## Urea cycle

## Dipeptides 

## Symbiont derived amino acids 

## Storage carbs (starch, sucrose) 

## Lipids/glyoxylate cycle 


# ASCA analysis 

## Run model 

Format data and run model. 
```{r}
head(metabolites)

asca_data<-metabolites%>%
  filter(compound %in% vip_list)%>%
  select(HPF, compound, Rep, log_norm_counts)%>%
  mutate(ID=paste(HPF, Rep))%>%
  rename(variable=compound)%>%
  rename(value=log_norm_counts)

head(asca_data)
```

Run model. 
```{r}
res <- ALASCA(
  asca_data, #dataframe
  value ~ HPF, #set model
  n_validation_runs = 100, #bootstrap 100 times; takes about 10 min to run 
  validate = TRUE, #bootstrap
  scale_function = "sdall", #divide column value by standard deviation of all samples after scale/centering
  reduce_dimensions = TRUE #reduce variables to highest explanatory value
)
```

View scree plot. 
```{r}
plot(res, component = seq(1,10), effect = 1, type = 'scree')
```
PCs 1, 2, and 3 have >10% variance explained. 

## Plot results 

How to pick a PC loading threshold to assign metabolites to a PC??? How many n_limit??

PC1 33.06% - metabolites that either increase or decrease across development. 
```{r}
plot(res, effect = 1, component = 1, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```
Positive loadings = increase with development; negative loadings = decrease with development. 

```{r}
plot(res, effect = 1, component = 1, type = 'prediction', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```

PC2 25.26%
```{r}
plot(res, effect = 1, component = 2, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```
Positive loadings = highest in early and late, lowest in mid. Negative loadings = highest in mid. 

```{r}
plot(res, effect = 1, component = 2, type = 'prediction', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```

PC3 14.35%
```{r}
plot(res, effect = 1, component = 3, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```
Positive loadings = highest in mid and eggs. Negative loadings = lowesr in mid and eggs. 

```{r}
plot(res, effect = 1, component = 3, type = 'prediction', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 45, x_h_just= 1,
     flip_axis=TRUE,
     palette = lifestage_cols,
     my_theme = theme_classic())
```

PC4 6.58% (unclear effects) - only analyzing PC1-3 due to high variance explained. 


Use these to keep PC1 increasing (late), decreasing (early), and PC2 for peak in mid (mid) - assign metabolite to highest scoring PC 

## Extract gene lists for PC1, PC2, and PC3 

How to determine which to include in the list of loadings???
Check for no overlap b/t PC's? 

```{r}
loadings1<-get_loadings(res, component=1, effect=1, n_limit=10)
loadings1<-as.data.frame(loadings1)

loadings2<-get_loadings(res, component=2, effect=1, n_limit=10)
loadings2<-as.data.frame(loadings2)

loadings3<-get_loadings(res, component=3, effect=1, n_limit=10)
loadings3<-as.data.frame(loadings3)

loadings<-rbind(loadings1, loadings2, loadings3)

loadings%>%arrange(covars)
```

Some metabolites are present on all 3 PC's - need to figure out how to deal with this part 

Try with DEG clusters - didn't really like this one, missed a lot of metabolites  

```{r}
library(DEGreport)

head(asca_data)

clustering <- asca_data #metabolites in rows, stats in columns

matrix<-clustering%>%
  dplyr::select(variable, value, ID)%>%
  pivot_wider(names_from=ID, values_from=value)%>%
  as.data.frame()

rownames(matrix)<-matrix$variable #metabolites in row names, sample ID in columns 

meta <- asca_data %>%
  dplyr::select(ID, HPF)%>%
  unique()%>%
  as.data.frame()#sample id and lifestage column

rownames(meta)<-meta$ID

meta<-meta%>%
  dplyr::select(HPF) #sample ID in rows, one column of lifestage 
```

```{r}
patterns <- degPatterns(matrix, metadata = meta, time = "HPF", col=NULL, plot=FALSE, minc = 5)
```

```{r}
dev.off()
cluster_plot<-ggplot(patterns[["normalized"]],
        aes(x=HPF, y=value)) +
  facet_wrap(~ cluster)+
   geom_point(colour="darkgray", size=1) +
  ylab("Z-score of normalized pool size")+
  xlab("")+
   # change the method to make it smoother
   geom_smooth(aes(group=genes), method = "loess", colour="red", linewidth=0.1, se=FALSE)+
   geom_smooth(aes(group=1), method = "loess", colour="black")+
  geom_hline(yintercept=0, linetype="dashed")+
  geom_vline(xintercept=3, linetype="dotted")+
  geom_vline(xintercept=6, linetype="dotted")+
  theme_classic()+
  theme(
    axis.text.x = element_text(angle=90, hjust=1, vjust=1)
  );cluster_plot
```

```{r}
group <- patterns$df %>%
          rename(metabolite=genes)

nmetab<-patterns$summarise%>%
  as.data.frame()

nmetab<-nmetab%>%dplyr::select(cluster, n_genes)%>%unique()

nmetab
```

8 metabolites in cluster 3 (mid), 15 metabolites in cluster 4 (early), 12 metabolites in cluster 8 (late), and 7 metabolites in cluster 7 (late)

```{r}
group%>%filter(cluster=="3")
group%>%filter(cluster=="4")
group%>%filter(cluster=="8")
group%>%filter(cluster=="11")
```

