---
title: Early life history respirometry (photosynthesis & respiration) analysis and plotting
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---
This script analyzes and plots data for M. capitata 2020 life history time series project. 

# **Setup**  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('effects')
library('emmeans')
library('multcomp')
library(FSA)
library(rcompanion)
```

# **Data visualization and manipulation**  

Load data for P and R rates generated from LoLinR script `Respirometry_Extraction.Rmd`.      
```{r, warning=FALSE, message=FALSE}
PRdata<-read.csv("Mcap2020/Output/Respiration/oxygen_P_R_calc.csv") #load data
```

Separate data for this project (remove "Juveniles" from this dataset from a separate project). 
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that were not either samples or blanks
PRdata<-PRdata[!is.na(PRdata$Type),]

#format columns as factor
PRdata$dpf<-as.factor(PRdata$dpf)
```

Examine outliers for respiration data. 
```{r}
#remove any respiration values that were above 0 (respiration is oxygen consumption, so we expect values less than 0 for negative rates)
plot(PRdata$R.nmol.org.min)
#PRdata<-PRdata%>%filter(R.nmol.org.min < 0)

#remove any respiration values that were outliers
PRdata<-PRdata%>%filter(R.nmol.org.min > -0.15)
plot(PRdata$R.nmol.org.min)
```
Outliers are removed and values are removed where respiration is >0. Respiration is oxygen consumption, so we expect values less than 0 for negative rates.  

Replace net negative oxygen values for photosynthesis measurements with 0, indicating no photosynthesis. Replace net positive oxygen values with 0 for respiration, indicating no respiration. Calculate respiration as the inverse to display positive values for oxygen production. 
```{r}
PRdata<-PRdata%>%
  mutate(R.nmol.org.min=if_else(R.nmol.org.min>0, 0, R.nmol.org.min))%>%
  mutate(P.nmol.org.min=if_else(P.nmol.org.min<0, 0, P.nmol.org.min))%>%
  mutate(GP.nmol.org.min=if_else(GP.nmol.org.min<0, 0, GP.nmol.org.min))%>%
  mutate(R.nmol.org.min=R.nmol.org.min*-1)
```

Plot. 
```{r}
boxplot(PRdata$R.nmol.org.min)
boxplot(PRdata$P.nmol.org.min)
boxplot(PRdata$GP.nmol.org.min)
```

Calculate a gross photosynthesis : respiration (P:R) ratio. This calculation will provide a ratio that will show the amount of oxygen produced compared to consumed, which is an indicator of energy availability. A ratio >1 indicates more photosynthesis than respiration and a ratio <1 indicates less photosynthesis than respiration.   

Examine plot of data to look for outliers.  
```{r, warning=FALSE, message=FALSE}
PRdata$ratio<-PRdata$GP.nmol.org.min/PRdata$R.nmol.org.min #calculate ratio with absolute values of gross photosynthesis and respiration

#remove outliers detected by values of P:R ratio data
plot(PRdata$ratio)
```

```{r}
PRdata<-PRdata%>%filter(ratio > 0)
plot(PRdata$ratio)
```

# **Analysis and plotting of P and R**  

Load sample metadata to identify lifestage and developmental time.   

```{r}
metadata<-read.csv("Mcap2020/Data/Respiration/PR_metadata.csv") #load metadata file

PRdf<-PRdata%>%
  filter(!Lifestage=="Juvenile") #remove "Juvenile" samples from a different project 

#match in sample information from metadata to our data frame 
PRdf$code<-paste(PRdf$Date, PRdf$Lifestage)
metadata$code<-paste(metadata$Date, metadata$Lifestage)
PRdf$hpf<-metadata$hpf[match(PRdf$code, metadata$code)]
PRdf$group<-metadata$group[match(PRdf$code, metadata$code)]
PRdf$hpf<-as.factor(PRdf$hpf)
```

Add in lifestage identifiers that match all other datasets.   
```{r}
lifestages<-read.csv("Mcap2020/Data/lifestage_metadata.csv")

#remove spaces in lifestage group identifiers to match the respiration data set and then use this key to add in new lifestage names 
lifestages$code<-gsub(" ", "", lifestages$code)
PRdf$lifestage_std<-lifestages$lifestage[match(PRdf$group, lifestages$code)]

#arrange order of factor 
PRdf$lifestage_std<-factor(PRdf$lifestage_std, levels=c("Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)", "Metamorphosed Polyp (231 hpf)"))
```

Read in mean larval volume and normalize all values to the group mean for that life stage. 

```{r}
size<-read_csv(file="Mcap2020/Output/Physiology/larval_volume_table.csv")
size$Lifestage<-as.factor(size$Lifestage)

PRdf$size<-size$Mean[match(PRdf$lifestage_std, size$Lifestage)]
```

Add columns for normalizing R and GP to size and then calculating size normalized PR ratios.  
```{r}
PRdf<-PRdf%>%
  mutate(R.nmol.mm3.min=R.nmol.org.min/size)%>%
  mutate(GP.nmol.mm3.min=GP.nmol.org.min/size)%>%
  mutate(PR_size=GP.nmol.mm3.min/R.nmol.mm3.min)
```

## Respiration  

Plot respiration data as a boxplot.    
```{r}
r_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = (R.nmol.org.min))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); r_plot
```

Plot size normalized data. 
```{r}
r_plot_size<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = (R.nmol.mm3.min))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " mm"^-3, "min"^-1, ")")))) +
    #scale_y_continuous(limits=c(-0.07, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); r_plot_size
```

## Photosynthesis (Net)  

Plot data as a box plot. Net photosynthesis is excess oxygen production after subtracting the oxygen consumed (respiration).     
```{r}
p_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = P.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste(P[Net], " (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    xlab("")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); p_plot
```

## Photosynthesis (Gross)  

Plot data as a boxplot. Plot gross photosynthesis, which is net photosynthesis rates plus the oxygen consumed through respiration.     
```{r}
gp_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = GP.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position=position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste(P[Gross], " (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.11), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); gp_plot
```

Plot by size. 
```{r}
gp_plot_size<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = GP.nmol.mm3.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position=position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste(P[Gross], " (nmol ", O[2], " mm"^-3, "min"^-1, ")")))) +
    #scale_y_continuous(limits=c(-0.07, 0.11), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); gp_plot_size
```

## P:R Ratio  

Plot data as a box plot.    
```{r}
pr_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = ratio)) +
    geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    scale_y_continuous(limits=c(-0.5, 5), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=16),
      legend.text=element_text(size=14), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); pr_plot
```

Plot for size normalized. 
```{r}
pr_plot_size<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = PR_size)) +
    geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    scale_y_continuous(limits=c(-0.5, 5), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=16),
      legend.text=element_text(size=14), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); pr_plot_size
```

## Generate final figure for manuscript.  

Plot panel of all figures with boxplots.   
```{r}
#edit asthetics for stacking plots 
r_plot2<-r_plot + theme(axis.text.x=element_blank(), legend.position="top")
p_plot2<-p_plot + theme(axis.text.x=element_blank(), legend.position="none")
gp_plot2<-gp_plot + theme(axis.text.x=element_blank(), legend.position="none")
pr_plot2<-pr_plot + theme(legend.position="none")

full_fig<-plot_grid(r_plot2, p_plot2, gp_plot2, pr_plot2, labels=c("A", "B", "C", "D"), label_size=20, ncol=1, nrow=4, rel_heights= c(1,1,1,1), rel_widths = c(0.8,0.8,0.8,1.1), label_y=1, align="v")

ggsave(filename="Mcap2020/Figures/Respiration/respirometry_panel.png", plot=full_fig, dpi=300, width=6, height=20, units="in")
```

Plot panel of all figures with boxplots by size normalized.   
```{r}
#edit asthetics for stacking plots 
r_plot_size2<-r_plot_size + theme(axis.text.x=element_blank(), legend.position="top")
gp_plot_size2<-gp_plot_size + theme(axis.text.x=element_blank(), legend.position="none")
pr_plot_size2<-pr_plot_size + theme(legend.position="none")

full_fig_size<-plot_grid(r_plot_size2, gp_plot_size2, pr_plot_size2, labels=c("A", "B", "C"), label_size=20, ncol=1, nrow=3, rel_heights= c(0.8,0.8,1.1),  label_y=1, align="v")

ggsave(filename="Mcap2020/Figures/Respiration/respirometry_panel_size.png", plot=full_fig_size, dpi=300, width=6, height=14, units="in")
```

Plot P, R and PR ratio into one panel plot. Plot gross photosynthesis and respiration data with all data points to show variability. Plot mean P:R ratio overlayed on these points.   
```{r}
#calculate mean P:R ratio
stats<-PRdf%>%
  group_by(group, lifestage_std, Lifestage, hpf)%>%
  summarise(meanPR=mean(ratio, na.rm=TRUE), sePR=sd(ratio, na.rm=TRUE)/sqrt(length(ratio)), nPR=length(ratio), ymin=meanPR-sePR, ymax=meanPR+sePR) 

combined_plot<-PRdf %>%
  
    ggplot(., aes(x = lifestage_std, y = R.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_hline(yintercept=0.05, linetype="dotted", color="black", size=0.75)+
  
    #add respiration
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 22, alpha=0.4, size=4, position = position_jitterdodge(0.1)) + 
  
   #add photosynthesis mean with error bars 
  geom_point(aes(y=GP.nmol.org.min, colour=Lifestage, group=group), fill="white", pch = 21, size=4, position = position_jitterdodge(0.1)) +
  
  #add PR with secondary axis 
  scale_y_continuous(limits=c(-0.2, 0.2), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'), sec.axis = sec_axis(~.*20, name="P:R"))+
  geom_point(data=stats, aes(y=meanPR/20, colour=Lifestage, fill=Lifestage, group=group),  pch = 23, size=6, position = position_dodge(0.8)) +
     geom_errorbar(data=stats, aes(y=meanPR/20, x=lifestage_std, ymin=ymin/20, ymax=ymax/20, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); combined_plot

#create a dummy plot to create a legend for the plot above

Lifestage <- c("Embryo", "Embryo", "Embryo", "Larvae", "Larvae", "Larvae", "Metamorphosed Polyp", "Metamorphosed Polyp", "Metamorphosed Polyp")
Metric <- c("Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R")
Dummy <- c(1, 2, 3, 4, 5, 6, 7, 8, 9)
df <- data.frame(Lifestage, Metric, Dummy)


legend_plot<-df %>%
  
    ggplot(., aes(x = Lifestage, y = Dummy, colour=Lifestage, shape=Metric)) +
    geom_point(aes(), alpha=1, size=4)+
    #scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"))+
    scale_colour_manual(name=expression(bold("Lifestage")), values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"), guide="none")+
  scale_shape_manual(name=expression(bold("")), values=c(15, 21, 18), labels=c("Respiration", "Photosynthesis", "P:R"))+
  theme_classic()+
  theme(legend.position="top")

legend<-get_legend(legend_plot)

combined_full<-plot_grid(legend, combined_plot, nrow=2, ncol=1, rel_widths=c(1, 1), rel_heights=c(0.3, 1))
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_PR.png", combined_full, dpi=300, w=5, h=7, units="in")
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_PR.pdf", combined_full, dpi=300, w=5, h=7, units="in")
```

Plot P R and PR ratio in one plot showing only means and std. error for all metrics.  

```{r}
stats<-PRdf%>%
  dplyr::select(Lifestage, lifestage_std, group, hpf, R.nmol.org.min, GP.nmol.org.min, ratio)%>%
  gather(key="Metric", value="Value", R.nmol.org.min:ratio)%>%
  mutate(Metric=if_else(Metric=="R.nmol.org.min", "Respiration", Metric))%>%
  mutate(Metric=if_else(Metric=="GP.nmol.org.min", "Gross Photosynthesis", Metric))%>%
  mutate(Metric=if_else(Metric=="ratio", "P:R Ratio", Metric))%>%
  group_by(Lifestage, group, hpf, Metric, lifestage_std)%>%
  summarise(mean=mean(Value, na.rm=TRUE), se=sd(Value, na.rm=TRUE)/sqrt(length(Value)), n=length(Value), ymin=mean-se, ymax=mean+se)

combined_plot_mean<-stats %>%
  
    ggplot(., aes(x = lifestage_std, y = mean)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  
    #add respiration mean with error bars  
    geom_point(data = . %>% filter(Metric=="Respiration"), aes(fill=Lifestage, colour=Lifestage, group=group), pch = 22, alpha=0.4, size=6, position = position_dodge(0.8)) + 
    geom_errorbar(data = . %>% filter(Metric=="Respiration"), aes(ymin=ymin, ymax=ymax, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
    
  #add photosynthesis mean with error bars  
    geom_point(data = . %>% filter(Metric=="Gross Photosynthesis"), aes(fill=Lifestage, colour=Lifestage, group=group), fill="white", pch = 21, size=6, position = position_dodge(0.8)) + 
    geom_errorbar(data = . %>% filter(Metric=="Gross Photosynthesis"), aes(ymin=ymin, ymax=ymax, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
  #add PR with secondary axis 
  scale_y_continuous(limits=c(-0.2, 0.2), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'), sec.axis = sec_axis(~.*20, name="P:R"))+
  geom_point(data = . %>% filter(Metric=="P:R Ratio"), aes(y=mean/20, colour=Lifestage, fill=Lifestage, group=group),  pch = 23, size=6, position = position_dodge(0.8)) +
     geom_errorbar(data = . %>% filter(Metric=="P:R Ratio"), aes(y=mean/20, x=lifestage_std, ymin=ymin/20, ymax=ymax/20, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); combined_plot_mean

#create a dummy plot to create a legend for the plot above

Lifestage <- c("Embryo", "Embryo", "Embryo", "Larvae", "Larvae", "Larvae", "Metamorphosed Polyp", "Metamorphosed Polyp", "Metamorphosed Polyp")
Metric <- c("Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R")
Dummy <- c(1, 2, 3, 4, 5, 6, 7, 8, 9)
df <- data.frame(Lifestage, Metric, Dummy)


legend_plot<-df %>%
  
    ggplot(., aes(x = Lifestage, y = Dummy, colour=Lifestage, shape=Metric)) +
    geom_point(aes(), alpha=1, size=4)+
    #scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"))+
    scale_colour_manual(name=expression(bold("Lifestage")), values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
  scale_shape_manual(name=expression(bold("Metric")), values=c(19, 21, 18), labels=c("Respiration", "Photosynthesis", "P:R"))+
  theme_classic()

legend<-get_legend(legend_plot)

combined_full_mean<-plot_grid(combined_plot_mean, legend, nrow=1, ncol=2, rel_widths=c(1, 0.3))
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_Means_PR.png", combined_full_mean, dpi=300, w=7, h=7, units="in")
```

Generate plot with means faceted vertically by each metric.  
```{r}
stats$Metric<-factor(stats$Metric, levels=c("Respiration", "Gross Photosynthesis", "P:R Ratio"))

facet_plot_mean<-stats %>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    facet_wrap(~Metric, scales="free", nrow = 3)+
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 21, alpha=1, size=6) + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_blank() #element_text(angle=45, hjust=1)
      ); facet_plot_mean

ggsave("Mcap2020/Figures/Respiration/Facet_Metrics_Means_PR.png", facet_plot_mean, dpi=300, w=5, h=7, units="in")
```

Generate individual plots with mean and standard error for generating a publication figure.  

```{r}
resp_plot_mean<-stats %>%
    filter(Metric=="Respiration")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,0.08)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); resp_plot_mean

ggsave("Mcap2020/Figures/Respiration/Respiration_Means.png", resp_plot_mean, dpi=300, w=4, h=5, units="in")

gross_plot_mean<-stats %>%
    filter(Metric=="Gross Photosynthesis")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,0.08)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste(P[Gross], " (nmol ", O[2], " individual"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1),
      plot.margin = margin(t = 10, r = 1, l = 1, b = 1)
      ); gross_plot_mean

ggsave("Mcap2020/Figures/Respiration/Gross_Photosynthesis_Means.png", gross_plot_mean, dpi=300, w=4, h=5, units="in")

ratio_plot_mean<-stats %>%
    filter(Metric=="P:R Ratio")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,3.5)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    geom_hline(yintercept=1, linetype="dashed", color="black")+
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1), 
      plot.margin = margin(t = 1, r = 1, l = 15, b = 1)
      ); ratio_plot_mean

ggsave("Mcap2020/Figures/Respiration/PR_Ratio_Means.png", ratio_plot_mean, dpi=300, w=4, h=5, units="in")


```

Make another set of plots for size normalized data. 

```{r}
stats_size<-PRdf%>%
  dplyr::select(Lifestage, lifestage_std, group, hpf, R.nmol.mm3.min, GP.nmol.mm3.min, PR_size)%>%
  gather(key="Metric", value="Value", R.nmol.mm3.min:PR_size)%>%
  mutate(Metric=if_else(Metric=="R.nmol.mm3.min", "Respiration", Metric))%>%
  mutate(Metric=if_else(Metric=="GP.nmol.mm3.min", "Gross Photosynthesis", Metric))%>%
  mutate(Metric=if_else(Metric=="PR_size", "P:R Ratio", Metric))%>%
  group_by(Lifestage, group, hpf, Metric, lifestage_std)%>%
  summarise(mean=mean(Value, na.rm=TRUE), se=sd(Value, na.rm=TRUE)/sqrt(length(Value)), n=length(Value), ymin=mean-se, ymax=mean+se)

stats_size$Metric<-factor(stats_size$Metric, levels=c("Respiration", "Gross Photosynthesis", "P:R Ratio"))

resp_plot_mean<-stats_size %>%
    filter(Metric=="Respiration")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,2)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " mm"^-3, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); resp_plot_mean

ggsave("Mcap2020/Figures/Respiration/Respiration_Means_Size.png", resp_plot_mean, dpi=300, w=4, h=5, units="in")

gross_plot_mean<-stats_size %>%
    filter(Metric=="Gross Photosynthesis")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
   ylim(0,2)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste(P[Gross], " (nmol ", O[2], " mm"^-3, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1),
      plot.margin = margin(t = 10, r = 1, l = 1, b = 1)
      ); gross_plot_mean

ggsave("Mcap2020/Figures/Respiration/Gross_Photosynthesis_Means_Size.png", gross_plot_mean, dpi=300, w=4, h=5, units="in")

ratio_plot_mean<-stats_size %>%
    filter(Metric=="P:R Ratio")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, group=group), pch = 21, alpha=1, size=6, color="black") + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,3.5)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    geom_hline(yintercept=1, linetype="dashed", color="black")+
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1), 
      plot.margin = margin(t = 1, r = 1, l = 15, b = 1)
      ); ratio_plot_mean

ggsave("Mcap2020/Figures/Respiration/PR_Ratio_Means_Size.png", ratio_plot_mean, dpi=300, w=4, h=5, units="in")
```

## Analyze data  

### *Respiration*     

#### Individual normalized 

Build ANOVA model and examine results for analysis of respiration.      
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel1<-aov(R.nmol.org.min~lifestage_std, data=PRdf)
summary(Rmodel1)
```

Check assumptions of model for residual normality and variance.

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel1)) #check normality assumption

leveneTest(residuals(Rmodel1)~lifestage_std, data=PRdf) #check for homogeneity of variance 
```

Test with a non parametric test.  
```{r}
kruskal.test(R.nmol.org.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Respiration varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(Rmodel1, ~lifestage_std)
cld(emm)
pairs(emm)
```

Metamorphosed polyp stages are different than other stages. 

#### Size normalized 

Build ANOVA model and examine results for analysis of respiration.      
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel1<-aov(R.nmol.mm3.min~lifestage_std, data=PRdf)
summary(Rmodel1)
```

Check assumptions of model for residual normality and variance.

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel1)) #check normality assumption

leveneTest(residuals(Rmodel1)~lifestage_std, data=PRdf) #check for homogeneity of variance 
```

Violates normality, analyze with a KW test.  

Test with a non parametric test.  
```{r}
kruskal.test(R.nmol.mm3.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Respiration varies by life stage.  

View posthoc comparisons for differences between lifestages using a Dunn test.  

```{r}
dunn<-dunnTest(R.nmol.mm3.min ~ lifestage_std, data = PRdf, method = "bonferroni")

# Access the letters for each group
dunn_letters <- dunn$res

cld <- cldList(comparison = dunn_letters$Comparison,
        p.value    = dunn_letters$P.adj,
        threshold  = 0.05)[1:2]

cld
```

### *Net Photosynthesis*  

Build ANOVA model and examine results of analysis of Net photosynthesis.        
```{r, results=TRUE, warning=FALSE, message=FALSE}
Pmodel1<-aov(P.nmol.org.min~lifestage_std, data=PRdf) 
summary(Pmodel1)
```

Check assumptions of model for residual normality and variance.

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Pmodel1))
leveneTest(residuals(Pmodel1)~lifestage_std, data=PRdf)
```

Test with a non parametric test.  
```{r}
kruskal.test(P.nmol.org.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Net photosynthesis varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(Pmodel1, ~lifestage_std)
cld(emm)
```

Larval photosynthesis is higher in later larval time points.  

### *Gross Photosynthesis*  

#### Individual normalized

Build ANOVA model and examine results of analysis of gross photosynthesis.         
```{r, results=TRUE, warning=FALSE, message=FALSE}
GPmodel1<-aov(GP.nmol.org.min~lifestage_std, data=PRdf) #gross P by lifestage with run as a random effect due to repeated measures
summary(GPmodel1)
```

Check assumptions of model for residual normality and variance.

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(GPmodel1))
leveneTest(residuals(GPmodel1)~lifestage_std, data=PRdf)
```

Test with a non parametric test.  
```{r}
kruskal.test(GP.nmol.org.min~lifestage_std, data=PRdf)
```
Results of a non-parametric test are also significant. Gross photosynthesis varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(GPmodel1, ~lifestage_std)
cld(emm)
pairs(emm)
```

Gross photosynthesis is higher in later developmental time points. 

#### Size normalized

Build ANOVA model and examine results of analysis of gross photosynthesis.         
```{r, results=TRUE, warning=FALSE, message=FALSE}
GPmodel1<-aov(GP.nmol.mm3.min~lifestage_std, data=PRdf) #gross P by lifestage with run as a random effect due to repeated measures
summary(GPmodel1)
```

Check assumptions of model for residual normality and variance.

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(GPmodel1))
leveneTest(residuals(GPmodel1)~lifestage_std, data=PRdf)
```

Test with a non parametric test.  
```{r}
kruskal.test(GP.nmol.mm3.min~lifestage_std, data=PRdf)
```
Results of a non-parametric test are also significant. Gross photosynthesis varies by life stage.  

View posthoc comparisons for differences between lifestages using a Dunn test.  

```{r}
dunn<-dunnTest(GP.nmol.mm3.min ~ lifestage_std, data = PRdf, method = "bonferroni")

# Access the letters for each group
dunn_letters <- dunn$res

cld <- cldList(comparison = dunn_letters$Comparison,
        p.value    = dunn_letters$P.adj,
        threshold  = 0.05)[1:2]

cld
```

### *P:R*  

### Individual normalized
 
Build ANOVA model and examine results of analysis of gross photosynthesis       
```{r, results=TRUE, warning=FALSE, message=FALSE}
PRmodel1<-aov(ratio~lifestage_std, data=PRdf)
summary(PRmodel1)
```

Check assumptions of model for residual normality and variance.
```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(PRmodel1))
leveneTest(residuals(PRmodel1)~lifestage_std, data=PRdf)
```

Test with a non parametric test.  
```{r}
kruskal.test(ratio~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. P:R ratio varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(PRmodel1, ~lifestage_std)
cld(emm)
```

PR ratios are lower in metamorphosed polyp stages than larvae.

### Size normalized
 
Build ANOVA model and examine results of analysis of gross photosynthesis       
```{r, results=TRUE, warning=FALSE, message=FALSE}
PRmodel1<-aov(PR_size~lifestage_std, data=PRdf)
summary(PRmodel1)
```

Check assumptions of model for residual normality and variance.
```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(PRmodel1))
leveneTest(residuals(PRmodel1)~lifestage_std, data=PRdf)
```

Test with a non parametric test.  
```{r}
kruskal.test(PR_size~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. P:R ratio varies by life stage.  

View posthoc comparisons for differences between lifestages using a Dunn test.  

```{r}
dunn<-dunnTest(PR_size ~ lifestage_std, data = PRdf, method = "bonferroni")

# Access the letters for each group
dunn_letters <- dunn$res

cld <- cldList(comparison = dunn_letters$Comparison,
        p.value    = dunn_letters$P.adj,
        threshold  = 0.05)[1:2]

cld
```

PR ratios are lower in metamorphosed polyp stages than larvae.

### Generate summary tables 

Generate summary of all metabolic rate data with mean and standard error for each metric.  

```{r}
summary<-PRdf%>%
  group_by(lifestage_std)%>%
  summarise(N=length(R.nmol.org.min),
            Mean_R=mean(R.nmol.org.min), 
            SE_R=sd(R.nmol.org.min)/sqrt(length(R.nmol.org.min)),
            Mean_P=mean(P.nmol.org.min), 
            SE_P=sd(P.nmol.org.min)/sqrt(length(P.nmol.org.min)),
            Mean_GP=mean(GP.nmol.org.min), 
            SE_GP=sd(GP.nmol.org.min)/sqrt(length(GP.nmol.org.min)),
            Mean_PR=mean(ratio), 
            SE_PR=sd(ratio)/sqrt(length(ratio)), 
            Mean_R_size=mean(R.nmol.mm3.min), 
            SE_R_size=sd(R.nmol.mm3.min/sqrt(length(R.nmol.mm3.min))), 
            Mean_GP_size=mean(GP.nmol.mm3.min), 
            SE_GP_size=sd(GP.nmol.mm3.min)/sqrt(length(GP.nmol.mm3.min)),
            Mean_PR_size=mean(PR_size), 
            SE_PR_size=sd(PR_size)/sqrt(length(PR_size)))

summary%>%
  write_csv(., "Mcap2020/Output/Respiration/mean_respiration.csv")

summary
```
