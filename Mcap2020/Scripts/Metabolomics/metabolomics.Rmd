---
title: M. capitata metabolomics analysis
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
---
Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 

#load packages
library("ggplot2")
library("tidyverse")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')

```

## Positive Polarity  

Load data
```{r}
data<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#rename columns to be useful
data<- data %>% 
  rename(
    Larvae1_rep1 = Larvae.1_50uL_1,
    Larvae1_rep2 = Larvae.1_50uL_2,
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 =  Larvae.2_50uL_2,
    Recruit1_rep1 = Recruit.1_15.20.Individuals_1,
    Recruit1_rep2 = Recruit.1_15.20.Individuals_2 
    )

```

Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data<- data %>%
  mutate(Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2), 
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2),
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2))
```


Mutate the data to be in long rather than wide format.  

```{r}
data <- data %>% 
  gather(Sample, IonCounts, 23:28)

data <- data[c(9, 23, 24)]
```

Add lifestage column for categorizing  

```{r}
data<-data%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data$Lifestage<-as.factor(data$Lifestage)
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting<-plyr::ddply(data, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)
#write summary file
data_summary<-data_plotting[c(1,2,4)]

#data_summary%>%
  #spread(Lifestage, mean) %>%
  #write_csv("Mcap2020/Output/Metabolomics/mean_norm_counts_lifestage_pos.csv")

metab_compounds<-ggplot(data_plotting, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold"));metab_compounds

ggsave("Mcap2020/Figures/Metabolomics/compounds_fullscale_pos.pdf", plot=metab_compounds, dpi=300, width=25, height=8, units="in")

metabl_short<-metab_compounds + ylim(0,100)

ggsave("Mcap2020/Figures/Metabolomics/compounds_shortscale_pos.pdf", plot=metabl_short, dpi=300, width=25, height=8, units="in")

metabl_shortest<-metab_compounds + ylim(0,20)

ggsave("Mcap2020/Figures/Metabolomics/compounds_shortestscale_pos.pdf", plot=metabl_shortest, dpi=300, width=25, height=8, units="in")

```


Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca<-data%>%
  spread(compound, IonCounts)
```

Plot PCA with lifestage in colors.  

```{r}
scaled.pca<-prcomp(data_pca[c(4,81)],scale=TRUE, center=TRUE) 

pcaPlot1<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.75,0.75)+
  ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

#pcaPlot1$layers[[2]]$aes_params$size <- 1

ggsave("Mcap2020/Figures/Metabolomics/PCA_pos.pdf", plot=pcaPlot1, height=8, width=10, units = c("in"), dpi=300) #output figure
```

Read in .csv of normalized counts with trend assigned.  

Plot compounds grouping by increasing over ontogeny, decreasing, or no apparent trend.  

ADD TREND DISTINCTION HERE  

```{r}
######

trends<-read.csv("Mcap2020/Data/Metabolomics/mean_norm_counts_lifestage_pos_trend.csv", sep=",", na.strings=NA) ### Need to automate this step, set up function


```


```{r}
trends<-trends%>%
  gather(Lifestage, IonCounts, 3:5)
  
metab_trends<-ggplot(trends, aes(y=IonCounts, x=compound, fill=Lifestage, group=Lifestage)) + 
  facet_wrap(~Trend, scales = "free")+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold"));metab_trends

ggsave("Mcap2020/Figures/Metabolomics/trends_fullscale.pdf", plot=metab_trends, dpi=300, width=35, height=8, units="in")

trend_short<-metab_trends + ylim(0,100)

ggsave("Mcap2020/Figures/Metabolomics/trends_shortscale.pdf", plot=trend_short, dpi=300, width=35, height=8, units="in")

trend_shortest<-metab_trends + ylim(0,20)

ggsave("Mcap2020/Figures/Metabolomics/trends_shortestscale.pdf", plot=trend_shortest, dpi=300, width=35, height=8, units="in")
```



## Negative Polarity  

Load data
```{r}
data_neg<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#rename columns to be useful
data_neg<- data_neg %>% 
  rename(
    Larvae1_rep1 = Larvae.1_50uL_1,
    Larvae1_rep2 = Larvae.1_50uL_2,
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 =  Larvae.2_50uL_2,
    Recruit1_rep1 = Recruit.1_15.20.Individuals_1,
    Recruit1_rep2 = Recruit.1_15.20.Individuals_2 
    )

```


Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data_neg<- data_neg %>%
  mutate(Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2), 
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2),
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2))
```


Mutate the data to be in long rather than wide format.  

```{r}
data_neg <- data_neg %>% 
  gather(Sample, IonCounts, 23:28)

data_neg <- data_neg[c(9, 23, 24)]
```

Add lifestage column for categorizing  

```{r}
data_neg<-data_neg%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data_neg$Lifestage<-as.factor(data_neg$Lifestage)
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting_neg<-plyr::ddply(data_neg, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)
#write summary file
data_summary_neg<-data_plotting_neg[c(1,2,4)]

#data_summary_neg%>%
  #spread(Lifestage, mean) %>%
  #write_csv("Mcap2020/Output/Metabolomics/mean_norm_counts_lifestage_neg.csv")

metab_compounds_neg<-ggplot(data_plotting_neg, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold"));metab_compounds_neg

ggsave("Mcap2020/Figures/Metabolomics/compounds_fullscale_neg.pdf", plot=metab_compounds_neg, dpi=300, width=25, height=8, units="in")

metabl_short_neg<-metab_compounds_neg + ylim(0,100)

ggsave("Mcap2020/Figures/Metabolomics/compounds_shortscale_neg.pdf", plot=metabl_short_neg, dpi=300, width=25, height=8, units="in")

metabl_shortest_neg<-metab_compounds_neg + ylim(0,20)

ggsave("Mcap2020/Figures/Metabolomics/compounds_shortestscale_neg.pdf", plot=metabl_shortest_neg, dpi=300, width=25, height=8, units="in")

```


Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca_neg<-data_neg%>%
  spread(compound, IonCounts)
```
 
Plot PCA with lifestage in colors.  

```{r}
scaled.pca.neg<-prcomp(data_pca_neg[c(4,76)],scale=TRUE, center=TRUE) 

pcaPlot1_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.75,0.75)+
  ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1_neg

#pcaPlot1$layers[[2]]$aes_params$size <- 1

ggsave("Mcap2020/Figures/Metabolomics/PCA_neg.pdf", plot=pcaPlot1_neg, height=8, width=10, units = c("in"), dpi=300) #output figure
```

Read in .csv of normalized counts with trend assigned.  

Plot compounds grouping by increasing over ontogeny, decreasing, or no apparent trend.  

```{r}
##redo to automate this part then delete this dataframe
trends_neg<-read.csv("Mcap2020/Data/Metabolomics/mean_norm_counts_lifestage_neg_trend.csv", sep=",", na.strings=NA)

```

```{r}
trends_neg<-trends_neg%>%
  gather(Lifestage, IonCounts, 3:5)
  
metab_trends_neg<-ggplot(trends_neg, aes(y=IonCounts, x=compound, fill=Lifestage, group=Lifestage)) + 
  facet_wrap(~Trend, scales = "free")+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold"));metab_trends_neg

ggsave("Mcap2020/Figures/Metabolomics/trends_fullscale_neg.pdf", plot=metab_trends_neg, dpi=300, width=35, height=8, units="in")

trend_short_neg<-metab_trends_neg + ylim(0,100)

ggsave("Mcap2020/Figures/Metabolomics/trends_shortscale_neg.pdf", plot=trend_short_neg, dpi=300, width=35, height=8, units="in")

trend_shortest_neg<-metab_trends_neg + ylim(0,20)

ggsave("Mcap2020/Figures/Metabolomics/trends_shortestscale_neg.pdf", plot=trend_shortest_neg, dpi=300, width=35, height=8, units="in")
```

Generate a dataframe with normalized counts for positive and negative polarity datasets.  

```{r}
#merge two datasets such that mean in negative = "negative", and mean from positive = "positive". If not present, NA. 
data_summary_neg<-data_summary_neg%>%
    rename(Negative = mean)

data_summary<-data_summary%>%
    rename(Positive = mean)

#view normalized negative dataset
head(data_summary_neg)

head(data_summary)

#join datasets together
normalized_counts_pos_neg<-full_join(data_summary, data_summary_neg)

write_csv(normalized_counts_pos_neg, file="Mcap2020/Output/Metabolomics/normalized_counts_pos_neg.csv")

```

## Selecting polarity  

Use metabolite selection file to select polarity by averaging peaks across life stages for pos and neg peaks and choosing the strongest peaks.    

```{r}
#datan is positive and data_neg are negative dataframes 
data<-data%>%
  mutate(Polarity="Positive")

data_neg<-data_neg%>%
  mutate(Polarity="Negative")

data_full<-full_join(data, data_neg) #combine full positive and negative datasets

data_full<-data_full%>%
  spread(Polarity, IonCounts)

#summarize across life stages and reps
polarity<-data_full%>%
  gather("Polarity", "IonCounts", 5:6)%>%
  group_by(Polarity, compound)%>%
  summarise(mean=mean(IonCounts))%>% #summarize across samples (lifestages)
  arrange(compound)%>% #list by compound
  replace_na(list(mean=0)) #replace NA with 0 to allow us to calculate higher values between polarities 

#add column of selected polarity based on stronger signal average
polarity<-polarity%>%
  spread(Polarity, mean)%>%
  mutate(Selection = ifelse(Negative > Positive, "Negative",
                     ifelse(Positive > Negative, "Positive", NA)))
  
```

Use this selected polarity key to select data for analysis.    

```{r}
#match selection column back onto original dataframe 
data_full$Selection<-polarity$Selection[match(data_full$compound, polarity$compound)] 

#pull out pos data
pos_peaks<-data_full%>%
  filter(Selection=="Positive")%>%
  select(Lifestage, Rep, compound, Positive, Selection)%>%
  rename(value=Positive)
  
#pull out neg data
neg_peaks<-data_full%>%
  filter(Selection=="Negative")%>%
  select(Lifestage, Rep, compound, Negative, Selection)%>%
  rename(value=Negative)

#rbind them together to generate a dataframe of positive and negative selected compounds
peaks_selected<-rbind(pos_peaks, neg_peaks)

peaks_selected<-peaks_selected %>%
  select(Lifestage, Rep, compound, value) 
```

Output file to .csv.   

```{r}
write_csv(peaks_selected, "Mcap2020/Output/Metabolomics/selected_metabolites.csv")
```



## Plotting full data with positive and negative polarities  

### PCA   

Run PCA to view differences in life stages.   

Convert data to wide format. 

```{r}
data_pca_full<-peaks_selected%>%
  spread(compound, value)
```

Plot PCA with lifestage in colors.   

```{r}
scaled.pca<-prcomp(data_pca_full[c(3,123)],scale=TRUE, center=TRUE) 

pcaPlot_full<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.75,0.75)+
  ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full

ggsave("Mcap2020/Figures/Metabolomics/PCA_full.pdf", plot=pcaPlot_full, height=8, width=10, units = c("in"), dpi=300) #output figure
```
 
Show a panel of PCA by positive, negative, and combined datasets.   
```{r}
pca_pos<-pcaPlot1+theme(legend.position="none")
pca_neg<-pcaPlot1_neg+theme(legend.position="none")

pcaplots<-plot_grid(pca_pos, pca_neg, pcaPlot_full, labels = c("Positive", "Negative", "Combined"), ncol=3, nrow=1, rel_widths = c(0.8, 0.8, 1), label_size = 20, label_x = 0.1);pcaplots

ggsave(filename="Mcap2020/Figures/Metabolomics/All_PCAs.pdf", plot=pcaplots, dpi=300, width=20, height=5, units="in")
```  