---
title: Early life history respirometry (photosynthesis & respiration) analysis and plotting
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---
This script analyzes and plots data for Symbiont Integration 2020 respirometry data. Plots are displayed in Plotting section. Results are provided in Analysis section. 

# **Setup**  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('effects')
library('emmeans')
library('multcomp')
```

# **Data visualization and manipulation**  

Load data for P and R rates generated from LoLinR script `Respirometry_Extraction.Rmd`.      
```{r, warning=FALSE, message=FALSE}
PRdata<-read.csv("Mcap2020/Output/Respiration/oxygen_P_R_calc.csv") #load data
```

Separate data for this project (remove "Juveniles" from this dataset from a separate project). 
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that were not either samples or blanks
PRdata<-PRdata[!is.na(PRdata$Type),]

#format columns as factor
PRdata$dpf<-as.factor(PRdata$dpf)

#subset fused juvenile data frame for a different project and remove 
fused_oxygen <- PRdata[which(PRdata$Lifestage=='Juvenile'),]
fused_oxygen <- droplevels(fused_oxygen)
```

Calculate a gross photosynthesis : respiration (P:R) ratio. This calculation will provide a ratio that will show the amount of oxygen produced compared to consumed, which is an indicator of energy availability. A ratio >1 indicates more photosynthesis than respiration and a ratio <1 indicates less photosynthesis than respiration.   

Examine plot of data to look for outliers.  
```{r, warning=FALSE, message=FALSE}
PRdata$ratio<-abs(PRdata$GP.nmol.org.min)/abs(PRdata$R.nmol.org.min) #calculate ratio with absolute values of gross photosynthesis and respiration

#remove outliers detected by values of P:R ratio data
plot(PRdata$ratio)
```
There are outliers at high P:R ratio values. Filter and view data again.  
```{r}
PRdata<-PRdata%>%filter(ratio < 8)
plot(PRdata$ratio)
```
Outliers are removed.  

Examine outliers for respiration data. 
```{r}
#remove any respiration values that were above 0 (respiration is oxygen consumption, so we expect values less than 0 for negative rates)
plot(PRdata$R.nmol.org.min)
PRdata<-PRdata%>%filter(R.nmol.org.min < 0)

#remove any respiration values that were outliers
PRdata<-PRdata%>%filter(R.nmol.org.min > -0.15)
plot(PRdata$R.nmol.org.min)
```
Outliers are removed and values are removed where respiration is >0. Respiration is oxygen consumption, so we expect values less than 0 for negative rates.  

Calculate PR ratio.  
```{r}
fused_oxygen$ratio<-abs(fused_oxygen$GP.nmol.org.min)/abs(fused_oxygen$R.nmol.org.min) #calculate P:R ratio 
```

# **Analysis and plotting of P and R**  

Load sample metadata to identify lifestage and developmental time.   

```{r}
metadata<-read.csv("Mcap2020/Data/Respiration/PR_metadata.csv") #load metadata file

PRdf<-PRdata%>%
  filter(!Lifestage=="Juvenile") #remove "Juvenile" samples from a different project 

#match in sample information from metadata to our data frame 
PRdf$code<-paste(PRdf$Date, PRdf$Lifestage)
metadata$code<-paste(metadata$Date, metadata$Lifestage)
PRdf$hpf<-metadata$hpf[match(PRdf$code, metadata$code)]
PRdf$group<-metadata$group[match(PRdf$code, metadata$code)]
PRdf$hpf<-as.factor(PRdf$hpf)
```

Add in lifestage identifiers that match all other datasets.   
```{r}
lifestages<-read.csv("Mcap2020/Data/lifestage_metadata.csv")

#remove spaces in lifestage group identifiers to match the respiration data set and then use this key to add in new lifestage names 
lifestages$code<-gsub(" ", "", lifestages$code)
PRdf$lifestage_std<-lifestages$lifestage[match(PRdf$group, lifestages$code)]

#arrange order of factor 
PRdf$lifestage_std<-factor(PRdf$lifestage_std, levels=c("Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)", "Metamorphosed Polyp (231 hpf)"))
```

## Respiration  

Plot respiration data as a boxplot.    
```{r}
r_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = abs(R.nmol.org.min))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); r_plot
```

## Photosynthesis (Net)  

Plot data as a box plot. Net photosynthesis is excess oxygen production after subtracting the oxygen consumed (respiration).     
```{r}
p_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = P.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Net P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    xlab("")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); p_plot
```

## Photosynthesis (Gross)  

Plot data as a boxplot. Plot gross photosynthesis, which is net photosynthesis rates plus the oxygen consumed through respiration.     
```{r}
gp_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = GP.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position=position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Gross P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_y_continuous(limits=c(-0.07, 0.11), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); gp_plot
```

## P:R Ratio  

Plot data as a box plot.    
```{r}
pr_plot<-PRdf %>%
    ggplot(., aes(x = lifestage_std, y = ratio)) +
    geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
    geom_boxplot(aes(color=Lifestage, group=group), outlier.size = 0, position = position_dodge(0.8), lwd=1) +
    geom_point(aes(fill=Lifestage, group=group), pch = 21, size=4, position = position_jitterdodge(0.1)) + 
    xlab("") + 
    scale_fill_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"), guide="none")+
    scale_color_manual(name="", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    scale_y_continuous(limits=c(-0.5, 5), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=16),
      legend.text=element_text(size=14), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); pr_plot
```

## Generate final figure for manuscript.  

Plot panel of all figures with boxplots.   
```{r}
#edit asthetics for stacking plots 
r_plot2<-r_plot + theme(axis.text.x=element_blank(), legend.position="top")
p_plot2<-p_plot + theme(axis.text.x=element_blank(), legend.position="none")
gp_plot2<-gp_plot + theme(axis.text.x=element_blank(), legend.position="none")
pr_plot2<-pr_plot + theme(legend.position="none")

full_fig<-plot_grid(r_plot2, p_plot2, gp_plot2, pr_plot2, labels=c("A", "B", "C", "D"), label_size=20, ncol=1, nrow=4, rel_heights= c(1,1,1,1), rel_widths = c(0.8,0.8,0.8,1.1), label_y=1, align="v")

ggsave(filename="Mcap2020/Figures/Respiration/respirometry_panel.png", plot=full_fig, dpi=300, width=6, height=20, units="in")
```

Plot P, R and PR ratio into one panel plot. Plot gross photosynthesis and respiration data with all data points to show variability. Plot mean P:R ratio overlayed on these points.   
```{r}
#calculate mean P:R ratio
stats<-PRdf%>%
  group_by(group, lifestage_std, Lifestage, hpf)%>%
  summarise(meanPR=mean(ratio, na.rm=TRUE), sePR=sd(ratio, na.rm=TRUE)/sqrt(length(ratio)), nPR=length(ratio), ymin=meanPR-sePR, ymax=meanPR+sePR) 

combined_plot<-PRdf %>%
  
    ggplot(., aes(x = lifestage_std, y = R.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_hline(yintercept=0.05, linetype="dotted", color="black", size=0.75)+
  
    #add respiration
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 22, alpha=0.4, size=4, position = position_jitterdodge(0.1)) + 
  
   #add photosynthesis mean with error bars 
  geom_point(aes(y=GP.nmol.org.min, colour=Lifestage, group=group), fill="white", pch = 21, size=4, position = position_jitterdodge(0.1)) +
  
  #add PR with secondary axis 
  scale_y_continuous(limits=c(-0.2, 0.2), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'), sec.axis = sec_axis(~.*20, name="P:R"))+
  geom_point(data=stats, aes(y=meanPR/20, colour=Lifestage, fill=Lifestage, group=group),  pch = 23, size=6, position = position_dodge(0.8)) +
     geom_errorbar(data=stats, aes(y=meanPR/20, x=lifestage_std, ymin=ymin/20, ymax=ymax/20, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); combined_plot

#create a dummy plot to create a legend for the plot above

Lifestage <- c("Embryo", "Embryo", "Embryo", "Larvae", "Larvae", "Larvae", "Metamorphosed Polyp", "Metamorphosed Polyp", "Metamorphosed Polyp")
Metric <- c("Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R")
Dummy <- c(1, 2, 3, 4, 5, 6, 7, 8, 9)
df <- data.frame(Lifestage, Metric, Dummy)


legend_plot<-df %>%
  
    ggplot(., aes(x = Lifestage, y = Dummy, colour=Lifestage, shape=Metric)) +
    geom_point(aes(), alpha=1, size=4)+
    #scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"))+
    scale_colour_manual(name=expression(bold("Lifestage")), values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"), guide="none")+
  scale_shape_manual(name=expression(bold("")), values=c(15, 21, 18), labels=c("Respiration", "Photosynthesis", "P:R"))+
  theme_classic()+
  theme(legend.position="top")

legend<-get_legend(legend_plot)

combined_full<-plot_grid(legend, combined_plot, nrow=2, ncol=1, rel_widths=c(1, 1), rel_heights=c(0.3, 1))
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_PR.png", combined_full, dpi=300, w=5, h=7, units="in")
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_PR.pdf", combined_full, dpi=300, w=5, h=7, units="in")
```

Plot P R and PR ratio in one plot showing only means and std. error for all metrics.  

```{r}
stats<-PRdf%>%
  dplyr::select(Lifestage, lifestage_std, group, hpf, R.nmol.org.min, GP.nmol.org.min, ratio)%>%
  gather(key="Metric", value="Value", R.nmol.org.min:ratio)%>%
  mutate(Metric=if_else(Metric=="R.nmol.org.min", "Respiration", Metric))%>%
  mutate(Metric=if_else(Metric=="GP.nmol.org.min", "Gross Photosynthesis", Metric))%>%
  mutate(Metric=if_else(Metric=="ratio", "P:R Ratio", Metric))%>%
  group_by(Lifestage, group, hpf, Metric, lifestage_std)%>%
  summarise(mean=mean(Value, na.rm=TRUE), se=sd(Value, na.rm=TRUE)/sqrt(length(Value)), n=length(Value), ymin=mean-se, ymax=mean+se)

combined_plot_mean<-stats %>%
  
    ggplot(., aes(x = lifestage_std, y = mean)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  
    #add respiration mean with error bars  
    geom_point(data = . %>% filter(Metric=="Respiration"), aes(fill=Lifestage, colour=Lifestage, group=group), pch = 22, alpha=0.4, size=6, position = position_dodge(0.8)) + 
    geom_errorbar(data = . %>% filter(Metric=="Respiration"), aes(ymin=ymin, ymax=ymax, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
    
  #add photosynthesis mean with error bars  
    geom_point(data = . %>% filter(Metric=="Gross Photosynthesis"), aes(fill=Lifestage, colour=Lifestage, group=group), fill="white", pch = 21, size=6, position = position_dodge(0.8)) + 
    geom_errorbar(data = . %>% filter(Metric=="Gross Photosynthesis"), aes(ymin=ymin, ymax=ymax, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
  #add PR with secondary axis 
  scale_y_continuous(limits=c(-0.2, 0.2), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'), sec.axis = sec_axis(~.*20, name="P:R"))+
  geom_point(data = . %>% filter(Metric=="P:R Ratio"), aes(y=mean/20, colour=Lifestage, fill=Lifestage, group=group),  pch = 23, size=6, position = position_dodge(0.8)) +
     geom_errorbar(data = . %>% filter(Metric=="P:R Ratio"), aes(y=mean/20, x=lifestage_std, ymin=ymin/20, ymax=ymax/20, colour=Lifestage, group=group), width=0.1, color="black", position=position_dodge(0.8)) +
  
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); combined_plot_mean

#create a dummy plot to create a legend for the plot above

Lifestage <- c("Embryo", "Embryo", "Embryo", "Larvae", "Larvae", "Larvae", "Metamorphosed Polyp", "Metamorphosed Polyp", "Metamorphosed Polyp")
Metric <- c("Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R", "Respiration", "Photosynthesis", "P:R")
Dummy <- c(1, 2, 3, 4, 5, 6, 7, 8, 9)
df <- data.frame(Lifestage, Metric, Dummy)


legend_plot<-df %>%
  
    ggplot(., aes(x = Lifestage, y = Dummy, colour=Lifestage, shape=Metric)) +
    geom_point(aes(), alpha=1, size=4)+
    #scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"))+
    scale_colour_manual(name=expression(bold("Lifestage")), values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
  scale_shape_manual(name=expression(bold("Metric")), values=c(19, 21, 18), labels=c("Respiration", "Photosynthesis", "P:R"))+
  theme_classic()

legend<-get_legend(legend_plot)

combined_full_mean<-plot_grid(combined_plot_mean, legend, nrow=1, ncol=2, rel_widths=c(1, 0.3))
ggsave("Mcap2020/Figures/Respiration/Combined_Metrics_Means_PR.png", combined_full_mean, dpi=300, w=7, h=7, units="in")
```

Generate plot with means faceted vertically by each metric.  
```{r}
stats$Metric<-factor(stats$Metric, levels=c("Respiration", "Gross Photosynthesis", "P:R Ratio"))

facet_plot_mean<-stats %>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    facet_wrap(~Metric, scales="free", nrow = 3)+
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 21, alpha=1, size=6) + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Metabolic Rate (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_blank() #element_text(angle=45, hjust=1)
      ); facet_plot_mean

ggsave("Mcap2020/Figures/Respiration/Facet_Metrics_Means_PR.png", facet_plot_mean, dpi=300, w=5, h=7, units="in")
```

Generate individual plots with mean and standard error for generating a publication figure.  

```{r}
resp_plot_mean<-stats %>%
    filter(Metric=="Respiration")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 21, alpha=1, size=6) + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,0.08)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Respiration (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1)
      ); resp_plot_mean

ggsave("Mcap2020/Figures/Respiration/Respiration_Means.png", resp_plot_mean, dpi=300, w=4, h=5, units="in")

gross_plot_mean<-stats %>%
    filter(Metric=="Gross Photosynthesis")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 21, alpha=1, size=6) + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,0.08)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("Photosynthesis (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1),
      plot.margin = margin(t = 10, r = 1, l = 1, b = 1)
      ); gross_plot_mean

ggsave("Mcap2020/Figures/Respiration/Gross_Photosynthesis_Means.png", gross_plot_mean, dpi=300, w=4, h=5, units="in")

ratio_plot_mean<-stats %>%
    filter(Metric=="P:R Ratio")%>%
  
    ggplot(., aes(x = lifestage_std, y = abs(mean))) +
    geom_hline(yintercept=0, linetype="dashed", color="white", size=0.75)+
    geom_hline(yintercept=0.07, linetype="dashed", color="white", size=0.75)+
  
    #add mean with error bars  
    geom_point(aes(fill=Lifestage, colour=Lifestage, group=group), pch = 21, alpha=1, size=6) + 
    geom_errorbar(aes(ymin=abs(ymin), ymax=abs(ymax), colour=Lifestage, group=group), width=0, color="black") +
    
    #aesthetics 
    xlab("") + 
    ylim(0,3.5)+
    scale_fill_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), guide="none")+
    scale_color_manual(name="Lifestage", values=c("#DFC27D", "#80CDC1","#003C30"), labels=c("Embryo", "Larvae", "Metamorphosed \nPolyp"))+
    ylab(expression(bold(paste("P:R")))) +
    geom_hline(yintercept=1, linetype="dashed", color="black")+
  
    #theme
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      axis.text.x=element_text(angle=45, hjust=1), 
      plot.margin = margin(t = 1, r = 1, l = 15, b = 1)
      ); ratio_plot_mean

ggsave("Mcap2020/Figures/Respiration/PR_Ratio_Means.png", ratio_plot_mean, dpi=300, w=4, h=5, units="in")


```



## Export relative change of GP, R, and P:R for integrative analyses  

```{r}
head(PRdf)

pr_change<-PRdf%>%
  dplyr::select(lifestage_std, Date, Sample.ID, Run, GP.nmol.org.min, R.nmol.org.min, ratio)%>%
  group_by(lifestage_std)%>%
  summarise(mean_GP=mean(GP.nmol.org.min), mean_R=mean(R.nmol.org.min), mean_ratio=mean(ratio))%>%
  mutate(GP_change=((mean_GP-dplyr::first(mean_GP))/abs(dplyr::first(mean_GP))), 
         R_change=((abs(mean_R)-dplyr::first(abs(mean_R)))/abs(dplyr::first(mean_R))), 
         ratio_change=((mean_ratio-dplyr::first(mean_ratio))/abs(dplyr::first(mean_ratio))))%>%
  dplyr::select(lifestage_std, GP_change, R_change, ratio_change)%>%
  write_csv("Mcap2020/Data/Integration/RelativeChange/PR_relchange.csv")
```


## Analyze data  

### *Respiration*     

Build ANOVA model and examine results for analysis of respiration.      
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel1<-aov(R.nmol.org.min~lifestage_std, data=PRdf)
summary(Rmodel1)
```

Check assumptions of model for residual normality and variance.    

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel1)) #check normality assumption

leveneTest(residuals(Rmodel1)~lifestage_std, data=PRdf) #check for homogeneity of variance 
```
Data meets the normality assumption, but does not pass homogeneity of variance. 

Test with a non parametric test.  
```{r}
kruskal.test(R.nmol.org.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Respiration varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(Rmodel1, ~lifestage_std)
cld(emm)
```

Metamorphosed polyp stages are different than other stages. 

### *Net Photosynthesis*  

Build ANOVA model and examine results of analysis of Net photosynthesis.        
```{r, results=TRUE, warning=FALSE, message=FALSE}
Pmodel1<-aov(P.nmol.org.min~lifestage_std, data=PRdf) 
summary(Pmodel1)
```

Check assumptions of model for residual normality and variance.    

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Pmodel1))
leveneTest(residuals(Pmodel1)~lifestage_std, data=PRdf)
```

Assumption of homogeneity of variance is violated.  

Test with a non parametric test.  
```{r}
kruskal.test(P.nmol.org.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Net photosynthesis varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(Pmodel1, ~lifestage_std)
cld(emm)
```

Larval photosynthesis is higher in later larval time points.  

### *Gross Photosynthesis*  

Build ANOVA model and examine results of analysis of gross photosynthesis.         
```{r, results=TRUE, warning=FALSE, message=FALSE}
GPmodel1<-aov(GP.nmol.org.min~lifestage_std, data=PRdf) #gross P by lifestage with run as a random effect due to repeated measures
summary(GPmodel1)
```

Check assumptions of model for residual normality and variance.      

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(GPmodel1))
leveneTest(residuals(GPmodel1)~lifestage_std, data=PRdf)
```

Variance assumption is violated. 

Test with a non parametric test.  
```{r}
kruskal.test(GP.nmol.org.min~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. Gross photosynthesis varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(GPmodel1, ~lifestage_std)
cld(emm)
```

Gross photosynthesis is higher in later developmental time points. 

### *P:R*  
 
Build ANOVA model and examine results of analysis of gross photosynthesis       
```{r, results=TRUE, warning=FALSE, message=FALSE}
PRmodel1<-aov(ratio~lifestage_std, data=PRdf)
summary(PRmodel1)
```

Check assumptions of model for residual normality and variance. 

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(PRmodel1))
leveneTest(residuals(PRmodel1)~lifestage_std, data=PRdf)
```

Variance assumption is violated. 

Test with a non parametric test.  
```{r}
kruskal.test(ratio~lifestage_std, data=PRdf)
```

Results of a non-parametric test are also significant. P:R ratio varies by life stage.  

Conduct post hoc test.  

```{r}
emm<-emmeans(PRmodel1, ~lifestage_std)
cld(emm)
```

PR ratios are lower in metamorphosed polyp stages than larvae.  

### Generate summary tables 

Generate summary of all metabolic rate data with mean and standard error for each metric.  

```{r}
summary<-PRdf%>%
  group_by(lifestage_std)%>%
  summarise(N=length(R.nmol.org.min),
            Mean_R=mean(R.nmol.org.min), 
            SE_R=sd(R.nmol.org.min)/sqrt(length(R.nmol.org.min)),
            Mean_P=mean(P.nmol.org.min), 
            SE_P=sd(P.nmol.org.min)/sqrt(length(P.nmol.org.min)),
            Mean_GP=mean(GP.nmol.org.min), 
            SE_GP=sd(GP.nmol.org.min)/sqrt(length(GP.nmol.org.min)),
            Mean_PR=mean(ratio), 
            SE_PR=sd(ratio)/sqrt(length(ratio)))

summary%>%
  write_csv(., "Mcap2020/Output/Respiration/mean_respiration.csv")

summary
```


# **Exploring additional datasets from other projects**    

During this experiment, we also conducted respirometry measurements on juveniles from a previous *M. capitata* cohort and from fused juvenile colonies from previous cohorts. We are exploring these data here as preliminary observations for future experiments. These data are not included in the manuscript for the *M. capitata* developmental time series project.  

These data are only included for exploratory purposes.  

## **Plotting: Larvae, Recruits, Juveniles**    

First, compare metabolic rates of our developmental time series with 30-40 day old juveniles from a previous cohort.  

Generate plots by lifestage and days post fertilization.  

### *Respiration*  

Generate dot plot.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
Rplot1<-ggplot(data=PRdata, aes(x=dpf, y=R.nmol.org.min, colour=Lifestage, group=interaction(Lifestage, dpf))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_color_brewer(palette = "Dark2", breaks=c("Larvae", "Recruit", "Juvenile"))+
  scale_y_continuous(limits=c(-0.1, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Days post fertilization")+
  ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "top",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));Rplot1
```

Respiration appears to be highest in older juveniles.  

### *Net Photosynthesis*   

```{r, results=TRUE, warning=FALSE, message=FALSE}
Pplot1<-ggplot(data=PRdata, aes(x=dpf, y=P.nmol.org.min, colour=Lifestage, group=interaction(Lifestage, dpf))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_color_brewer(palette = "Dark2", breaks=c("Larvae", "Recruit", "Juvenile"))+
  scale_y_continuous(limits=c(-0.1, 0.3), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Days post fertilization")+
  ylab(expression(bold(paste("Net P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0))); Pplot1
```
 
Net photosynthesis is also higher in older juvenile colonies.  

### *Gross Photosynthesis*   

```{r, results=TRUE, warning=FALSE, message=FALSE}
GPplot1<-ggplot(data=PRdata, aes(x=dpf, y=GP.nmol.org.min, colour=Lifestage, group=interaction(Lifestage, dpf))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_color_brewer(palette = "Dark2", breaks=c("Larvae", "Recruit", "Juvenile"))+
  scale_y_continuous(limits=c(-0.1, 0.3), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Days post fertilization")+
  ylab(expression(bold(paste("Gross P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0))); GPplot1
```
 
Similarly, gross photosynthesis is higher in older colonies.  

### *Gross Photosynthesis:Respiration ratio *   

```{r, results=TRUE, warning=FALSE, message=FALSE}
PRplot1<-ggplot(data=PRdata, aes(x=dpf, y=ratio, colour=Lifestage, group=interaction(Lifestage, dpf))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  scale_color_brewer(palette = "Dark2", breaks=c("Larvae", "Recruit", "Juvenile"))+
  geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-2, 6), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  ylab(expression(bold(paste("P : R ")))) +
  xlab("Days Post Fertilization") +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "top",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=22), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0))); PRplot1
``` 

Finally, P:R ratio is similar in older colonies to larval timepoints, and higher than metamorphosed polyps. 


## **Plotting: Fused juveniles**

In this dataset, we measured metabolic rates of fused colonies to examine metabolic scaling in *M. capitata* juveniles. These data are for exploratory purposes only and are not included in the *M. capitata* developmental time series manuscript.  

### *Polyp Specific Rates*

Generate a plot for fused corals separately to examine respirometry normalized to the number polyps fused together within a colony. This generates polyp-specific metabolic rates.  
 
#### *Respiration*    

```{r, results=TRUE, warning=FALSE, message=FALSE}
FuseR1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=R.nmol.org.min, group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.1, 0.01), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("R (nmol ", O[2], " polyp"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));FuseR1
```

#### *Net Photosynthesis*  

```{r, results=TRUE, warning=FALSE, message=FALSE}
FuseP1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=P.nmol.org.min, group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.1, 0.4), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("Net P (nmol ", O[2], " polyp"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));FuseP1

```

#### *Gross Photosynthesis*    

```{r, results=TRUE, warning=FALSE, message=FALSE}
FuseGP1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=GP.nmol.org.min, group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.1, 0.4), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("Gross P (nmol ", O[2], " polyp"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));FuseGP1

```

#### *P:R ratio*    


```{r, results=TRUE, warning=FALSE, message=FALSE}
FusePR1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=ratio, group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-1, 8), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("P : R")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));FusePR1

```

### *Colony Total Rates*  

Now plot total colony respiration as a function of the number of polyps within each colony . 

#### *Respiration*  

```{r, results=TRUE, warning=FALSE, message=FALSE}
Fuse_c_R1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=(R.nmol.org.min*Org.Number), group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.4, 0.1), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("R (nmol ", O[2], " colony"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));Fuse_c_R1

```

#### *Net Photosynthesis*  

```{r, results=TRUE, warning=FALSE, message=FALSE}
Fuse_c_P1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=(P.nmol.org.min*Org.Number), group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.1, 0.8), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("Net P (nmol ", O[2], " colony"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));Fuse_c_P1

```

#### *Gross Photosynthesis*  

```{r, results=TRUE, warning=FALSE, message=FALSE}
Fuse_c_GP1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=(GP.nmol.org.min*Org.Number), group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-0.1, 0.8), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("Gross P (nmol ", O[2], " colony"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));Fuse_c_GP1

```

#### *P:R Ratio * 

```{r, results=TRUE, warning=FALSE, message=FALSE}
Fuse_c_PR1<-ggplot(data=fused_oxygen, aes(x=as.factor(Org.Number), y=(abs(fused_oxygen$GP.nmol.org.min*Org.Number)/abs(fused_oxygen$R.nmol.org.min*Org.Number)), group=interaction(Org.Number))) +
  geom_boxplot(position=position_dodge(0.9), lwd=1)+
  geom_jitter(shape=16, position=position_dodge(0.9), size=3)+
  geom_hline(yintercept=1, linetype="dashed", color="black", size=0.75)+
  scale_y_continuous(limits=c(-1, 10), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
  xlab("Number of Fused Polyps")+
  ylab(expression(bold(paste("P : R")))) +
  theme_classic() +
  theme(text = element_text(size = 18, color="black"),
        axis.text = element_text(size = 18, color="black"), 
        legend.position = "right",
        axis.title = element_text(size = 18, color="black", face="bold"), 
        legend.title=element_blank(), 
        legend.text = element_text(size=18), 
        plot.margin=unit(c(1,1,1,1), "cm"), 
        axis.title.y = element_text(margin = margin(t = 0, r = 1, b = 0, l = 1)), 
        axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)));Fuse_c_PR1

```


Overall, it appears that metabolic rates increase with colony size and there is either no effect or a slight decrease in polyp-specific metabolic rates with increasing fusion/colony size. 

## **Analysis: Fused Juveniles**  

### *Respiration*    

Analyze respiration at the level of the whole colony, or normalized at polyp-specific rates within each colony. Analyze across total number of polyps fused together.   

Build linear mixed effect model and examine for Respiration at the colony level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel2<-lmer((R.nmol.org.min*Org.Number)~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(Rmodel2, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions are met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel2))
hist(residuals(Rmodel2))
leveneTest(residuals(Rmodel2)~as.factor(Org.Number), data=fused_oxygen)
```

Build linear mixed effect model and examine for Respiration at the polyp level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel3<-lmer(R.nmol.org.min~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(Rmodel3, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel3))
hist(residuals(Rmodel3))
leveneTest(residuals(Rmodel3)~as.factor(Org.Number), data=fused_oxygen)
```

#### *Linear Regressions*  

Display linear regression of 1) colony respiration and 2) polyp respiration.   

Colony respiration:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
colony.R.effects <- predictorEffect(c("Org.Number"), Rmodel2) #set x axis

colony.effR<-plot(colony.R.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("purple"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-.4, 0.1))),
                   type="response", #set response scale
                   ylab=expression(bold("Colony Total Respiration")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");colony.effR
```

Polyp specific respiration:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
polyp.R.effects <- predictorEffect(c("Org.Number"), Rmodel3) #set x axis

polyp.effR<-plot(polyp.R.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("orange"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-.4, 0.1))),
                   type="response", #set response scale
                   ylab=expression(bold("Polyp Specific Respiration")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");polyp.effR
                   #lattice=list(key.args=list(space="right",
                                              #border=FALSE, 
                                              #title=expression(bold("Temperature - Fusion")),
                                              #cex=1, 
                                              #cex.title=1)))
```

In fused colonies, polyp-specific respiration and total colony respiration are both significantly affected by the size of the colony (number of fused polyps). Polyp specific respiration seems to decrease in larger colonies while total colony respiration increases. This may suggest that each constituent polyp "saves" energy being part of a larger fused colony. This is very interesting to think about!  

### *Net Photosynthesis*  

Analyze net photosynthesis at the level of the whole colony, or normalized at polyp-specific rates within each colony. Analyze across total number of polyps fused together.  

Build linear mixed effect model and examine for Net Photosynthesis at the colony level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
Pmodel2<-lmer((P.nmol.org.min*Org.Number)~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(Pmodel2, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions are met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Pmodel2))
hist(residuals(Pmodel2))
leveneTest(residuals(Pmodel2)~as.factor(Org.Number), data=fused_oxygen)
```

Build linear mixed effect model and examine for Net Photosynthesis at the polyp level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
Pmodel3<-lmer(P.nmol.org.min~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(Pmodel3, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Pmodel3))
hist(residuals(Pmodel3))
leveneTest(residuals(Pmodel3)~as.factor(Org.Number), data=fused_oxygen)
```

#### *Linear Regressions*  

Display linear regression of 1) colony net photosynthesis and 2) polyp net photosynthesis.     

Colony net photosynthesis:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
colony.NP.effects <- predictorEffect(c("Org.Number"), Pmodel2) #set x axis

colony.effNP<-plot(colony.NP.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("purple"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-0.1, 0.8))),
                   type="response", #set response scale
                   ylab=expression(bold("Colony Total Net Photosynthesis")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");colony.effNP
```

Polyp net photosynthesis:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
polyp.NP.effects <- predictorEffect(c("Org.Number"), Pmodel3) #set x axis

polyp.effNP<-plot(polyp.NP.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("orange"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-0.1, 0.8))),
                   type="response", #set response scale
                   ylab=expression(bold("Polyp Specific Net Photosynthesis")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");polyp.effNP
```

In fused colonies, net photosynthesis increases with larger fused colonies (significant), but polyp-specific net photosynthesis does not increase (not significant). This suggests that the capacity of each polyp to photosynthesize is not enhanced with fusion, but rather there is an additive effect of photosynthesis across the larger colony.  

### *Gross Photosynthesis*  

Analyze gross photosynthesis at the level of the whole colony, or normalized at polyp-specific rates within each colony. Analyze across total number of polyps fused together.  

Build linear mixed effect model and examine for Gross Photosynthesis at the colony level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
GPmodel2<-lmer((GP.nmol.org.min*Org.Number)~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(GPmodel2, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions are met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(GPmodel2))
hist(residuals(GPmodel2))
leveneTest(residuals(GPmodel2)~as.factor(Org.Number), data=fused_oxygen)
```

Build linear mixed effect model and examine for Gross Photosynthesis at the polyp level.     
```{r, results=TRUE, warning=FALSE, message=FALSE}
GPmodel3<-lmer(GP.nmol.org.min~Org.Number + (1|Run/dpf), data=fused_oxygen) #run nested within day
anova(GPmodel3, type="II")
```

Check assumptions of model for residual normality and variance. Potential normality violation, revisit.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(GPmodel3))
hist(residuals(GPmodel3))
leveneTest(residuals(GPmodel3)~as.factor(Org.Number), data=fused_oxygen)
```
#### *Linear Regressions*  

Display linear regression of 1) colony respiration and 2) polyp respiration.   

Colony gross photosynthesis:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
colony.GP.effects <- predictorEffect(c("Org.Number"), GPmodel2) #set x axis

colony.effGP<-plot(colony.GP.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("purple"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-0.1, 0.8))),
                   type="response", #set response scale
                   ylab=expression(bold("Colony Total Gross Photosynthesis")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");colony.effGP
```

Polyp gross photosynthesis:  
```{r, results=TRUE, warning=FALSE, message=FALSE}
polyp.GP.effects <- predictorEffect(c("Org.Number"), GPmodel3) #set x axis

polyp.effGP<-plot(polyp.GP.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("orange"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-0.1, 0.8))),
                   type="response", #set response scale
                   ylab=expression(bold("Polyp Specific Gross Photosynthesis")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");polyp.effGP
```

In fused colonies, gross photosynthesis has similar results as net photosynthesis, which makes sense. Gross photosynthesis increases with larger fused colonies (significant), but polyp-specific net photosynthesis does not increase (not significant). This suggests that the capacity of each polyp to photosynthesize is not enhanced with fusion, but rather there is an additive effect of photosynthesis across the larger colony. 

### *P:R * 
 
Build linear mixed effect model and examine for P:R ratio (gross photosynthesis : respiration). Ratios are the same when calculated for colony or polyp level, so displaying and analyzing at the polyp level here.      
```{r, results=TRUE, warning=FALSE, message=FALSE}
PRmodel2<-lmer(ratio~Org.Number + (1|Run/dpf), data=fused_oxygen)
anova(PRmodel2, type="II")
```

Check assumptions of model for residual normality and variance. Assumptions met.  

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(PRmodel2))
hist(residuals(PRmodel2))
leveneTest(residuals(PRmodel2)~as.factor(Org.Number), data=fused_oxygen)
```

#### *Linear Regression*  

P:R ratios:    
```{r, results=TRUE, warning=FALSE, message=FALSE}
ratio.effects <- predictorEffect(c("Org.Number"), PRmodel2) #set x axis

ratio.effGP<-plot(ratio.effects,
                   lines=list(multiline=TRUE, #color lines
                              col=c("black"), 
                              lty=c(1)), 
                   confint=list(style="bands", alpha=0.3), #set conf int
                   lwd=4,
                   axes=list(y=list(lim=c(-0.1, 8))),
                   type="response", #set response scale
                   ylab=expression(bold("P:R Ratio")), 
                   legend.position="top",
                   xlab=expression(bold("Number of Fused Polyps")), 
                   main="");ratio.effGP
```

P:R ratio does not significantly change over colony size. Juveniles at this age maintain positive P:R ratios (above 1) regardless of size.  This is likely achieved by reduced polyp-specific respiration balanced by increased colony total respiration, keeping respiratory demand consistent across colony sizes.    


