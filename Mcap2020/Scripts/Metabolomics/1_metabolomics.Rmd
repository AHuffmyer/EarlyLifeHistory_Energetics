---
title: Montipora capitata 2020 metabolomics analysis
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")

```


This script processes and prepares metabolomics data for analysis and conducts multivariate visualizations. The next step is conducting a WCNA in the `metabolomics_WGCNA.Rmd` script.  


# Data processing and exploration  

Data is provided for positive and negative polarities in separate files. In this script I process each polarity and then use polarity selection to generate a final dataframe of all metabolites.  

## Positive Polarity  

### Load data  
```{r}
#load datasets from two different run dates 
dataset1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

dataset2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data<-full_join(dataset1, dataset2)

#rename columns  
data<- data %>% 
  dplyr::rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30, 
    Recruit3plug_rep2 = Recruit.3_Plug_33, 
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38
    )

``` 
  
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data<- data %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE), 
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),          
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),            
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE), 
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE)
         )
```


Mutate the data to be in long rather than wide format.  

```{r}
data <- data %>% 
  gather(Sample, IonCounts, 71:123)

data <- data[c(9, 71,72)]
```

Add lifestage column for categorizing samples by lifestage.   

```{r}
data<-data%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data$Lifestage<-as.factor(data$Lifestage)

#remove samples that were from the earlier processing date - this is to remove any batch effects and only use samples that come from the largest run date
data<-data%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))


#add development column with larger categories 
data<-data%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                               if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage == "Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                               if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit", "NA"))))))))))))))

#add lifestage with hpf factor 
data<-data%>%
  mutate(HPF = if_else(Lifestage == "Egg", "Egg (1 hpf)", 
                               if_else(Lifestage =="Embryo", "Embryo (5 hpf)", 
                                       if_else(Lifestage == "Larvae1", "Embryo (38 hpf)", 
                                               if_else(Lifestage=="Larvae2", "Embryo (65 hpf)", 
                                               if_else(Lifestage=="Larvae3", "Larvae (93 hpf)", 
                                                       if_else(Lifestage == "Larvae4", "Larvae (163 hpf)",
                                                       if_else(Lifestage == "Larvae5", "Larvae (183 hpf)", 
                                                               if_else(Lifestage == "Larvae6", "Larvae (231 hpf)",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp (183 hpf)", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp (231 hpf)", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit (183 hpf)", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit (231 hpf)", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit (255 hpf)", "NA"))))))))))))))

data$HPF<-fct_relevel(data$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Metamorphosed Polyp (183 hpf)", "Attached Recruit (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting<-plyr::ddply(data, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_summary<-data_plotting[c(1,2,4)]

metab_compounds<-ggplot(data_summary, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds


```

This plot is not very useful due to high ion counts for some metabolites. We will instead use multivariate visualizations.  

### Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca<-data%>%
  spread(compound, IonCounts)

#remove columns with na's 
data_pca<-data_pca%>%
    select_if(~ !any(is.na(.)))

```

Plot PCA with lifestage in colors.  

```{r}
scaled.pca<-prcomp(data_pca[c(6:133)],scale=TRUE, center=TRUE) 

pcaPlot1<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="HPF", loadings=FALSE, colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

```

There are some interesting groupings by lifestage for positive polarity metabolites.  

## Negative Polarity  

Now repeat the process with negative polarity metabolites. 

### Load data
```{r}

#load data from both dates of runs 
data_neg1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

data_neg2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data_neg<-full_join(data_neg1, data_neg2)

#rename columns to be useful
data_neg<- data_neg %>% 
  dplyr::rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30,
    Recruit3plug_rep2 = Recruit.3_Plug_33,
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38)

```
 
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data_neg<- data_neg %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE),
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE),
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE))
```

Mutate the data to be in long rather than wide format.  

```{r}
data_neg <- data_neg %>% 
  gather(Sample, IonCounts, 71:123)

data_neg <- data_neg[c(9, 71, 72)]
```

Add lifestage column for categorizing lifestages.  

```{r}
data_neg<-data_neg%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data_neg$Lifestage<-as.factor(data_neg$Lifestage)

#remove samples from previous run date to remove any batch effects.  
data_neg<-data_neg%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))

data_neg<-data_neg%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                                if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage=="Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                                if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit", "NA"))))))))))))))

data_neg<-data_neg%>%
  mutate(HPF = if_else(Lifestage == "Egg", "Egg (1 hpf)", 
                               if_else(Lifestage =="Embryo", "Embryo (5 hpf)", 
                                       if_else(Lifestage == "Larvae1", "Embryo (38 hpf)", 
                                               if_else(Lifestage=="Larvae2", "Embryo (65 hpf)", 
                                               if_else(Lifestage=="Larvae3", "Larvae (93 hpf)", 
                                                       if_else(Lifestage == "Larvae4", "Larvae (163 hpf)",
                                                       if_else(Lifestage == "Larvae5", "Larvae (183 hpf)", 
                                                               if_else(Lifestage == "Larvae6", "Larvae (231 hpf)",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Polyp (183 hpf)", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Polyp (231 hpf)", 
                                                                               if_else(Lifestage =="Recruit1plug", "Attached Recruit (183 hpf)", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Attached Recruit (231 hpf)", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Attached Recruit (255 hpf)", "NA"))))))))))))))

data_neg$HPF<-fct_relevel(data_neg$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Metamorphosed Polyp (183 hpf)", "Attached Recruit (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (231 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")

data_neg$Development<-as.factor(data_neg$Development)

```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting_neg<-plyr::ddply(data_neg, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_summary_neg<-data_plotting_neg[c(1,2,4)]

metab_compounds_neg<-ggplot(data_summary_neg, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_neg

```

We will now visualize with multivariate methods.  

### Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca_neg<-data_neg%>%
  spread(compound, IonCounts)

#remove columns with na's 
data_pca_neg<-data_pca_neg%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA with lifestage in colors.  

```{r}
scaled.pca.neg<-prcomp(data_pca_neg[c(6:141)],scale=TRUE, center=TRUE) 

pcaPlot1_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1_neg

```

Generate a dataframe with normalized counts for positive and negative polarity datasets.  

```{r}
#merge two datasets such that mean in negative = "negative", and mean from positive = "positive". If not present, NA. 
data_summary_neg<-data_summary_neg%>%
    rename(Negative = mean)

data_summary<-data_summary%>%
    rename(Positive = mean)

#view normalized negative dataset
head(data_summary_neg)

head(data_summary)

#join datasets together
normalized_counts_pos_neg<-full_join(data_summary, data_summary_neg)

write_csv(normalized_counts_pos_neg, file="Mcap2020/Output/Metabolomics/normalized_counts_pos_neg.csv")
```

# Selecting metabolite polarity and generating final dataframe   

## Select polarity for each metabolite  

Use metabolite selection file to select polarity by averaging peaks across life stages for pos and neg peaks and choosing the strongest peaks. For example, if there is a higher ion count in the positive polarity than negative for that lifestage, only include the positive polarity data.  
 
```{r}
#data is positive and data_neg are negative dataframes  
data<-data%>%
  mutate(Polarity="Positive")

data_neg<-data_neg%>%
  mutate(Polarity="Negative")

data_full<-full_join(data, data_neg) #combine full positive and negative datasets

#change to wide format
data_full<-data_full%>%
  spread(Polarity, IonCounts)
```

Check for correlations between metabolites that have both positive and negative representation. We would expect that metabolites with higher ion counts will show higher counts across polarities.  

```{r}
correlation<-data_full

#only use complete observations
correlation<-correlation[complete.cases(correlation), ]
```

Display correlations for the metabolites with shared representation.  

```{r}
corrplots<-ggplot(data=correlation, aes(x=log(1+Positive), y=log(1+Negative)))+
  geom_point()+
  facet_wrap(~compound, scales="free")+
  geom_smooth(method='lm', color='red')+
  theme_classic()+
  theme(text=element_text(size=14, face="bold"));corrplots

ggsave("Mcap2020/Figures/Metabolomics/Correlation_plot.pdf", corrplots, width=20, height=16)
```

Relationship between positive and negative polarities are generally positive. Some of the relationships are stronger for certain metabolites and more variable for others.  

```{r}
#summarize across life stages and reps
polarity<-data_full%>%
  gather("Polarity", "IonCounts", 7:8)%>%
  group_by(Polarity, compound)%>%
  summarise(mean=mean(IonCounts, na.rm=TRUE))%>% #summarize across samples (lifestages)
  arrange(compound)%>% #list by compound
  replace_na(list(mean=0)) #replace NA with 0 to allow us to calculate higher values between polarities 

#add column of selected polarity based on stronger signal average
polarity<-polarity%>%
  spread(Polarity, mean)%>%
  mutate(Selection = ifelse(Negative > Positive, "Negative",
                     ifelse(Positive > Negative, "Positive", NA)))
  
```

Use the selected polarity key to select data for analysis.    

```{r}
#match selection column back onto original dataframe 
data_full$Selection<-polarity$Selection[match(data_full$compound, polarity$compound)] 

#pull out pos data
pos_peaks<-data_full%>%
  filter(Selection=="Positive")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Positive, Selection)%>%
  rename(value=Positive)
  
#pull out neg data
neg_peaks<-data_full%>%
  filter(Selection=="Negative")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Negative, Selection)%>%
  rename(value=Negative)

#rbind them together to generate a dataframe of positive and negative selected compounds
peaks_selected<-rbind(pos_peaks, neg_peaks)

peaks_selected<-peaks_selected %>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value) 
```

Add 1 to all values to account for 0 values and log transform.  
```{r}
hist(peaks_selected$value)

peaks_selected$log_norm_counts<-log10(1+peaks_selected$value)
hist(log(peaks_selected$log_norm_counts))
```

## Clean metabolite names and remove standards  

Remove PosIS and NegIS metabolites - these are internal standards that are not relevant for our samples. Clean any names that have (+HAc) and (+), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
grep("PosIS", levels(peaks_selected$compound)) #5 metabolites with PosIS, need to remove
grep("NegIS", levels(peaks_selected$compound)) #9 metabolites with NegIS, need to remove
grep("(HAc+)", levels(peaks_selected$compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(peaks_selected$compound)) #0 metabolites with SIM, need to rename

#HAC compounds are ones we want to keep, so we need to remove the compounds that dont use the HAc standards.  
#Glycerophosphocholine
#Phosphocholine
#CDP-Choline

peaks_selected<-peaks_selected%>%
  filter(!compound=="Glycerophosphocholine")
peaks_selected<-peaks_selected%>%
  filter(!compound=="Phosphocholine")
peaks_selected<-peaks_selected%>%
  filter(!compound=="CDP-Choline")

levels(peaks_selected$compound)

peaks_selected<- droplevels(peaks_selected)

length(levels(peaks_selected$compound)) #196 metabolites in data set before cleaning (removed the three from above)

peaks_selected_clean<-peaks_selected[!grepl("PosIS", peaks_selected$compound),] #remove POS
peaks_selected_clean<-peaks_selected_clean[!grepl("NegIS", peaks_selected_clean$compound),] #remove NEG
peaks_selected_clean<-droplevels(peaks_selected_clean)

length(levels(peaks_selected_clean$compound)) #182 metabolites in data set after cleaning (199-5-9=185), correct value

peaks_selected_clean<-peaks_selected_clean%>%
  mutate(compound = str_remove(compound, pattern=fixed('(+HAc)')))%>% #rename any with +HAc (would do the same here if you have SIM compounds)
  mutate(compound = as.factor(compound))

length(levels(peaks_selected_clean$compound))
```

Output file to .csv.   

```{r}
peaks_selected_clean%>%
  rename(norm_counts=value)%>%
  write_csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")
```

# PCA of combined polarities  

Run PCA to view differences in life stages with combined data frame after normalization and polarity selection.   

Convert data to wide format. 

```{r}
data_pca_full<-peaks_selected_clean%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value)%>%
  spread(compound, value)

#remove columns with na's
data_pca_full<-data_pca_full%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA and view scree plot with lifestage in colors.   

```{r}
scaled.pca<-prcomp(data_pca_full[c(5:186)],scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)

pcaPlot_full<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, ,loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) +
  #scale_fill_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         #legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full

```

Show a panel of PCA by positive, negative, and combined datasets.   
```{r}
pca_pos<-pcaPlot1+theme(legend.position="none")
pca_neg<-pcaPlot1_neg+theme(legend.position="none")

pcaplots<-plot_grid(pca_pos, pca_neg, pcaPlot_full, labels = c("Positive", "Negative", "Combined"), ncol=3, nrow=1, rel_widths = c(0.8, 0.8, 1), label_size = 20, label_x = 0.1);pcaplots

ggsave(filename="Mcap2020/Figures/Metabolomics/All_PCAs.pdf", plot=pcaplots, dpi=300, width=20, height=5, units="in")
```  

There are groupings by lifestage that we will explore with PLS-DA analyses.  

## Conduct PERMANOVA by developmental time point  

Build PERMANOVA model.  
```{r}
fviz_eig(scaled.pca)

# scale data
vegan <- scale(data_pca_full[c(5:186)])

# PerMANOVA 
permanova<-adonis2(vegan ~ HPF, data = data_pca_full, method='eu')
permanova
```

Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = vegan ~ HPF, data = data_pca_full, method = "eu")
         Df SumOfSqs      R2     F Pr(>F)    
HPF      12   5390.3 0.64384 5.122  0.001 ***
Residual 34   2981.7 0.35616                 
Total    46   8372.0 1.00000                 

# PLS-DA analysis  

Load data if starting from this point in the script.    

```{r}
metabolites <- read.csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")

metabolites<-metabolites%>%
  drop_na() #remove samples with na's
  
```

log_norm_count indicates normalized ion counts that are log transformed for analysis.   

## Generate PLS-DA for lifestage timepoint    

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- metabolites%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

levels(as.factor(X$HPF))

X$HPF<-fct_relevel(X$HPF, "Egg (1 hpf)", "Embryo (5 hpf)", "Embryo (38 hpf)", "Embryo (65 hpf)", "Larvae (93 hpf)", "Larvae (163 hpf)", "Larvae (183 hpf)", "Larvae (231 hpf)", "Metamorphosed Polyp (183 hpf)","Metamorphosed Polyp (231 hpf)", "Attached Recruit (183 hpf)", "Attached Recruit (231 hpf)", "Attached Recruit (255 hpf)")

levels(as.factor(X$HPF))

Y <- as.factor(X$HPF) #select treatment names
Y

X<-X[5:186] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y) # 1 Run the method
plotIndiv(MyResult.plsda)    # 2 Plot the samples
plotVar(MyResult.plsda, cutoff = 0.7)    

levels(Y)

lifestage_cols<-c("#8C510A", #eggs
                  "#DFC27D", "#DAB869", "#E4CC91", #embryos
                  "#80CDC1", "#5BBFAF", "#6EC6B8", "#92D4CA", #larvae
                  "#003C30", "#00231C", #polyp
                  "#BA55D3","#B241CE", "#A632C3") #recruits
            

#Egg: "#8C510A", 
#Embryo: "#DFC27D", "#DAB869", "#E4CC91", "#D5AF54"
#Larvae: "#80CDC1", "#5BBFAF", "#6EC6B8", "#92D4CA"
#Polyp Metamorphosed: "#003C30", "#00231C", "005644", "006F59"
#Recruit Attached: "#BA55D3", "B241CE", "A632C3"

pch.input = c(1, 2, 3, 4, 5, 6, 7 ,8, 9, 10, 11, 12, 13)

pdf("Mcap2020/Figures/Metabolomics/PLSDA_Lifestage.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=lifestage_cols, ind.names = FALSE, legend=TRUE, legend.title = "Lifestage", ellipse = FALSE, title="", pch=pch.input, style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=lifestage_cols, ind.names = FALSE, legend=TRUE, legend.title = "Lifestage", ellipse = TRUE, title="", pch=pch.input, style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)

pdf("Mcap2020/Figures/Metabolomics/CIM_Lifestage.pdf", width=35, height=7)
cim(MyResult.plsda, mapping="Y", row.names = metabolites$HPF, xlab = "Metabolites", ylab="Lifestage", margins=c(10,10), row.cex=0.5)
dev.off()
```

```{r, message=FALSE}
MyResult.plsda_timepoint <- plsda(X,Y, ncomp=9) #number of components is classes-1
```


# Extract VIP scores from PLS-DA's   

View the metabolites that are most highly differentiating metabolites.     

```{r}
#extract
Timepoint_VIP <- PLSDA.VIP(MyResult.plsda_timepoint)
Timepoint_VIP_DF <- as.data.frame(Timepoint_VIP[["tab"]])
Timepoint_VIP_DF

# Converting row names to column
Timepoint_VIP_table <- rownames_to_column(Timepoint_VIP_DF, var = "Metabolite")

#filter for VIP > 1
Timepoint_VIP_1 <- Timepoint_VIP_table %>% 
  filter(VIP >= 1)

#write_csv(Timepoint_VIP_1, "Mcap2020/Output/Metabolomics/Overall_Timepoint_VIPs.csv")

#plot
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Lifestage VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("Mcap2020/Figures/Metabolomics/Lifestage_VIP.pdf", width=6, height=11)
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Lifestage VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation in lifestage. But, this does not provide lists of VIP's between specific life stages or global correlations of metabolites with specific lifestages. In the following section we generate lists of VIPs between subsequent lifestages. In the metabolomics_WGCNA.Rmd script, we use a WGCNA approach to determine metabolites that correlate with lifestage, which we use as the primary analysis.  

## Generate VIPs for developmental group comparisons 

### 1. Eggs vs embryos   

Conduct t-tests to validate differences in VIP metabolites.    

```{r}
list<-c("Egg", "Embryo")
#assigning datasets 
X <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:186] #pull only data columns

MyResult.plsda_EvE <- plsda(X,Y, ncomp=4)

#extract
EvE_VIP <- PLSDA.VIP(MyResult.plsda_EvE)
EvE_VIP_DF <- as.data.frame(EvE_VIP[["tab"]])

# Converting row names to column
EvE_VIP_table <- rownames_to_column(EvE_VIP_DF, var = "Metabolite")

#filter for VIP > 1
EvE_VIP_1 <- EvE_VIP_table %>% 
  filter(VIP >= 1)

```

```{r}
EvE_clean <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  group_by(compound)

levels(EvE_clean$Development) #check order of factor for comparisons  

# Select metabolites only present from the PLS-DA with VIPs >1
EvE_VIP_Select <- subset(EvE_clean, EvE_clean$compound %in% EvE_VIP_1$Metabolite)

#Looped t-test for all metabolites with VIPs >1
EvE_t.test <-do(EvE_VIP_Select, tidy(t.test(.$log_norm_counts ~ .$Development,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 )))

#adjust p value for the number of comparisons 
EvE_t.test$p.adj<-p.adjust(EvE_t.test$p.value, method=c("fdr"), n=length(EvE_VIP_1$Metabolite))

# Filter for significantly different metabolites (p < 0.05)
EvE_t.test.sig <- EvE_t.test %>% filter(p.adj < 0.05)
length(EvE_t.test.sig$compound)
#went from 73 down to 66 with p value adjustment

# Filter for metabolites accumulated compared to egg
EvE_t.test.sig.up <- EvE_t.test.sig %>% filter(estimate1 > estimate2)

# Filter for metabolites depleted compared to egg
EvE_t.test.sig.down <- EvE_t.test.sig %>% filter(estimate1 < estimate2)

```

Display metabolites that are higher in embryos compared to eggs  

```{r}
EvE_t.test.sig.up
EvE_t.test.sig.up$direction<-c("Increase")
EvE_t.test.sig.up$lifestage<-c("Embryo")
```

Display metabolites that are lower in embryos compared to eggs  

```{r}
EvE_t.test.sig.down
EvE_t.test.sig.down$direction<-c("Decrease")
EvE_t.test.sig.down$lifestage<-c("Egg")
```

Group dataframe for use in plotting.  

```{r}
EvE_pvalues<-rbind(EvE_t.test.sig.up, EvE_t.test.sig.down)

EvE_pvalues<-EvE_pvalues%>%
  dplyr::select(compound, direction, lifestage)%>%
  dplyr::rename(Metabolite=compound)


EvE_VIP_plot<-left_join(EvE_VIP_1, EvE_pvalues, by="Metabolite")

EvE_VIP_plot$direction[is.na(EvE_VIP_plot$direction)] <- c("Nonsig")
EvE_VIP_plot$direction<-as.factor(EvE_VIP_plot$direction)

#write_csv(EvE_VIP_plot, "Mcap2020/Output/Metabolomics/EvE_VIPs.csv")
```

Plot VIP plot. Remove nonsignificant metabolites determined by t test validations.       

```{r}

#plot
EvE_plota<-EvE_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("white", "#DFC27D"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Eggs < Embryos"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

EvE_plotb<-EvE_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("#8C510A", "white"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Eggs > Embryos"))) +
  scale_x_reverse()+
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank(), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

#arrange plots
EvE_plots<-plot_grid(EvE_plotb, EvE_plota, ncol=2, rel_widths=c(0.6,1), rel_heights = c(1,1))
#ggsave("Mcap2020/Figures/Metabolomics/EggsEmbryo_VIP.pdf", width=7, height=9, units="in")

```

Plot as differential bar plots.  

```{r}
#plot
EvE_bar<-EvE_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  mutate(score=if_else(direction=="Decrease", 0-VIP, VIP)) %>% #change metabolites that decrease to have VIP on the negative scale
  arrange(score) %>%
  ggplot(aes(y = score, x = reorder(Metabolite,score,sum))) +
  geom_bar(aes(fill=direction), show.legend=FALSE, stat='identity') +
  scale_fill_manual(values=c("#8C510A", "#DFC27D"))+
  ylab("VIP Score") +
  xlab("") +
  scale_y_continuous(limits=c(-2, 2), breaks=c(-1,0,1))+
  annotate("text", x = 7, y = 1.4, label = "Embryo > Egg", fontface =2, color="#DFC27D", size=6) +
  annotate("text", x = 47, y = -1.4, label = "Egg > Embryo", fontface =2, color="#8C510A", size=6) +
  #ggtitle(expression(bold("Eggs < Embryos"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle=45, vjust=.5)); EvE_bar

#ggsave("Mcap2020/Figures/Metabolomics/EggsEmbryo_VIP_bar.pdf", width=10, height=4, units="in")

```

### 2. Embryos vs larvae  

Conduct t-tests to validate differences in VIP metabolites.   
 
```{r}
list<-c("Embryo", "Larvae")
#assigning datasets 
X <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:186] #pull only data columns

MyResult.plsda_EvL <- plsda(X,Y, ncomp=4)

#extract
EvL_VIP <- PLSDA.VIP(MyResult.plsda_EvL)
EvL_VIP_DF <- as.data.frame(EvL_VIP[["tab"]])

# Converting row names to column
EvL_VIP_table <- rownames_to_column(EvL_VIP_DF, var = "Metabolite")

#filter for VIP > 1
EvL_VIP_1 <- EvL_VIP_table %>% 
  filter(VIP >= 1)

EvL_clean <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  group_by(compound)

levels(EvL_clean$Development) #check order of factor for comparisons  

# Select metabolites only present from the PLS-DA with VIPs >1
EvL_VIP_Select <- subset(EvL_clean, EvL_clean$compound %in% EvL_VIP_1$Metabolite)

#Looped t-test for all metabolites with VIPs >1, estimate 1 = Bleached_Hot, estimate 2 = Control
EvL_t.test <-do(EvL_VIP_Select, tidy(t.test(.$log_norm_counts ~ .$Development,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 )))

#adjust p value for the number of comparisons 
EvL_t.test$p.adj<-p.adjust(EvL_t.test$p.value, method=c("fdr"), n=length(EvL_VIP_1$Metabolite)) #length = number of metabolites tested, false discovery rate

# Filter for significantly different metabolites (p < 0.05)
EvL_t.test.sig <- EvL_t.test %>% filter(p.adj < 0.05)
length(EvL_t.test.sig$compound)
#drops from 100 to 99 with adjustment

# Filter for metabolites accumulated compared to egg
EvL_t.test.sig.up <- EvL_t.test.sig %>% filter(estimate1 > estimate2)

# Filter for metabolites depleted compared to egg
EvL_t.test.sig.down <- EvL_t.test.sig %>% filter(estimate1 < estimate2)

```

Display metabolites that are higher in larvae compared to embryos  

```{r}
EvL_t.test.sig.up
EvL_t.test.sig.up$direction<-c("Increase")
EvL_t.test.sig.up$lifestage<-c("Larvae")
```

Display metabolites that are lower in larvae compared to embryos  

```{r}
EvL_t.test.sig.down
EvL_t.test.sig.down$direction<-c("Decrease")
EvL_t.test.sig.down$lifestage<-c("Embryo")
```

Group dataframe for use in plotting.  

```{r}
EvL_pvalues<-rbind(EvL_t.test.sig.up, EvL_t.test.sig.down)

EvL_pvalues<-EvL_pvalues%>%
  dplyr::select(compound, direction, lifestage)%>%
  rename(Metabolite=compound)
```

Plot VIP plot. Remove nonsignificant metabolites determined by t test validations.       

```{r}

EvL_VIP_plot<-left_join(EvL_VIP_1, EvL_pvalues, by="Metabolite")

EvL_VIP_plot$direction[is.na(EvL_VIP_plot$direction)] <- c("Nonsig")
EvL_VIP_plot$direction<-as.factor(EvL_VIP_plot$direction)

#write_csv(EvL_VIP_plot, "Mcap2020/Output/Metabolomics/EvL_VIPs.csv")

#plot
EvL_plota<-EvL_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("white", "#80CDC1"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Embryos < Larvae"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

EvL_plotb<-EvL_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("#DFC27D", "white"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Embryos > Larvae"))) +
  scale_x_reverse()+
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank(), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

#arrange plots
EvL_plots<-plot_grid(EvL_plotb, EvL_plota, ncol=2, rel_widths=c(0.6,1), rel_heights = c(1,1))
#ggsave("Mcap2020/Figures/Metabolomics/EmbryoLarvae_VIP.pdf", width=7, height=11, units="in")
```

Plot as differential bar plots.  

```{r}
#plot
EvL_bar<-EvL_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  mutate(score=if_else(direction=="Decrease", 0-VIP, VIP)) %>% #change metabolites that decrease to have VIP on the negative scale
  arrange(score) %>%
  ggplot(aes(y = score, x = reorder(Metabolite,score,sum))) +
  geom_bar(aes(fill=direction), show.legend=FALSE, stat='identity') +
  scale_fill_manual(values=c("#DFC27D", "#80CDC1"))+
  ylab("VIP Score") +
  scale_y_continuous(limits=c(-2, 2), breaks=c(-1,0,1))+
  xlab("") +
  annotate("text", x = 10, y = 1.4, label = "Larvae > Embryo", fontface =2, color="#80CDC1", size=6) +
  annotate("text", x = 90, y = -1.4, label = "Embryo > Larvae", fontface =2, color="#DFC27D", size=6) +
  #ggtitle(expression(bold("Eggs < Embryos"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle=45, vjust=.5), plot.margin=margin(4,30,4,4)); EvL_bar

#ggsave("Mcap2020/Figures/Metabolomics/EmbryoLarvae_VIP_bar.pdf", width=18, height=4, units="in")

```

### 3. Larvae vs metamorphosed recruits  

Conduct t-tests to validate differences in VIP metabolites.    

```{r}
list<-c("Larvae", "Metamorphosed Polyp")
#assigning datasets 
X <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:186] #pull only data columns

MyResult.plsda_LvM <- plsda(X,Y, ncomp=4)

#extract
LvM_VIP <- PLSDA.VIP(MyResult.plsda_LvM)
LvM_VIP_DF <- as.data.frame(LvM_VIP[["tab"]])

# Converting row names to column
LvM_VIP_table <- rownames_to_column(LvM_VIP_DF, var = "Metabolite")

#filter for VIP > 1
LvM_VIP_1 <-LvM_VIP_table %>% 
  filter(VIP >= 1)

LvM_clean <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  group_by(compound)

levels(LvM_clean$Development) #check order of factor for comparisons  

# Select metabolites only present from the PLS-DA with VIPs >1
LvM_VIP_Select <- subset(LvM_clean, LvM_clean$compound %in% LvM_VIP_1$Metabolite)

#Looped t-test for all metabolites with VIPs >1, estimate 1 = Bleached_Hot, estimate 2 = Control
LvM_t.test <-do(LvM_VIP_Select, tidy(t.test(.$log_norm_counts ~ .$Development,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 )))

#adjust p value for the number of comparisons 
LvM_t.test$p.adj<-p.adjust(LvM_t.test$p.value, method=c("fdr"), n=length(LvM_VIP_1$Metabolite)) #length = number of metabolites tested, false discovery rate

# Filter for significantly different metabolites (p < 0.05)
LvM_t.test.sig <- LvM_t.test %>% filter(p.adj <= 0.05)
length(LvM_t.test.sig$compound)
#went from 67 to 38 with p value adjustment

# Filter for metabolites accumulated compared to larvae
LvM_t.test.sig.up <- LvM_t.test.sig %>% filter(estimate1 > estimate2)

# Filter for metabolites depleted compared to larvae
LvM_t.test.sig.down <-LvM_t.test.sig %>% filter(estimate1 < estimate2)

```


```{r}
LvM_t.test.sig.up
LvM_t.test.sig.up$direction<-c("Increase")
LvM_t.test.sig.up$lifestage<-c("Metamorphosed Polyp")
```


```{r}
LvM_t.test.sig.down
LvM_t.test.sig.down$direction<-c("Decrease")
LvM_t.test.sig.down$lifestage<-c("Larvae")
```

```{r}
LvM_pvalues<-rbind(LvM_t.test.sig.up, LvM_t.test.sig.down)
 
LvM_pvalues<-LvM_pvalues%>%
   dplyr::select(compound, direction, lifestage)%>%
   rename(Metabolite=compound)
```

```{r}
 LvM_VIP_plot<-left_join(LvM_VIP_1, LvM_pvalues, by="Metabolite")
 
 LvM_VIP_plot$direction[is.na(LvM_VIP_plot$direction)] <- c("Nonsig")
 LvM_VIP_plot$direction<-as.factor(LvM_VIP_plot$direction)
 
 #write_csv(LvM_VIP_plot, "Mcap2020/Output/Metabolomics/LvM_VIPs.csv")
 
 #plot
 LvM_plota<-LvM_VIP_plot %>%
   filter(!direction=="Nonsig")%>%
   arrange(VIP) %>%
   ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
   scale_colour_manual(values=c("white", "#003C30"))+
   ylab("") +
   xlab("VIP Score") +
   ggtitle(expression(bold("Larvae < \nMetamorpohsed Recruit"))) +
   theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.margin=margin(t=15, r=4), plot.title=element_text(hjust=0.5, size=10))
 
 LvM_plotb<-LvM_VIP_plot %>%
   filter(!direction=="Nonsig")%>%
   arrange(VIP) %>%
   ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
   geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
   scale_colour_manual(values=c("#80CDC1", "white"))+
   ylab("") +
   xlab("VIP Score") +
   ggtitle(expression(bold("Larvae > \nMetamorphosed Recruit"))) +
   scale_x_reverse()+
   theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank(), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5, size=10), plot.margin=margin(t=15))
 
 #arrange plots
 LvM_plots<-plot_grid(LvM_plotb, LvM_plota, ncol=2, rel_widths=c(0.6,1), rel_heights = c(1,1))
 #ggsave("Mcap2020/Figures/Metabolomics/LarvaeMetamorphosed_VIP.pdf", width=5, height=7, units="in")
```

```{r}
 #plot
 LvM_bar<-LvM_VIP_plot %>%
   filter(!direction=="Nonsig")%>%
   mutate(score=if_else(direction=="Decrease", 0-VIP, VIP)) %>% #change metabolites that decrease to have VIP on the negative scale
   arrange(score) %>%
   ggplot(aes(y = score, x = reorder(Metabolite,score,sum))) +
   geom_bar(aes(fill=direction), show.legend=FALSE, stat='identity') +
   scale_fill_manual(values=c("#80CDC1", "#003C30"))+
   ylab("VIP Score") +
   scale_y_continuous(limits=c(-2.5, 2.5), breaks=c(-1,0,1))+
   xlab("") +
   annotate("text", x = 6, y = 1.4, label = "Metamorpohsed Recruit > \nLarvae", fontface =2, color="#003C30") +
   annotate("text", x = 30, y = -1.8, label = "Larvae > \nMetamorphosed Recruit", fontface =2, color="#80CDC1") +
   #ggtitle(expression(bold("Eggs < Embryos"))) +
   theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle=45, vjust=.5), plot.margin=margin(4,30,4,4)); LvM_bar
 
 #ggsave("Mcap2020/Figures/Metabolomics/LarvaeMetamorphosed_VIP_bar.pdf", width=8, height=4, units="in")

```


### 4. Larvae vs calcifying recruits  
 
Conduct t-tests to validate differences in VIP metabolites.   
 
```{r}
list<-c("Attached Recruit", "Larvae")

#assigning datasets 
X <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:186] #pull only data columns

MyResult.plsda_LvC <- plsda(X,Y, ncomp=4)

#extract
LvC_VIP <- PLSDA.VIP(MyResult.plsda_LvC)
LvC_VIP_DF <- as.data.frame(LvC_VIP[["tab"]])

# Converting row names to column
LvC_VIP_table <- rownames_to_column(LvC_VIP_DF, var = "Metabolite")

#filter for VIP > 1
LvC_VIP_1 <- LvC_VIP_table %>% 
  filter(VIP >= 1)

LvC_clean <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  group_by(compound)

levels(LvC_clean$Development) #check order of factor for comparisons  

# Select metabolites only present from the PLS-DA with VIPs >1
LvC_VIP_Select <- subset(LvC_clean, LvC_clean$compound %in% LvC_VIP_1$Metabolite)

#Looped t-test for all metabolites with VIPs >1, estimate 1 = Bleached_Hot, estimate 2 = Control
LvC_t.test <-do(LvC_VIP_Select, tidy(t.test(.$log_norm_counts ~ .$Development,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 )))

#adjust p value for the number of comparisons 
LvC_t.test$p.adj<-p.adjust(LvC_t.test$p.value, method=c("fdr"), n=length(LvC_VIP_1$Metabolite)) #length = number of metabolites tested, false discovery rate

# Filter for significantly different metabolites (p < 0.05)
LvC_t.test.sig <- LvC_t.test %>% filter(p.adj <= 0.05)
length(LvC_t.test.sig$compound)
#went from 75 to 75 with p value adjustment

# Filter for metabolites accumulated compared to egg
LvC_t.test.sig.up <- LvC_t.test.sig %>% filter(estimate1 > estimate2)

# Filter for metabolites depleted compared to egg
LvC_t.test.sig.down <- LvC_t.test.sig %>% filter(estimate1 < estimate2)

```

Display metabolites that are higher in larvae compared to calcifying recruits, note that directions are opposite due to order of factors  

```{r}
LvC_t.test.sig.up
LvC_t.test.sig.up$direction<-c("Decrease")
LvC_t.test.sig.up$lifestage<-c("Larvae")
```

Display metabolites that are lower in larvae compared to calcifying recruits, note that directions are opposite due to order of factors

```{r}
LvC_t.test.sig.down
LvC_t.test.sig.down$direction<-c("Increase")
LvC_t.test.sig.down$lifestage<-c("AttachedRecruit")
```

Group dataframe for use in plotting.  

```{r}
LvC_pvalues<-rbind(LvC_t.test.sig.up, LvC_t.test.sig.down)

LvC_pvalues<-LvC_pvalues%>%
  dplyr::select(compound, direction, lifestage)%>%
  rename(Metabolite=compound)
```

Plot VIP plot. Remove nonsignificant metabolites determined by t test validations.       

```{r}

LvC_VIP_plot<-left_join(LvC_VIP_1, LvC_pvalues, by="Metabolite")

LvC_VIP_plot$direction[is.na(LvC_VIP_plot$direction)] <- c("Nonsig")
LvC_VIP_plot$direction<-as.factor(LvC_VIP_plot$direction)

#write_csv(LvC_VIP_plot, "Mcap2020/Output/Metabolomics/LvC_VIPs.csv")

#plot
LvC_plota<-LvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("white", "#BA55D3"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Larvae < Attached Recruits"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

LvC_plotb<-LvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("#80CDC1", "white"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Larvae > Attached Recruits"))) +
  scale_x_reverse()+
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank(), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5))

#arrange plots
LvC_plots<-plot_grid(LvC_plotb, LvC_plota, ncol=2, rel_widths=c(0.6,1), rel_heights = c(1,1))
#ggsave("Mcap2020/Figures/Metabolomics/LarvaeCalcifying_VIP.pdf", width=7, height=11, units="in")
```

Plot as differential bar plots.  

```{r}
#plot
LvC_bar<-LvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  mutate(score=if_else(direction=="Decrease", 0-VIP, VIP)) %>% #change metabolites that decrease to have VIP on the negative scale
  arrange(score) %>%
  ggplot(aes(y = score, x = reorder(Metabolite,score,sum))) +
  geom_bar(aes(fill=direction), show.legend=FALSE, stat='identity') +
  scale_fill_manual(values=c("#80CDC1", "#BA55D3"))+
  ylab("VIP Score") +
  scale_y_continuous(limits=c(-2, 2), breaks=c(-1,0,1))+
  xlab("") +
  annotate("text", x = 10, y = 1.6, label = "Attached Recruit > \nLarvae", fontface =2, color="#BA55D3") +
  annotate("text", x = 60, y = -1.6, label = "Larvae > \nAttached Recruit", fontface =2, color="#80CDC1") +
  #ggtitle(expression(bold("Eggs < Embryos"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle=45, vjust=.5), plot.margin=margin(4,30,4,4)); LvC_bar

#ggsave("Mcap2020/Figures/Metabolomics/LarvaeAttached_VIP_bar.pdf", width=12, height=4, units="in")

```

### 5. Metamorphosed vs attached recruits  

Conduct t-tests to validate differences in VIP metabolites.   
  
```{r}
list<-c("Attached Recruit", "Metamorphosed Polyp")
#assigning datasets 
X <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:186] #pull only data columns

MyResult.plsda_MvC <- plsda(X,Y, ncomp=4)

#extract
MvC_VIP <- PLSDA.VIP(MyResult.plsda_MvC)
MvC_VIP_DF <- as.data.frame(MvC_VIP[["tab"]])

# Converting row names to column
MvC_VIP_table <- rownames_to_column(MvC_VIP_DF, var = "Metabolite")

#filter for VIP > 1
MvC_VIP_1 <- MvC_VIP_table %>% 
  filter(VIP >= 1)

MvC_clean <- metabolites%>%
  filter(Development %in% list)%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  group_by(compound)

levels(MvC_clean$Development) #check order of factor for comparisons  

# Select metabolites only present from the PLS-DA with VIPs >1
MvC_VIP_Select <- subset(MvC_clean, MvC_clean$compound %in% MvC_VIP_1$Metabolite)

#Looped t-test for all metabolites with VIPs >1, estimate 1 = Bleached_Hot, estimate 2 = Control
MvC_t.test <-do(MvC_VIP_Select, tidy(t.test(.$log_norm_counts ~ .$Development,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 )))

#adjust p value for the number of comparisons 
MvC_t.test$p.adj<-p.adjust(MvC_t.test$p.value, method=c("fdr"), n=length(MvC_VIP_1$Metabolite)) #length = number of metabolites tested, false discovery rate

# Filter for significantly different metabolites (p < 0.05)
MvC_t.test.sig <- MvC_t.test %>% filter(p.adj <= 0.05)
length(MvC_t.test.sig$compound)
#went from 71 to 68 with p value adjustment

# Filter for metabolites accumulated compared to egg
MvC_t.test.sig.up <- MvC_t.test.sig %>% filter(estimate1 > estimate2)

# Filter for metabolites depleted compared to egg
MvC_t.test.sig.down <- MvC_t.test.sig %>% filter(estimate1 < estimate2)

```

Display metabolites that are higher in metamorphosed recruits compared to calcifying recruits, note that directions are opposite due to order of factors  
 
```{r}
MvC_t.test.sig.up
MvC_t.test.sig.up$direction<-c("Decrease")
MvC_t.test.sig.up$lifestage<-c("MetamorphosedPolyp")
```

Display metabolites that are lower in metamorphosed recruits compared to calcifying recruits, note that directions are opposite due to order of factors

```{r}
MvC_t.test.sig.down
MvC_t.test.sig.down$direction<-c("Increase")
MvC_t.test.sig.down$lifestage<-c("AttachedRecruit")
```

Group dataframe for use in plotting.  

```{r}
MvC_pvalues<-rbind(MvC_t.test.sig.up, MvC_t.test.sig.down)

MvC_pvalues<-MvC_pvalues%>%
  dplyr::select(compound, direction, lifestage)%>%
  rename(Metabolite=compound)
```

Plot VIP plot. Remove nonsignificant metabolites determined by t test validations.       
 
```{r}

MvC_VIP_plot<-left_join(MvC_VIP_1, MvC_pvalues, by="Metabolite")

MvC_VIP_plot$direction[is.na(MvC_VIP_plot$direction)] <- c("Nonsig")
MvC_VIP_plot$direction<-as.factor(MvC_VIP_plot$direction)

#write_csv(MvC_VIP_plot, "Mcap2020/Output/Metabolomics/MvC_VIPs.csv")

#plot
MvC_plota<-MvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("white", "#BA55D3"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Metamorpohsed Polyps < \nAttached Recruits"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), plot.margin=margin(t=15))

MvC_plotb<-MvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(aes(colour=direction), size=3, show.legend=FALSE) +
  scale_colour_manual(values=c("#003C30", "white"))+
  ylab("") +
  xlab("VIP Score") +
  ggtitle(expression(bold("Metamorphosed Polyps > \nAttached Recruits"))) +
  scale_x_reverse()+
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank(), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), plot.margin=margin(t=15))

#arrange plots
MvC_plots<-plot_grid(MvC_plotb, MvC_plota, ncol=2, rel_widths=c(0.6,1), rel_heights = c(1,1))
#ggsave("Mcap2020/Figures/Metabolomics/MetamorphosedCalcifying_VIP.pdf", width=7, height=11, units="in")
```

Plot as differential bar plots.  

```{r}
#plot
MvC_bar<-MvC_VIP_plot %>%
  filter(!direction=="Nonsig")%>%
  mutate(score=if_else(direction=="Decrease", 0-VIP, VIP)) %>% #change metabolites that decrease to have VIP on the negative scale
  arrange(score) %>%
  ggplot(aes(y = score, x = reorder(Metabolite,score,sum))) +
  geom_bar(aes(fill=direction), show.legend=FALSE, stat='identity') +
  scale_fill_manual(values=c("#003C30", "#BA55D3"))+
  ylab("VIP Score") +
  scale_y_continuous(limits=c(-2, 2), breaks=c(-1,0,1))+
  xlab("") +
  annotate("text", x = 10, y = 1.6, label = "Attached Recruits > \nMetamorphosed Polyps", fontface =2, color="#BA55D3") +
  annotate("text", x = 50, y = -1.6, label = "Metamorphosed Polyps > \nAttached Recruits", fontface =2, color="#003C30") +
  #ggtitle(expression(bold("Eggs < Embryos"))) +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(face="bold", hjust=0.5), axis.ticks.y=element_blank(), plot.title=element_text(hjust=0.5), axis.text.x = element_text(angle=45, vjust=.5), plot.margin=margin(4,30,4,4)); MvC_bar

#ggsave("Mcap2020/Figures/Metabolomics/MetamorphosedCalcifying_VIP_bar.pdf", width=11, height=4, units="in")

```


### 6. Combine all VIP plots.   

```{r}
VIP_plots<-plot_grid(EvE_plots, EvL_plots, LvC_plots, MvC_plots, ncol=1, nrow=4, rel_widths=c(1,1,1,1), rel_heights=c(1.2,2,1.5,1.2))
#ggsave("Mcap2020/Figures/Metabolomics/VIP_panel.pdf", width=7, height=48, units="in")
```
 
Combine all differential bar plots.  

```{r}
VIP_bar_plots1<-plot_grid(EvE_bar, EvL_bar, ncol=2, nrow=1, rel_widths=c(1,1.5), rel_heights=c(1,1), align="vh")
VIP_bar_plots2<-plot_grid(LvC_bar, LvM_bar, MvC_bar, ncol=3, nrow=1, rel_widths=c(1,1,1), rel_heights=c(1,1,1), align="vh")
VIP_bar_plots<-plot_grid(VIP_bar_plots1, VIP_bar_plots2, ncol=1, nrow=2, rel_widths=c(1,1), rel_heights=c(1,1), align="vh")

ggsave(plot=VIP_bar_plots, "Mcap2020/Figures/Metabolomics/VIP_bars.pdf", width=30, height=10, units="in")
```

# Validation of PLS-DA and generation of sPLS-DA  

## Lifestage   

Validate PLS-DA.   

Generate error plot  
```{r}
set.seed(30) 
MyPerf.plsda <- perf(MyResult.plsda_timepoint, validation = "Mfold", folds=4,  
                     progressBar = TRUE, nrepeat = 50) 

#MyPerf.plsda <- perf(MyResult.plsda2, validation = "loo") #using Loo correction since the number of groups I have is low, once more samples are available I can try using the Mfold validation

plot(MyPerf.plsda,  sd = TRUE)
```

This plot shows that error rate is reduced with higher number of components. 

Generate plot with specified number of components  
```{r}
# Assessing optimal number of variables to keep 
list.keepX <- c(5:10,  seq(20, 300, 10))
#list.keepX # to output the grid of values tested

X <- metabolites%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$HPF) #select treatment names

X<-X[5:186] #pull only data columns

set.seed(30) # for reproducbility in this vignette, otherwise increase nrepeat
tune.splsda.srbct <- tune.splsda(X, Y, ncomp = 10, 
                                 validation = 'Mfold', folds=4,
                                 measure = "BER", test.keepX = list.keepX, nrepeat=50)   # we suggest nrepeat = 50

error <- tune.splsda.srbct$error.rate
ncomp <- tune.splsda.srbct$choice.ncomp$ncomp # optimal number of components based on t-tests on the error rate
ncomp

select.keepX <- tune.splsda.srbct$choice.keepX# optimal number of variables to select (e.g., number of metabolite features)
select.keepX

#plot(tune.splsda.srbct, col = color.jet(ncomp))
plot(tune.splsda.srbct)

```
Optimal number of components is 10, indicating that each lifestage adds information to the model.   

sPLS-DA from PLS-DA validation using desired number of components (groups) and optimized number of variables to "keep". The variables to keep are the number of metabolites that are used to inform the model with each component.      

```{r}
myResult.splsda.final_T <- splsda(X, Y, ncomp = ncomp, keepX=select.keepX) #use the number of components to keep based on optimization from above  

plotIndiv(myResult.splsda.final_T, ind.names = FALSE,
          ellipse = TRUE, legend=TRUE, title="sPLS-DA - Lifestage")

pdf("Mcap2020/Figures/Metabolomics/sPLSDA_Lifestage.pdf")
plotIndiv(myResult.splsda.final_T, ind.names = FALSE,
          ellipse = TRUE, legend=TRUE, title="sPLS-DA - Lifestage")
dev.off()
```

This sPLS-DA with selected ncomp and keepx shows teh same pattern of lifestage separation as our PLS-DA above.  

sPLS-DA model validation:    

```{r}
# Auroc plot of sPLS-DA
auc.splsda = auroc(myResult.splsda.final_T, roc.comp = 10)

## Performance validation of final spls-da
perf.splsda <- perf(myResult.splsda.final_T, validation = "Mfold", auc = TRUE) 

#Extracting Performance parameters
perf.splsda$auc
perf.splsda$error.rate
plot(perf.splsda) #Plotting Error rates

#Determining feature stability on each component 
dev.off()
par(mfrow=c(1,2))
plot(perf.splsda$features$stable[[1]], type = 'h', ylab = 'Stability', 
     xlab = 'Features', main = 'Comp 1', las =2)
plot(perf.splsda$features$stable[[2]], type = 'h', ylab = 'Stability', 
     xlab = 'Features', main = 'Comp 2', las =2)
#add more comps later on with more groups
dev.off()
```

Error rates decrease with addition of each component (lifestage).  

Select the stable features (metabolites) in each component (lifestage). These are the values with the highest value from the comp plots above.    
```{r}
# here we match the selected variables to the stable features
ind.match1 = match(selectVar(myResult.splsda.final_T, comp = 1)$name, 
                  names(perf.splsda$features$stable[[1]]))
ind.match2 = match(selectVar(myResult.splsda.final_T, comp = 2)$name, 
                  names(perf.splsda$features$stable[[2]]))
ind.match3 = match(selectVar(myResult.splsda.final_T, comp = 3)$name, 
                  names(perf.splsda$features$stable[[3]]))
ind.match4 = match(selectVar(myResult.splsda.final_T, comp = 4)$name, 
                  names(perf.splsda$features$stable[[4]]))
ind.match5 = match(selectVar(myResult.splsda.final_T, comp = 5)$name, 
                  names(perf.splsda$features$stable[[5]]))
ind.match6 = match(selectVar(myResult.splsda.final_T, comp = 6)$name, 
                  names(perf.splsda$features$stable[[6]]))
ind.match7 = match(selectVar(myResult.splsda.final_T, comp = 7)$name, 
                  names(perf.splsda$features$stable[[7]]))
ind.match8 = match(selectVar(myResult.splsda.final_T, comp = 8)$name, 
                  names(perf.splsda$features$stable[[8]]))
ind.match9 = match(selectVar(myResult.splsda.final_T, comp = 9)$name, 
                  names(perf.splsda$features$stable[[9]]))
ind.match10 = match(selectVar(myResult.splsda.final_T, comp = 10)$name, 
                  names(perf.splsda$features$stable[[10]]))


#extract the frequency of selection of those selected variables
Freq1 = as.numeric(perf.splsda$features$stable[[1]][ind.match1])
Freq2 = as.numeric(perf.splsda$features$stable[[2]][ind.match2])
Freq3 = as.numeric(perf.splsda$features$stable[[3]][ind.match3])
Freq4 = as.numeric(perf.splsda$features$stable[[4]][ind.match4])
Freq5 = as.numeric(perf.splsda$features$stable[[5]][ind.match5])
Freq6 = as.numeric(perf.splsda$features$stable[[6]][ind.match6])
Freq7 = as.numeric(perf.splsda$features$stable[[7]][ind.match7])
Freq8 = as.numeric(perf.splsda$features$stable[[8]][ind.match8])
Freq9 = as.numeric(perf.splsda$features$stable[[9]][ind.match9])
Freq10 = as.numeric(perf.splsda$features$stable[[10]][ind.match10])

#Extracting the selected metabolites for each component 
comp1.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 1)$value, Freq1)
comp2.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 2)$value, Freq2)
comp3.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 3)$value, Freq3)
comp4.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 4)$value, Freq4)
comp5.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 5)$value, Freq5)
comp6.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 6)$value, Freq6)
comp7.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 7)$value, Freq7)
comp8.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 8)$value, Freq8)
comp9.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 9)$value, Freq9)
comp10.select.metabolites <- data.frame(selectVar(myResult.splsda.final_T, comp = 10)$value, Freq10)

head(comp1.select.metabolites)
head(comp2.select.metabolites)
head(comp3.select.metabolites)
head(comp4.select.metabolites)
head(comp5.select.metabolites)
head(comp6.select.metabolites)
head(comp7.select.metabolites)
head(comp8.select.metabolites)
head(comp9.select.metabolites)
head(comp10.select.metabolites)

```

Analyses are continued in the WCNA approach to identify groups of metabolites correlated with each lifestage. 