---
title: Montipora capitata 2020 16S analysis
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE, results=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("janitor" %in% rownames(installed.packages()) == 'FALSE') install.packages('janitor') 
if ("gplots" %in% rownames(installed.packages()) == 'FALSE') install.packages('gplots') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("Heatplus" %in% rownames(installed.packages()) == 'FALSE') 

#load packages
library("ggplot2")
library('cowplot')
library("tidyverse")
library("janitor")
library("gplots")  # for heatmap.2
library("vegan")
library("RColorBrewer")
library("Heatplus")
```

# QIIME 2 Data  

## Load data  

Load data with abundance at level 5 taxonomy obtained from QIIME2 viewer of .qzv object.    
```{r}
abundance<-read.csv(file="Mcap2020/Output/16S/qiime/abundance_level5_data.csv")
```

Extract metadata for use later.  

```{r}
metadata<-abundance%>%
  select(index, tube.id, timepoint, lifestage, hpf, group)%>%
  rename(Sample=index)
```

## Filtering and relative abundance plots  

```{r}
#make sample names as row names 
abundance$code<-paste(abundance$lifestage, abundance$index)
row.names(abundance) <- abundance$code
abundance <- abundance[, -1]
abundance <- abundance[-c(305:310)] #remove metadata names so all values are numeric 
```

Turn data into relative abundance, rather than read counts.  

```{r}
abundance <- abundance/rowSums(abundance)
```

Plot relative abundance of unknown taxa (d__Bacteria.__.__.__.__).  

```{r}
abun_plot<-abundance%>%
  mutate(sample=rownames(.))%>%
  gather("Taxa", "RelativeAbundance", 1:304)%>%
  filter(Taxa=="d__Bacteria.__.__.__.__")


ggplot(abun_plot, aes(fill=Taxa, y=RelativeAbundance, x=sample)) + 
    geom_bar(stat="identity", show.legend=FALSE) +
    theme(axis.text.x=element_text(angle=90))

```

Remove unidentified bacteria for now.  

```{r}
abundance <- abundance%>%
  select(-c(d__Bacteria.__.__.__.__))
```

Remove taxa with abundance <0.001 (0.1% or less).  

```{r}
# determine the maximum relative abundance for each column
maxab <- apply(abundance, 2, max)
head(maxab)

# remove the genera with less than 0.1% as their maximum relative abundance
n1 <- names(which(maxab < 0.01))
abund.filter <- abundance[, -which(names(abundance) %in% n1)]

```

We now have 154 taxa to look at, rather than 304.  

Plot relative abundance of all known taxa after filtering (excluding d__Bacteria.__.__.__.__).  

```{r}
abun_plot_b<-abund.filter%>%
  mutate(sample=rownames(.))%>%
  gather("Taxa", "RelativeAbundance", 1:42)


plot2<-ggplot(abun_plot_b, aes(fill=Taxa, y=RelativeAbundance, x=sample)) + 
    geom_bar(position="fill", stat="identity") +
    theme(axis.text.x=element_text(angle=90))+
    theme(legend.position="bottom")+
    theme(legend.text=element_text(size=7))+
    theme(legend.key.size = unit(0.5, 'cm')) #change legend key size

ggsave("Mcap2020/Figures/16S/Rel_abund_filtered_qiime.pdf", plot2, width=26, height=6)



```

## Heatmaps  

Basic heatmap.  
```{r}
heatmap(as.matrix(abund.filter), Rowv = NA, Colv = NA, margins = c(10, 4))
```

Add dendrogram using the vegan package.  

```{r}
# calculate the Bray-Curtis dissimilarity matrix on the full dataset:
data.dist <- vegdist(abundance, method = "bray")

# Do average linkage hierarchical clustering. Other options are 'complete' or 'single'. You'll need to choose the one that best fits the needs of your situation and your data.
row.clus <- hclust(data.dist, "aver")

# make the heatmap with Rowv = as.dendrogram(row.clus)
heatmap(as.matrix(abund.filter), Rowv = as.dendrogram(row.clus), Colv = NA, margins = c(5, 6))

```

Make dendrogram in rows.  

```{r}
# you have to transpose the dataset to get the genera as rows
data.dist.g <- vegdist(t(abund.filter), method = "bray")
col.clus <- hclust(data.dist.g, "aver")

# make the heatmap with Rowv = as.dendrogram(row.clus)
heatmap(as.matrix(abund.filter), Rowv = as.dendrogram(row.clus), Colv = as.dendrogram(col.clus), margins = c(5, 6))

```

