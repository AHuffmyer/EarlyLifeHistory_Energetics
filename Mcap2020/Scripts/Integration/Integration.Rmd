---
title: "Integration"
author: "AS Huffmyer"
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Script to run co-occurrence network analyses between -omic datasets: metabolomics, bacterial communities, gene expression, and symbiont communities (ITS2).  

# **Setup**  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r setup, include = FALSE}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("corpcor")) install.packages("corpcor")
if (!require("janitor")) install.packages("janitor")

# load packages
library(tidyverse)
library(ggplot2)
library(corpcor)
library(janitor)

```

# **Load data** 

- Load data  
- Format to counts across columns and samples in rows  
- Associate metadata  

Load metadata that will help with standardizing life stage and group names.  
```{r}
metadata<-read.csv("Mcap2020/Data/lifestage_metadata.csv")
```

Load and format the metabolomics matrix.  

```{r}
metabolites<-read.csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")
metabolites<-metabolites%>%
  mutate(sample=paste(Lifestage, Rep))%>%
  select(Lifestage, compound, log_norm_counts, sample)%>%
  dplyr::rename(code=Lifestage)%>%
  spread(compound, log_norm_counts)

metabolites<-right_join(metadata, metabolites, by="code")

rownames(metabolites)<-metabolites$sample

metabolites<-metabolites%>%select(!sample)

dim(metabolites)
```

We have 47 samples with 186 metabolites.  

Now we have a count matrix for metabolites with the first 4 columns as metadata.  

Load and format gene count matrix and add in metadata.  

Subset for genes with total counts >100 to reduce the dataset.  
```{r}
genes<-read.csv("Mcap2020/Data/Integration/Mcapitata_gene_count_matrix.csv")
gene_names<-read.csv("Mcap2020/Data/TagSeq/Sample_Info.csv")

#check for any rows that have all zeros
genes[, 2:40] <- sapply(genes[, 2:40], as.numeric)
str(genes)

genes<-genes %>%
     mutate(Total = rowSums(.[, 2:40]))%>%
    filter(Total>5000)%>%
    select(!Total)

genes<-t(genes)

genes<-genes%>%
  janitor::row_to_names(row_number = 1)

dim(genes)

genes<-as.data.frame(genes)

genes<-tibble::rownames_to_column(genes, "sample_id")

gene_names<-gene_names%>%
  select(sample_id, code)

genes<-left_join(genes, gene_names, by="sample_id")

metadata_genes<-metadata%>%
  select(code, hpf, group, lifestage)

genes<-left_join(genes, metadata_genes, by="code")

rownames(genes)<-genes$sample_id

genes<-genes%>%
  select(!sample_id)

genes<-genes%>%
  relocate(code)%>%
  relocate(hpf)%>%
  relocate(lifestage)%>%
  relocate(group)
```

We have gene expression data for 39 samples with 39,598 genes with four metadata columns at the start of the matrix.  

# **Calculate means for each timepoint**  

Metabolites data set:  

Collapse matrices to get averages for each "code" (lifestage time point) so that the matrices can be correlated.
  
```{r}
metabolites_matrix<-metabolites%>%
  select(!group)%>%
  select(!hpf)%>%
  select(!lifestage)

metabolites_matrix$code<-as.factor(metabolites_matrix$code)

#Only keep lifestages that we have in common for each dataset 
timepoint_list<-levels(as.factor(genes$code))
timepoint_list<-as.factor(timepoint_list)
  
metabolites_matrix<-metabolites_matrix%>%  
  filter(code %in% timepoint_list)

metabolites_matrix<-metabolites_matrix%>%  
  group_by(code)%>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

metabolites_matrix<-as.matrix(metabolites_matrix)

rownames(metabolites_matrix)<-metabolites_matrix[,1]

metabolites_matrix<-metabolites_matrix[,-1]

metabolites_matrix[, 1:182] <- sapply(metabolites_matrix[, 1:182], as.numeric)
```

Genes data set:  

Collapse matrices to get averages for each "code" (lifestage time point) so that the matrices can be correlated.    
```{r}
gene_matrix<-genes%>%
  select(!group)%>%
  select(!hpf)%>%
  select(!lifestage)

gene_matrix[, 2:1250] <- sapply(gene_matrix[, 2:1250], as.numeric)

gene_matrix$code<-as.factor(gene_matrix$code)

gene_matrix<-gene_matrix%>%  
  group_by(code)%>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

gene_matrix<-as.matrix(gene_matrix)

rownames(gene_matrix)<-gene_matrix[,1]

gene_matrix<-gene_matrix[,-1]
```


We now have two matrices that have metabolite data and gene expression data for the same time points.  

# **Conduct corpcor shrinkage**  

Here we are using a smaller gene dataset (~9000 compared to the full 34000). To run this script on a larger dataset I think we would need to run this script on the cluster.  

Conduct shrinkage for each matrix.  
```{r}
gene_matrix_num <- matrix(as.numeric(gene_matrix),    # Convert to numeric matrix
                ncol = ncol(gene_matrix))
str(gene_matrix_num)

genes_shrink<-cov.shrink(gene_matrix_num) 
```

```{r}
rank.condition(genes_shrink) 
is.positive.definite(genes_shrink)  
solve(genes_shrink)

hist(genes_shrink)
```

Everything looks good for the metabolite dataset. We just need to figure out later on how to keep column and row names or match them back in after analysis.  

```{r}
metabolites_matrix_num <- matrix(as.numeric(metabolites_matrix),    # Convert to numeric matrix
                ncol = ncol(metabolites_matrix))
str(metabolites_matrix_num)

metab_shrink<-cov.shrink(metabolites_matrix_num) 
```

```{r}
rank.condition(metab_shrink) 
is.positive.definite(metab_shrink)  
solve(metab_shrink)

hist(metab_shrink)
```

Everything looks good for the metabolite dataset. We just need to figure out later on how to keep column and row names or match them back in after analysis.  


