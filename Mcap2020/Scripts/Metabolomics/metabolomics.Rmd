---
title: Montipora capitata 2020 metabolomics analysis
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")

```

## Generalized Work Flow

1. Data processing and exploration    
 - Import Data (positive peaks, negative peaks)  
 - Normalize to sample median   
 - Preliminary visualization of ion counts   
 - Selection of polarity and generation of final data frame ("selected_metabolites.csv")  
 - Check for polarity correlations  
 - Zero inflate values by 1000  
 - Log normalization of all ion counts of selected dataset  
 
2. Preliminary PCA and PERMANOVA statistics  
3. Preliminary PLS-DA  
4. Validation of preliminary PLS-DA  
5. sPLS-DA from PLS-DA validation  
6. sPLS-DA model validation   
7. Extraction of significant loadings  

# Data processing and exploration  
## Positive Polarity  
 
Load data  
```{r}
dataset1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

dataset2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Pos_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data<-full_join(dataset1, dataset2)

#rename columns to be useful
data<- data %>% 
  rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30, 
    Recruit3plug_rep2 = Recruit.3_Plug_33, 
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38
    )

``` 
  
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data<- data %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE), 
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),          
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),            
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE), 
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE)
         )
```


Mutate the data to be in long rather than wide format.  

```{r}
data <- data %>% 
  gather(Sample, IonCounts, 71:123)

data <- data[c(9, 71,72)]
```

Add lifestage column for categorizing  

```{r}
data<-data%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data$Lifestage<-as.factor(data$Lifestage)

data<-data%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))


#add development column with larger categories 
data<-data%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                               if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage == "Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                               if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Recruit", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Recruit", 
                                                                               if_else(Lifestage =="Recruit1plug", "Calcifying Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Calcifying Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Calcifying Recruit", "NA"))))))))))))))

data<-data%>%
  mutate(HPF = if_else(Lifestage == "Egg", "1", 
                               if_else(Lifestage =="Embryo", "5", 
                                       if_else(Lifestage == "Larvae1", "38", 
                                               if_else(Lifestage=="Larvae2", "65", 
                                               if_else(Lifestage=="Larvae3", "93", 
                                                       if_else(Lifestage == "Larvae4", "163",
                                                       if_else(Lifestage == "Larvae5", "183 larvae", 
                                                               if_else(Lifestage == "Larvae6", "231 larvae",
                                                               if_else(Lifestage == "Recruit1", "183 recruit", 
                                                                       if_else(Lifestage == "Recruit2", "231 recruit", 
                                                                               if_else(Lifestage =="Recruit1plug", "183 recruit plug", 
                                                                                       if_else(Lifestage == "Recruit2plug", "231 recruit plug", 
                                                                                               if_else(Lifestage == "Recruit3plug", "255 recruit plug", "NA"))))))))))))))

data$HPF<-fct_relevel(data$HPF, "1", "5", "38", "65", "93", "163", "183 larvae", "183 recruit", "183 recruit plug", "231 larvae", "231 recruit", "231 recruit plug", "255 recruit plug")
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting<-plyr::ddply(data, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)
#write summary file
data_summary<-data_plotting[c(1,2,4)]

#data_summary%>%
  #spread(Lifestage, mean) %>%
  #write_csv("Mcap2020/Output/Metabolomics/mean_norm_counts_lifestage_pos.csv")

metab_compounds<-ggplot(data_summary, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds

#ggsave("Mcap2020/Figures/Metabolomics/compounds_fullscale_pos.pdf", plot=metab_compounds, dpi=300, width=25, height=8, units="in")

#metabl_short<-metab_compounds + ylim(0,100)

#ggsave("Mcap2020/Figures/Metabolomics/compounds_shortscale_pos.pdf", plot=metabl_short, dpi=300, width=25, height=8, units="in")

#metabl_shortest<-metab_compounds + ylim(0,20)

#ggsave("Mcap2020/Figures/Metabolomics/compounds_shortestscale_pos.pdf", plot=metabl_shortest, dpi=300, width=25, height=8, units="in")

```

Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca<-data%>%
  spread(compound, IonCounts)

#manualluy remove samples that were run in different runs as the metabolite profiles are different and result in a large number of NA's

#remove columns with na's 
data_pca<-data_pca%>%
    select_if(~ !any(is.na(.)))

```

Plot PCA with lifestage in colors.  

```{r}
scaled.pca<-prcomp(data_pca[c(6:133)],scale=TRUE, center=TRUE) 

pcaPlot1<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

pcaPlot1b<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1b

pcaPlot1a<-ggplot2::autoplot(scaled.pca, data=data_pca, frame.colour="Development", loadings=FALSE,  colour="Development", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1a

#pcaPlot1$layers[[2]]$aes_params$size <- 1

ggsave("Mcap2020/Figures/Metabolomics/PCA_pos.pdf", plot=pcaPlot1, height=8, width=10, units = c("in"), dpi=300) #output figure
```

Read in .csv of normalized counts with trend assigned.  

Plot compounds grouping by increasing over ontogeny, decreasing, or no apparent trend. - No longer using this approach with high number of samples, but leaving in script for reference.  

Add a column to distinguish increasing, decreasing, or variable trends.  

```{r}
#assign trends 
#trends<-data_summary%>%
  #spread(Lifestage, mean)%>%
  #mutate(Trend=ifelse(Larvae2>Larvae4 & Larvae4>Larvae6, "Decreasing", 
                      #ifelse(Larvae2<Larvae4 & Larvae4<Larvae6, "Increasing", "Variable")))
```


```{r}
#trends<-trends%>%
  #gather(Lifestage, IonCounts, 2:4)
  
#metab_trends<-ggplot(trends, aes(y=IonCounts, x=compound, fill=Lifestage, group=Lifestage)) + 
  #facet_wrap(~Trend, scales = "free")+
  #geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  #theme_classic()+
  #xlab("Metabolites")+
  #ylab("Normalized Ion Count")+
  #theme(
   # legend.position="right", 
    #panel.border=element_rect(colour="black", fill=NA, size=1),
    #strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    #text = element_text(size = 16, color="black"), 
    #axis.text.y = element_text(size=14, color="black"), 
    #axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    #axis.title = element_text(face="bold"));metab_trends

#ggsave("Mcap2020/Figures/Metabolomics/trends_fullscale.pdf", plot=metab_trends, dpi=300, width=35, height=8, units="in")

#trend_short<-metab_trends + ylim(0,100)

#ggsave("Mcap2020/Figures/Metabolomics/trends_shortscale.pdf", plot=trend_short, dpi=300, width=35, height=8, units="in")

#trend_shortest<-metab_trends + ylim(0,20)

#ggsave("Mcap2020/Figures/Metabolomics/trends_shortestscale.pdf", plot=trend_shortest, dpi=300, width=35, height=8, units="in")
```



## Negative Polarity  

Load data
```{r}
data_neg1<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_11292020_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

data_neg2<-read.csv("Mcap2020/Data/Metabolomics/Peaks_Neg_Normalized_20210524_Rutgers.csv", sep=",", na.strings=NA, header=TRUE)

#join together by compound
data_neg<-full_join(data_neg1, data_neg2)

#rename columns to be useful
data_neg<- data_neg %>% 
  rename(
    Larvae2_rep1 = Larvae.2_50uL_1,
    Larvae2_rep2 = Larvae.2_50uL_2,
    Larvae4_rep1 = Larvae.4_50uL_1,
    Larvae4_rep2 =  Larvae.4_50uL_2,
    Larvae6_rep1 = Larvae.6_15.20.Individuals_1,
    Larvae6_rep2 = Larvae.6_15.20.Individuals_2, 
    Egg_rep1 = Egg.Fertilized_F1_8, 
    Egg_rep2 = Egg.Fertilized_F2_4, 
    Egg_rep3 = Egg.Fertilized_F3_18, 
    Egg_rep4 = Egg.Fertilized_F4_12, 
    Embryo_rep1 = Embryo.1_F5_39, 
    Embryo_rep2 = Embryo.1_F6_7, 
    Embryo_rep3 = Embryo.1_F7_23, 
    Embryo_rep4 = Embryo.1_F8_29, 
    Larvae1_rep1 = Larvae.1_F9_6, 
    Larvae1_rep2 = Larvae.1_F10_19, 
    Larvae1_rep3 = Larvae.1_F11_44, 
    Larvae1_rep4 = Larvae.1_F12_5, 
    Larvae2_rep3 = Larvae.2_F15_46, 
    Larvae2_rep4 = Larvae.2_F16_11, 
    Larvae3_rep1 = Larvae.3_F17_43, 
    Larvae3_rep2 = Larvae.3_F18_26, 
    Larvae3_rep3 = Larvae.3_F19_17, 
    Larvae3_rep4 = Larvae.3_F20_9, 
    Larvae4_rep3 = Larvae.4_F23_1, 
    Larvae4_rep4 = Larvae.4_F24_24, 
    Larvae5_rep1 = Larvae.5_F25_2, 
    Larvae5_rep2 = Larvae.5_F26_22, 
    Larvae5_rep3 = Larvae.5_F27_15, 
    Larvae5_rep4 = Larvae.5_F28_13, 
    Larvae6_rep3 = Larvae.6_F31_16, 
    Larvae6_rep4 = Larvae.6_F32_14, 
    Recruit1_rep1 = Recruit.1_F33_3, 
    Recruit1_rep2 = Recruit.1_F34_47, 
    Recruit1_rep3 = Recruit.1_F35_10, 
    Recruit1_rep4 = Recruit.1_F36_28, 
    Recruit1plug_rep1 = Recruit.1_Plug_20, 
    Recruit1plug_rep2 = Recruit.1_Plug_32,
    Recruit1plug_rep3 = Recruit.1_Plug_35,
    Recruit1plug_rep4 = Recruit.1_Plug_37,
    Recruit2_rep1 = Recruit.2_F37_45, 
    Recruit2_rep2 = Recruit.2_F38_27, 
    Recruit2_rep3 = Recruit.2_F39_21, 
    Recruit2_rep4 = Recruit.2_F40_25, 
    Recruit2plug_rep1 = Recruit.2_Plug_31, 
    Recruit2plug_rep2 = Recruit.2_Plug_34, 
    Recruit2plug_rep3 = Recruit.2_Plug_40,
    Recruit2plug_rep4 = Recruit.2_Plug_41,
    Recruit2plug_rep5 = Recruit.2_Plug_42,
    Recruit3plug_rep1 = Recruit.3_Plug_30,
    Recruit3plug_rep2 = Recruit.3_Plug_33,
    Recruit3plug_rep3 = Recruit.3_Plug_36,
    Recruit3plug_rep4 = Recruit.3_Plug_38)

```
 

Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
data_neg<- data_neg %>%
  mutate(Egg_rep1_norm = Egg_rep1 / median(Egg_rep1, na.rm=TRUE), 
         Egg_rep2_norm = Egg_rep2 / median(Egg_rep2, na.rm=TRUE), 
         Egg_rep3_norm = Egg_rep3 / median(Egg_rep3, na.rm=TRUE),
         Egg_rep4_norm = Egg_rep4 / median(Egg_rep4, na.rm=TRUE),
         Embryo_rep1_norm = Embryo_rep1 / median(Embryo_rep1, na.rm=TRUE), 
         Embryo_rep2_norm = Embryo_rep2 / median(Embryo_rep2, na.rm=TRUE), 
         Embryo_rep3_norm = Embryo_rep3 / median(Embryo_rep3, na.rm=TRUE),
         Embryo_rep4_norm = Embryo_rep4 / median(Embryo_rep4, na.rm=TRUE),
         Larvae1_rep1_norm = Larvae1_rep1 / median(Larvae1_rep1, na.rm=TRUE), 
         Larvae1_rep2_norm = Larvae1_rep2 / median(Larvae1_rep2, na.rm=TRUE), 
         Larvae1_rep3_norm = Larvae1_rep3 / median(Larvae1_rep3, na.rm=TRUE),
         Larvae1_rep4_norm = Larvae1_rep4 / median(Larvae1_rep4, na.rm=TRUE),
         Larvae2_rep1_norm = Larvae2_rep1 / median(Larvae2_rep1, na.rm=TRUE), 
         Larvae2_rep2_norm = Larvae2_rep2 / median(Larvae2_rep2, na.rm=TRUE), 
         Larvae2_rep3_norm = Larvae2_rep3 / median(Larvae2_rep3, na.rm=TRUE),
         Larvae2_rep4_norm = Larvae2_rep4 / median(Larvae2_rep4, na.rm=TRUE),
         Larvae3_rep1_norm = Larvae3_rep1 / median(Larvae3_rep1, na.rm=TRUE), 
         Larvae3_rep2_norm = Larvae3_rep2 / median(Larvae3_rep2, na.rm=TRUE), 
         Larvae3_rep3_norm = Larvae3_rep3 / median(Larvae3_rep3, na.rm=TRUE),
         Larvae3_rep4_norm = Larvae3_rep4 / median(Larvae3_rep4, na.rm=TRUE),
         Larvae4_rep1_norm = Larvae4_rep1 / median(Larvae4_rep1, na.rm=TRUE), 
         Larvae4_rep2_norm = Larvae4_rep2 / median(Larvae4_rep2, na.rm=TRUE),
         Larvae4_rep3_norm = Larvae4_rep3 / median(Larvae4_rep3, na.rm=TRUE), 
         Larvae4_rep4_norm = Larvae4_rep4 / median(Larvae4_rep4, na.rm=TRUE),
         Larvae5_rep1_norm = Larvae5_rep1 / median(Larvae5_rep1, na.rm=TRUE), 
         Larvae5_rep2_norm = Larvae5_rep2 / median(Larvae5_rep2, na.rm=TRUE),
         Larvae5_rep3_norm = Larvae5_rep3 / median(Larvae5_rep3, na.rm=TRUE), 
         Larvae5_rep4_norm = Larvae5_rep4 / median(Larvae5_rep4, na.rm=TRUE),
         Larvae6_rep1_norm = Larvae6_rep1 / median(Larvae6_rep1, na.rm=TRUE),
         Larvae6_rep2_norm = Larvae6_rep2 / median(Larvae6_rep2, na.rm=TRUE),
         Larvae6_rep3_norm = Larvae6_rep3 / median(Larvae6_rep3, na.rm=TRUE),
         Larvae6_rep4_norm = Larvae6_rep4 / median(Larvae6_rep4, na.rm=TRUE), 
         Recruit1_rep1_norm = Recruit1_rep1 / median(Recruit1_rep1, na.rm=TRUE),
         Recruit1_rep2_norm = Recruit1_rep2 / median(Recruit1_rep2, na.rm=TRUE),
         Recruit1_rep3_norm = Recruit1_rep3 / median(Recruit1_rep3, na.rm=TRUE),
         Recruit1_rep4_norm = Recruit1_rep4 / median(Recruit1_rep4, na.rm=TRUE), 
         Recruit2_rep1_norm = Recruit2_rep1 / median(Recruit2_rep1, na.rm=TRUE),
         Recruit2_rep2_norm = Recruit2_rep2 / median(Recruit2_rep2, na.rm=TRUE),
         Recruit2_rep3_norm = Recruit2_rep3 / median(Recruit2_rep3, na.rm=TRUE),
         Recruit2_rep4_norm = Recruit2_rep4 / median(Recruit2_rep4, na.rm=TRUE),
         Recruit1plug_rep1_norm = Recruit1plug_rep1 / median(Recruit1plug_rep1, na.rm=TRUE),
         Recruit1plug_rep2_norm = Recruit1plug_rep2 / median(Recruit1plug_rep2, na.rm=TRUE),
         Recruit1plug_rep3_norm = Recruit1plug_rep3 / median(Recruit1plug_rep3, na.rm=TRUE),
         Recruit1plug_rep4_norm = Recruit1plug_rep4 / median(Recruit1plug_rep4, na.rm=TRUE),
         Recruit2plug_rep1_norm = Recruit2plug_rep1 / median(Recruit2plug_rep1, na.rm=TRUE),
         Recruit2plug_rep2_norm = Recruit2plug_rep2 / median(Recruit2plug_rep2, na.rm=TRUE),
         Recruit2plug_rep3_norm = Recruit2plug_rep3 / median(Recruit2plug_rep3, na.rm=TRUE),
         Recruit2plug_rep4_norm = Recruit2plug_rep4 / median(Recruit2plug_rep4, na.rm=TRUE),
         Recruit2plug_rep5_norm = Recruit2plug_rep5 / median(Recruit2plug_rep5, na.rm=TRUE),
         Recruit3plug_rep1_norm = Recruit3plug_rep1 / median(Recruit3plug_rep1, na.rm=TRUE),
         Recruit3plug_rep2_norm = Recruit3plug_rep2 / median(Recruit3plug_rep2, na.rm=TRUE),
         Recruit3plug_rep3_norm = Recruit3plug_rep3 / median(Recruit3plug_rep3, na.rm=TRUE),
         Recruit3plug_rep4_norm = Recruit3plug_rep4 / median(Recruit3plug_rep4, na.rm=TRUE))
```


Mutate the data to be in long rather than wide format.  

```{r}
data_neg <- data_neg %>% 
  gather(Sample, IonCounts, 71:123)

data_neg <- data_neg[c(9, 71, 72)]
```

Add lifestage column for categorizing  

```{r}
data_neg<-data_neg%>%
  separate(Sample, sep="_", c("Lifestage", "Rep"), remove=FALSE)

data_neg$Lifestage<-as.factor(data_neg$Lifestage)

data_neg<-data_neg%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae2" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae4" & Rep=="rep2"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep1"))%>%
  filter(!(Lifestage=="Larvae6" & Rep=="rep2"))

data_neg<-data_neg%>%
  mutate(Development = if_else(Lifestage == "Egg", "Egg", 
                               if_else(Lifestage =="Embryo", "Embryo", 
                                       if_else(Lifestage == "Larvae1", "Embryo", 
                                                if_else(Lifestage == "Larvae2", "Embryo",
                                               if_else(Lifestage=="Larvae3", "Larvae", 
                                                       if_else(Lifestage=="Larvae4", "Larvae", 
                                                       if_else(Lifestage == "Larvae5", "Larvae", 
                                                                if_else(Lifestage == "Larvae6", "Larvae",
                                                               if_else(Lifestage == "Recruit1", "Metamorphosed Recruit", 
                                                                       if_else(Lifestage == "Recruit2", "Metamorphosed Recruit", 
                                                                               if_else(Lifestage =="Recruit1plug", "Calcifying Recruit", 
                                                                                       if_else(Lifestage == "Recruit2plug", "Calcifying Recruit", 
                                                                                               if_else(Lifestage == "Recruit3plug", "Calcifying Recruit", "NA"))))))))))))))

data_neg<-data_neg%>%
  mutate(HPF = if_else(Lifestage == "Egg", "1", 
                               if_else(Lifestage =="Embryo", "5", 
                                       if_else(Lifestage == "Larvae1", "38", 
                                                if_else(Lifestage=="Larvae2", "65", 
                                               if_else(Lifestage=="Larvae3", "93", 
                                                        if_else(Lifestage == "Larvae4", "163",
                                                       if_else(Lifestage == "Larvae5", "183 larvae", 
                                                                if_else(Lifestage == "Larvae6", "231 larvae",
                                                               if_else(Lifestage == "Recruit1", "183 recruit", 
                                                                       if_else(Lifestage == "Recruit2", "231 recruit", 
                                                                               if_else(Lifestage =="Recruit1plug", "183 recruit plug", 
                                                                                       if_else(Lifestage == "Recruit2plug", "231 recruit plug", 
                                                                                               if_else(Lifestage == "Recruit3plug", "255 recruit plug", "NA"))))))))))))))

data_neg$HPF<-fct_relevel(data_neg$HPF, "1", "5", "38", "65", "93", "163", "183 larvae", "183 recruit", "183 recruit plug", "231 larvae", "231 recruit", "231 recruit plug", "255 recruit plug")

data_neg$Development<-as.factor(data_neg$Development)
```

Create plot showing normalized ion counts (count / sample median) for each lifestage.  

```{r}
#make summary table
data_plotting_neg<-plyr::ddply(data_neg, c("Lifestage", "compound"), summarise,
                N    = length(IonCounts[!is.na(IonCounts)]),
                mean = mean(IonCounts, na.rm=TRUE),
                sd   = sd(IonCounts, na.rm=TRUE),
                se   = sd / sqrt(N)
)
#write summary file
data_summary_neg<-data_plotting_neg[c(1,2,4)]

#data_summary_neg%>%
  #spread(Lifestage, mean) %>%
  #write_csv("Mcap2020/Output/Metabolomics/mean_norm_counts_lifestage_neg.csv")

metab_compounds_neg<-ggplot(data_summary_neg, aes(y=mean, x=compound, fill=Lifestage, group=Lifestage)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
 # ylim(-1,100)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_neg

#ggsave("Mcap2020/Figures/Metabolomics/compounds_fullscale_neg.pdf", plot=metab_compounds_neg, dpi=300, width=25, height=8, units="in")

#metabl_short_neg<-metab_compounds_neg + ylim(0,100)

#ggsave("Mcap2020/Figures/Metabolomics/compounds_shortscale_neg.pdf", plot=metabl_short_neg, dpi=300, width=25, height=8, units="in")

#metabl_shortest_neg<-metab_compounds_neg + ylim(0,20)

#ggsave("Mcap2020/Figures/Metabolomics/compounds_shortestscale_neg.pdf", plot=metabl_shortest_neg, dpi=300, width=25, height=8, units="in")

```


Run PCA to view differences in life stages.  

Convert data to wide format.

```{r}
data_pca_neg<-data_neg%>%
  spread(compound, IonCounts)

#manualluy remove samples that were run in different runs as the metabolite profiles are different and result in a large number of NA's

#remove columns with na's 
data_pca_neg<-data_pca_neg%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA with lifestage in colors.  

```{r}
scaled.pca.neg<-prcomp(data_pca_neg[c(6:141)],scale=TRUE, center=TRUE) 

pcaPlot1_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1_neg

pcaPlot1b_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1b_neg

pcaPlot1a_neg<-ggplot2::autoplot(scaled.pca.neg, data=data_pca_neg, frame.colour="Development", loadings=FALSE,  colour="Development", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  #scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1a_neg

#pcaPlot1$layers[[2]]$aes_params$size <- 1

ggsave("Mcap2020/Figures/Metabolomics/PCA_neg.pdf", plot=pcaPlot1_neg, height=8, width=10, units = c("in"), dpi=300) #output figure
```

Read in .csv of normalized counts with trend assigned.  

Plot compounds grouping by increasing over ontogeny, decreasing, or no apparent trend.  

Add a column to distinguish increasing, decreasing, or variable trends.  
```{r}
#assign trends to neg dataset
#trends_neg<-data_summary_neg%>%
  #spread(Lifestage, mean)%>%
  #mutate(Trend=ifelse(Larvae2>Larvae4 & Larvae4>Larvae6, "Decreasing", 
    #                  ifelse(Larvae2<Larvae4 & Larvae4<Larvae6, "Increasing", "Variable")))
```

```{r}
#trends_neg<-trends_neg%>%
 # gather(Lifestage, IonCounts, 2:4)
  
#metab_trends_neg<-ggplot(trends_neg, aes(y=IonCounts, x=compound, fill=Lifestage, group=Lifestage)) + 
#  facet_wrap(~Trend, scales = "free")+
 # geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  #theme_classic()+
#  xlab("Metabolites")+
 # ylab("Normalized Ion Count")+
  #theme(
   # legend.position="right", 
  #  panel.border=element_rect(colour="black", fill=NA, size=1),
   # strip.text.x = element_text(size = 12, color = "black", face = "bold"),
  #  text = element_text(size = 16, color="black"), 
   # axis.text.y = element_text(size=14, color="black"), 
  #  axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
   # axis.title = element_text(face="bold"));metab_trends_neg

#ggsave("Mcap2020/Figures/Metabolomics/trends_fullscale_neg.pdf", plot=metab_trends_neg, dpi=300, width=35, height=8, units="in")

#trend_short_neg<-metab_trends_neg + ylim(0,100)

#ggsave("Mcap2020/Figures/Metabolomics/trends_shortscale_neg.pdf", plot=trend_short_neg, dpi=300, width=35, height=8, units="in")

#trend_shortest_neg<-metab_trends_neg + ylim(0,20)

#ggsave("Mcap2020/Figures/Metabolomics/trends_shortestscale_neg.pdf", plot=trend_shortest_neg, dpi=300, width=35, height=8, units="in")
```

Generate a dataframe with normalized counts for positive and negative polarity datasets.  

```{r}
#merge two datasets such that mean in negative = "negative", and mean from positive = "positive". If not present, NA. 
data_summary_neg<-data_summary_neg%>%
    rename(Negative = mean)

data_summary<-data_summary%>%
    rename(Positive = mean)

#view normalized negative dataset
head(data_summary_neg)

head(data_summary)

#join datasets together
normalized_counts_pos_neg<-full_join(data_summary, data_summary_neg)

write_csv(normalized_counts_pos_neg, file="Mcap2020/Output/Metabolomics/normalized_counts_pos_neg.csv")
```

# Selecting metabolite polarity and generating final dataframe   

Use metabolite selection file to select polarity by averaging peaks across life stages for pos and neg peaks and choosing the strongest peaks.
 
```{r}
#data is positive and data_neg are negative dataframes  
data<-data%>%
  mutate(Polarity="Positive")

data_neg<-data_neg%>%
  mutate(Polarity="Negative")

data_full<-full_join(data, data_neg) #combine full positive and negative datasets

data_full<-data_full%>%
  spread(Polarity, IonCounts)
```

Check for correlations between metabolites that have both positive and negative representation. We would expect that metabolites with higher ion counts will show higher counts across polarities.  

```{r}
correlation<-data_full

#only use complete observations
correlation<-correlation[complete.cases(correlation), ]
```

Display correlations for the metabolites with shared representation.  

```{r}
corrplots<-ggplot(data=correlation, aes(x=log(1+Positive), y=log(1+Negative)))+
  geom_point()+
  facet_wrap(~compound, scales="free")+
  geom_smooth(method='lm', color='red')+
  theme_classic()+
  theme(text=element_text(size=14, face="bold"));corrplots

ggsave("Mcap2020/Figures/Metabolomics/Correlation_plot.pdf", corrplots, width=20, height=16)
```

Relationship between positive and negative polarities are generally positive. Some of the relationships are more strong for certain metabolites and more variable for others.  

```{r}
#summarize across life stages and reps
polarity<-data_full%>%
  gather("Polarity", "IonCounts", 7:8)%>%
  group_by(Polarity, compound)%>%
  summarise(mean=mean(IonCounts, na.rm=TRUE))%>% #summarize across samples (lifestages)
  arrange(compound)%>% #list by compound
  replace_na(list(mean=0)) #replace NA with 0 to allow us to calculate higher values between polarities 

#add column of selected polarity based on stronger signal average
polarity<-polarity%>%
  spread(Polarity, mean)%>%
  mutate(Selection = ifelse(Negative > Positive, "Negative",
                     ifelse(Positive > Negative, "Positive", NA)))
  
```

Use the selected polarity key to select data for analysis.    

```{r}
#match selection column back onto original dataframe 
data_full$Selection<-polarity$Selection[match(data_full$compound, polarity$compound)] 

#pull out pos data
pos_peaks<-data_full%>%
  filter(Selection=="Positive")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Positive, Selection)%>%
  rename(value=Positive)
  
#pull out neg data
neg_peaks<-data_full%>%
  filter(Selection=="Negative")%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, Negative, Selection)%>%
  rename(value=Negative)

#rbind them together to generate a dataframe of positive and negative selected compounds
peaks_selected<-rbind(pos_peaks, neg_peaks)

peaks_selected<-peaks_selected %>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value) 
```

Add 1 to all values to account for 0 values and log transform.  
```{r}
hist(peaks_selected$value)

peaks_selected$log_norm_counts<-log10(1+peaks_selected$value)
hist(log(peaks_selected$log_norm_counts))
```

Output file to .csv.   

```{r}
peaks_selected%>%
  rename(norm_counts=value)%>%
  write_csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")
```

# Preliminary PCA of combined polarities  

Run PCA to view differences in life stages.   

Convert data to wide format. 

```{r}
data_pca_full<-peaks_selected%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, value)%>%
  spread(compound, value)


#remove columns with na's
data_pca_full<-data_pca_full%>%
    select_if(~ !any(is.na(.)))
```
 
Plot PCA and view scree plot with lifestage in colors.   

```{r}
scaled.pca<-prcomp(data_pca_full[c(5:203)],scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)

pcaPlot_full<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="HPF", loadings=FALSE,  colour="HPF", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, ,loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) +
  #scale_fill_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         #legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full

pcaPlot_full3<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="Lifestage", loadings=FALSE,  colour="Lifestage", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, ,loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) +
  #scale_fill_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         #legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full3

pcaPlot_full2<-ggplot2::autoplot(scaled.pca, data=data_pca_full, frame.colour="Development", loadings=FALSE,  colour="Development", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, ,loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  #scale_colour_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) +
  #scale_fill_manual(values=c("#80CDC1", "#80CDC1", "#80CDC1")) + 
  theme_classic()+
  #xlim(-0.75,0.75)+
  #ylim(-0.75, 0.75)+
   theme(legend.text = element_text(size=18), 
         #legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_full2

ggsave("Mcap2020/Figures/Metabolomics/PCA_full.pdf", plot=pcaPlot_full, height=8, width=10, units = c("in"), dpi=300) #output figure
```

Show a panel of PCA by positive, negative, and combined datasets.   
```{r}
pca_pos<-pcaPlot1+theme(legend.position="none")
pca_neg<-pcaPlot1_neg+theme(legend.position="none")

pcaplots<-plot_grid(pca_pos, pca_neg, pcaPlot_full, labels = c("Positive", "Negative", "Combined"), ncol=3, nrow=1, rel_widths = c(0.8, 0.8, 1), label_size = 20, label_x = 0.1);pcaplots

ggsave(filename="Mcap2020/Figures/Metabolomics/All_PCAs.pdf", plot=pcaplots, dpi=300, width=20, height=5, units="in")
```  



# Preliminary PLS-DA 

Load data if starting from this point.   

```{r}
metabolites <- read.csv("Mcap2020/Output/Metabolomics/selected_metabolites.csv")

metabolites<-metabolites%>%
  drop_na() #remove samples with na's
  
```

log_norm_count indicates normalized ion counts that are log transformed for analysis.   

Scripts from K Wong for preliminary PLS-DA.  

Generate PLS-DA.  
```{r, results=FALSE}
#https://mixomicsteam.github.io/Bookdown/plsda.html

#assigning datasets 
X <- metabolites%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$HPF) #select treatment names
Y

X<-X[5:201] #pull only data columns

dim(X) ## display number of samples and metabolite features


# PLSDA without variable selection
MyResult.plsda <- plsda(X,Y) # 1 Run the method
plotIndiv(MyResult.plsda)    # 2 Plot the samples
plotVar(MyResult.plsda, cutoff = 0.7)    

pdf("Mcap2020/Figures/Metabolomics/PLSDA_Lifestage.pdf", width=7, height=7)
plotIndiv(MyResult.plsda, ind.names = FALSE, legend=TRUE,ellipse = TRUE, title="PLS-DA, HPF")
dev.off() 

plotIndiv(MyResult.plsda, ind.names = FALSE, legend=TRUE,ellipse = TRUE, title="PLS-DA, HPF")
#plotVar(MyResult.plsda)
#plotLoadings(MyResult.plsda)
#plotArrow(MyResult.plsda)
#auroc(MyResult.plsda)

pdf("Mcap2020/Figures/Metabolomics/CIM_Timepoint.pdf", width=15, height=7)
cim(MyResult.plsda, mapping="Y", row.names = metabolites$HPF, xlab = "Metabolites", ylab="Hours Post Fertilization", margins=c(10,7), row.cex=0.5)
dev.off()
```

Extract top 50 metabolite loadings contributing to components. 
```{r, message=FALSE}
MyResult.plsda_timepoint <- plsda(X,Y, ncomp=9) #number of components is classes-1
#selectVar(MyResult.plsda2, comp=1)$value

```

Plot by developmental stage.  
```{r}
#assigning datasets 
X <- metabolites%>%
  dplyr::select(Lifestage, Rep, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names
Y

X<-X[5:201] #pull only data columns

dim(X) ## display number of samples and metabolite features

MyResult.plsda.D <- plsda(X,Y) # 1 Run the method
plotIndiv(MyResult.plsda.D)    # 2 Plot the samples
plotVar(MyResult.plsda.D, cutoff = 0.7)    

pdf("Mcap2020/Figures/Metabolomics/PLSDA_Development.pdf", width=7, height=7)
plotIndiv(MyResult.plsda.D, ind.names = FALSE, legend=TRUE,ellipse = TRUE, title="PLS-DA, Development")
dev.off() 

plotIndiv(MyResult.plsda.D, ind.names = FALSE, legend=TRUE,ellipse = TRUE, title="PLS-DA, Development")
#plotVar(MyResult.plsda.D)
#plotLoadings(MyResult.plsda.D)
#plotArrow(MyResult.plsda.D)
#auroc(MyResult.plsda.D)


pdf("Mcap2020/Figures/Metabolomics/CIM_Development.pdf", width=15, height=7)
cim(MyResult.plsda.D, row.names = metabolites$Development, mapping="Y", xlab = "Metabolites", ylab="Developmental Group", margins=c(10,10), row.cex=0.5, col.cex=0.5)
dev.off()
```

Extract top 50 metabolite loadings contributing to components. 
```{r, message=FALSE}
MyResult.plsda_develop <- plsda(X,Y, ncomp=4) #number of components is classes-1 
#selectVar(MyResult.plsda2, comp=1)$value
```

# Extract VIP scores from PLS-DA's   

Extractions from groups as a whole - will do stage specific extractions later for comparisons.  

Time points: 

```{r}
#extract
Timepoint_VIP <- PLSDA.VIP(MyResult.plsda_timepoint)
Timepoint_VIP_DF <- as.data.frame(Timepoint_VIP[["tab"]])
Timepoint_VIP_DF

# Converting row names to column
Timepoint_VIP_table <- rownames_to_column(Timepoint_VIP_DF, var = "Metabolite")

#filter for VIP > 1
Timepoint_VIP_1 <- Timepoint_VIP_table %>% 
  filter(VIP >= 1)

#plot
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Timepoint Groupings") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("Mcap2020/Figures/Metabolomics/Timepoint_VIP.pdf", width=6, height=11)
Timepoint_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Timepoint Groupings") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

Developmental groups: 

```{r}
#extract
Develop_VIP <- PLSDA.VIP(MyResult.plsda_develop)
Develop_VIP_DF <- as.data.frame(Develop_VIP[["tab"]])
Develop_VIP_DF

# Converting row names to column
Develop_VIP_table <- rownames_to_column(Develop_VIP_DF, var = "Metabolite")

#filter for VIP > 1
Develop_VIP_1 <- Develop_VIP_table %>% 
  filter(VIP >= 1)

#plot
Develop_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Developmental Groupings") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/Development_VIP.pdf", , width=6, height=11)
Develop_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Developmental Groupings") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```

Generate VIPs for developmental group comparisons 

1. Eggs vs embryos  

```{r}

#assigning datasets 
X <- metabolites%>%
  filter(Development==c("Egg","Embryo"))%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:203] #pull only data columns

MyResult.plsda_EvE <- plsda(X,Y, ncomp=4)

#extract
EvE_VIP <- PLSDA.VIP(MyResult.plsda_EvE)
EvE_VIP_DF <- as.data.frame(EvE_VIP[["tab"]])

# Converting row names to column
EvE_VIP_table <- rownames_to_column(EvE_VIP_DF, var = "Metabolite")

#filter for VIP > 1
EvE_VIP_1 <- EvE_VIP_table %>% 
  filter(VIP >= 1)

#plot
EvE_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Eggs vs Embryos") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/EggsEmbryo_VIP.pdf", width=6, height=11)
EvE_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Eggs vs Embryos") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```


2. Embryos vs larvae  

```{r}

#assigning datasets 
X <- metabolites%>%
  filter(Development==c("Egg","Larvae"))%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:203] #pull only data columns

MyResult.plsda_EvL <- plsda(X,Y, ncomp=4)

#extract
EvL_VIP <- PLSDA.VIP(MyResult.plsda_EvL)
EvL_VIP_DF <- as.data.frame(EvL_VIP[["tab"]])

# Converting row names to column
EvL_VIP_table <- rownames_to_column(EvL_VIP_DF, var = "Metabolite")

#filter for VIP > 1
EvL_VIP_1 <- EvL_VIP_table %>% 
  filter(VIP >= 1)

#plot
EvL_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Embryos vs Larvae") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/EmbryoLarvae_VIP.pdf", width=6, height=11)
EvL_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Embryos vs Larvae") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```

3. Larvae vs metamorphosed recruits  

```{r}

#assigning datasets 
X <- metabolites%>%
  filter(Development==c("Larvae","Metamorphosed Recruit"))%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:203] #pull only data columns

MyResult.plsda_LvM <- plsda(X,Y, ncomp=4)

#extract
LvM_VIP <- PLSDA.VIP(MyResult.plsda_LvM)
LvM_VIP_DF <- as.data.frame(LvM_VIP[["tab"]])

# Converting row names to column
LvM_VIP_table <- rownames_to_column(LvM_VIP_DF, var = "Metabolite")

#filter for VIP > 1
LvM_VIP_1 <- LvM_VIP_table %>% 
  filter(VIP >= 1)

#plot
LvM_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Larvae vs Metamorphosed Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/LarvaeMetamorphosed_VIP.pdf", width=6, height=11)
LvM_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Larvae vs Metamorphosed Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```

4. Larvae vs calcifying recruits  
```{r}

#assigning datasets 
X <- metabolites%>%
  filter(Development==c("Larvae","Calcifying Recruit"))%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:203] #pull only data columns

MyResult.plsda_LvC <- plsda(X,Y, ncomp=4)

#extract
LvC_VIP <- PLSDA.VIP(MyResult.plsda_LvC)
LvC_VIP_DF <- as.data.frame(LvC_VIP[["tab"]])

# Converting row names to column
LvC_VIP_table <- rownames_to_column(LvC_VIP_DF, var = "Metabolite")

#filter for VIP > 1
LvC_VIP_1 <- LvC_VIP_table %>% 
  filter(VIP >= 1)

#plot
LvC_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Larvae vs Calcifying Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/LarvaeCalcifying_VIP.pdf", width=6, height=11)
LvC_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Larvae vs Calcifying Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```

5. Metamorphosed vs calcifying recruits  

```{r}

#assigning datasets 
X <- metabolites%>%
  filter(Development==c("Metamorphosed Recruit","Calcifying Recruit"))%>%
  droplevels()%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names

X<-X[5:203] #pull only data columns

MyResult.plsda_MvC <- plsda(X,Y, ncomp=4)

#extract
MvC_VIP <- PLSDA.VIP(MyResult.plsda_MvC)
MvC_VIP_DF <- as.data.frame(MvC_VIP[["tab"]])

# Converting row names to column
MvC_VIP_table <- rownames_to_column(MvC_VIP_DF, var = "Metabolite")

#filter for VIP > 1
MvC_VIP_1 <- MvC_VIP_table %>% 
  filter(VIP >= 1)

#plot
MvC_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Metamorphosed vs Calcifying Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

pdf("Mcap2020/Figures/Metabolomics/MetamorphosedCalcifying_VIP.pdf", width=6, height=11)
MvC_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Metamorphosed vs Calcifying Recruits") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off()
```


# Validation of VIP by t-tests  

# Validation of PLS-DA 

## Timepoint  

Validate PLS-DA.   
```{r}
set.seed(30) 
MyPerf.plsda <- perf(MyResult.plsda_timepoint, validation = "Mfold", folds=8, #fold #? 
                     progressBar = TRUE, nrepeat = 50) # we suggest nrepeat = 50

#MyPerf.plsda <- perf(MyResult.plsda2, validation = "loo") #using Loo correction since the number of groups I have is low, once more samples are available I can try using the Mfold validation

plot(MyPerf.plsda,  sd = TRUE)
# optional setting for above: col = color.mixo(5:7)
#legend.position = "vertical"
```


## Development

Validate PLS-DA.   
```{r}
set.seed(30) 
MyPerf.plsda <- perf(MyResult.plsda_develop, validation = "Mfold", folds=4, #fold #? 
                     progressBar = TRUE, nrepeat = 50) # we suggest nrepeat = 50

#MyPerf.plsda <- perf(MyResult.plsda2, validation = "loo") #using Loo correction since the number of groups I have is low, once more samples are available I can try using the Mfold validation

plot(MyPerf.plsda,  sd = TRUE)
# optional setting for above: col = color.mixo(5:7)
#legend.position = "vertical"
```

NCOMP NOT WORKING BELOW THIS POINT, REEVALUATE: 
```{r}
# Assessing optimal number of variables to keep 
list.keepX <- c(5:10,  seq(20, 100, 10))
list.keepX # to output the grid of values tested

X <- metabolites%>%
  dplyr::select(Lifestage, Rep, HPF, Development, compound, log_norm_counts)%>%
  spread(compound, log_norm_counts) #generate spread data frame

Y <- as.factor(X$Development) #select treatment names
Y

X<-X[5:201] #pull only data columns

set.seed(30) # for reproducbility in this vignette, otherwise increase nrepeat
tune.splsda.srbct <- tune.splsda(X, Y, ncomp = 4, # we suggest to push ncomp a bit more, e.g. 4
                                 validation = 'Mfold', folds=4,
                                 measure = "BER", test.keepX = list.keepX)   # we suggest nrepeat = 50

error <- tune.splsda.srbct$error.rate
ncomp <- tune.splsda.srbct$choice.ncomp$ncomp # optimal number of components based on t-tests on the error rate
ncomp

select.keepX <- tune.splsda.srbct$choice.keepX# optimal number of variables to select
select.keepX

plot(tune.splsda.srbct, col = color.jet(ncomp))

```

# sPLS-DA from PLS-DA validation 

```{r}
#MyResult.splsda.final <- splsda(X, Y, ncomp = ncomp, keepX =select.keepX) - original use this once validation works 

MyResult.splsda.final <- splsda(X, Y, ncomp = 2, keepX = c(40,40)) #placeholder numbers for now until validation works

plotIndiv(MyResult.splsda.final, ind.names = FALSE, legend=TRUE,
          ellipse = TRUE, title="sPLS-DA - FINAL")

#selectVar(MyResult.splsda.final, comp=1)$value
#selectVar(MyResult.splsda.final, comp=2)$value

plotLoadings(MyResult.splsda.final, comp = 1, contrib = 'max', method = 'median')
plotLoadings(MyResult.splsda.final, comp = 2, contrib = 'max', method = 'median')

```

# sPLS-DA model validation  

```{r}
# Auroc plot of sPLS-DA
auc.splsda = auroc(MyResult.splsda.final, roc.comp = ncomp)

## Performance validation of final spls-da
perf.splsda <- perf(MyResult.splsda.final, validation = "loo", auc = TRUE) 

#Extracting Performance parameters
perf.splsda$auc
perf.splsda$error.rate
plot(perf.splsda) #Plotting Error rates

#Determining feature stability on each component 
par(mfrow=c(1,2))
plot(perf.splsda$features$stable[[1]], type = 'h', ylab = 'Stability', 
     xlab = 'Features', main = 'Comp 1', las =2)
plot(perf.splsda$features$stable[[2]], type = 'h', ylab = 'Stability', 
     xlab = 'Features', main = 'Comp 2', las =2)
#add more comps later on with more groups

```

# Extraction of significant loadings 

Select the stable features in each component. These are the values with the highest value from the comp plots above.    
```{r}
# here we match the selected variables to the stable features
ind.match1 = match(selectVar(MyResult.splsda.final, comp = 1)$name, 
                  names(perf.splsda$features$stable[[1]]))
ind.match2 = match(selectVar(MyResult.splsda.final, comp = 2)$name, 
                  names(perf.splsda$features$stable[[2]]))
#ind.match3 = match(selectVar(MyResult.splsda.final, comp = 3)$name, 
                  #names(perf.splsda$features$stable[[3]]))
#ind.match4 = match(selectVar(MyResult.splsda.final, comp = 4)$name, 
                  #names(perf.splsda$features$stable[[4]]))

#extract the frequency of selection of those selected variables
Freq1 = as.numeric(perf.splsda$features$stable[[1]][ind.match1])
Freq2 = as.numeric(perf.splsda$features$stable[[2]][ind.match2])
#Freq3 = as.numeric(perf.splsda$features$stable[[3]][ind.match3])
#Freq4 = as.numeric(perf.splsda$features$stable[[4]][ind.match4])

#Extracting the selected metabolites for each component 
comp1.select.metabolites <- data.frame(selectVar(MyResult.splsda.final, comp = 1)$value, Freq1)
comp2.select.metabolites <- data.frame(selectVar(MyResult.splsda.final, comp = 2)$value, Freq2)
#comp3.select.metabolites <- data.frame(selectVar(MyResult.splsda.final, comp = 3)$value, Freq3)
#comp4.select.metabolites <- data.frame(selectVar(MyResult.splsda.final, comp = 4)$value, Freq4)

head(comp1.select.metabolites)
head(comp2.select.metabolites)
#head(comp3.select.metabolites)
#head(comp4.select.metabolites)

```

Next add plots for determining metabolite features via Kevin Wong methods.  